<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-React/React-dva" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/12/React/React-dva/" class="article-date">
  <time class="dt-published" datetime="2019-12-12T02:50:48.000Z" itemprop="datePublished">2019-12-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/12/React/React-dva/">React dva总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、环境搭建"><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ npm install dva-cli -g</span><br><span class="line"></span><br><span class="line"># 创建应用</span><br><span class="line">$ dva new dva-quickstart</span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line">$ npm start</span><br></pre></td></tr></table></figure>

<blockquote>
<p>react项目的推荐目录结构（如果使用dva脚手架创建，则自动生成如下）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">|── /mock/             # 数据mock的接口文件  </span><br><span class="line">|── /src/              # 项目源码目录（我们开发的主要工作区域）   </span><br><span class="line">|   |── /components/   # 项目组件（用于路由组件内引用的可复用组件）   </span><br><span class="line">|   |── /routes/       # 路由组件（页面维度） </span><br><span class="line">|   |  |── route1.js  </span><br><span class="line">|   |  |── route2.js   # 根据router.js中的映射，在不同的url下，挂载不同的路由组件</span><br><span class="line">|   |  └── route3.js    </span><br><span class="line">|   |── /models/       # 数据模型（可以理解为store，用于存储数据与方法）  </span><br><span class="line">|   |  |── model1.js  </span><br><span class="line">|   |  |── model2.js   # 选择分离为多个model模型，是根据业务实体进行划分</span><br><span class="line">|   |  └── model3.js  </span><br><span class="line">|   |── /services/     # 数据接口（处理前台页面的ajax请求，转发到后台）   </span><br><span class="line">|   |── /utils/        # 工具函数（工具库，存储通用函数与配置参数）     </span><br><span class="line">|   |── router.js       # 路由配置（定义路由与对应的路由组件）  </span><br><span class="line">|   |── index.js       # 入口文件  </span><br><span class="line">|   |── index.less      </span><br><span class="line">|   └── index.html     </span><br><span class="line">|── package.json       # 项目信息  </span><br><span class="line">└── proxy.config.js    # 数据mock配置</span><br></pre></td></tr></table></figure>

<p><strong>使用 antd</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i babel-plugin-import --save</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>babel-plugin-import</code> 是用来按需加载 <code>antd</code> 的脚本和样式的</p>
</blockquote>
<ul>
<li>编辑 <code>.webpackrc</code>，使 <code>babel-plugin-import</code> 插件生效</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">+  &quot;extraBabelPlugins&quot;: [</span><br><span class="line">+    [&quot;import&quot;, &#123; &quot;libraryName&quot;: &quot;antd&quot;, &quot;libraryDirectory&quot;: &quot;es&quot;, &quot;style&quot;: &quot;css&quot; &#125;]</span><br><span class="line">+  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二、初识Dva"><a href="#二、初识Dva" class="headerlink" title="二、初识Dva"></a>二、初识Dva</h1><h2 id="2-1-Dva的特性"><a href="#2-1-Dva的特性" class="headerlink" title="2.1 Dva的特性"></a>2.1 Dva的特性</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dva = React-Router + Redux + Redux-saga</span><br></pre></td></tr></table></figure>

<ul>
<li>仅有 5 个<code>API</code>，仅有5个主要的<code>api</code></li>
<li>支持 <code>HMR</code>，支持模块的热更新</li>
<li>支持 <code>SSR (ServerSideRender)</code>，支持服务器端渲染</li>
<li>支持 <code>Mobile/ReactNative</code>，支持移动手机端的代码编写</li>
<li>支持<code>TypeScript</code></li>
<li>支持路由和 <code>Model</code> 的动态加载</li>
</ul>
<h2 id="2-2-Dva的五个API"><a href="#2-2-Dva的五个API" class="headerlink" title="2.2 Dva的五个API"></a>2.2 Dva的五个API</h2><p><img src="https://poetries1.gitee.io/img-repo/20191001/43.png" alt="img"></p>
<h3 id="2-2-1-app-x3D-dva-Opts"><a href="#2-2-1-app-x3D-dva-Opts" class="headerlink" title="2.2.1 app &#x3D; dva(Opts)"></a>2.2.1 app &#x3D; dva(Opts)</h3><blockquote>
<p><code>app = dva(Opts)</code>：创建应用，返回 <code>dva</code> 实例。(注：dva 支持多实例)**</p>
</blockquote>
<p>在<code>opts</code>可以配置所有的<code>hooks</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const app = dva(&#123;</span><br><span class="line">     history,</span><br><span class="line">     initialState,</span><br><span class="line">     onError,</span><br><span class="line">     onAction,</span><br><span class="line">     onStateChange,</span><br><span class="line">     onReducer,</span><br><span class="line">     onEffect,</span><br><span class="line">     onHmr,</span><br><span class="line">     extraReducers,</span><br><span class="line">     extraEnhancers,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>hooks包含如下配置项</p>
</blockquote>
<p>1、 <code>onError((err, dispatch) =&gt; &#123;&#125;)</code></p>
<ul>
<li><code>effect</code> 执行错误或 <code>subscription</code> 通过<code>done</code> 主动抛错时触发，可用于管理全局出错状态</li>
<li>注意：<code>subscription</code> 并没有加 <code>try...catch</code>，所以有错误时需通过第二个参数 <code>done</code> 主动抛错</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.model(&#123;</span><br><span class="line">  subscriptions: &#123;</span><br><span class="line">    setup(&#123; dispatch &#125;, done) &#123;</span><br><span class="line">      done(e)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>2、 <code>onAction(fn | fn[])</code></p>
<blockquote>
<p>在<code>action</code>被<code>dispatch</code>时触发，用于注册 <code>redux</code> 中间件。支持函数或函数数组格式</p>
</blockquote>
<ul>
<li>例如我们要通过 <code>redux-logger</code> 打印日志</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import createLogger from &#x27;redux-logger&#x27;;</span><br><span class="line">const app = dva(&#123;</span><br><span class="line">  onAction: createLogger(opts),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>3、 <code>onStateChange(fn)</code></p>
<blockquote>
<p><code>state</code> 改变时触发，可用于同步 state 到 <code>localStorage</code>，服务器端等</p>
</blockquote>
<p>4、 <code>onReducer(fn)</code></p>
<blockquote>
<p>封装 <code>reducer</code> 执行，比如借助 <code>redux-undo</code> 实现 <code>redo/undo</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import undoable from &#x27;redux-undo&#x27;;</span><br><span class="line">const app = dva(&#123;</span><br><span class="line">  onReducer: reducer =&gt; &#123;</span><br><span class="line">    return (state, action) =&gt; &#123;</span><br><span class="line">      const undoOpts = &#123;&#125;;</span><br><span class="line">      const newState = undoable(reducer, undoOpts)(state, action);</span><br><span class="line">      // 由于 dva 同步了 routing 数据，所以需要把这部分还原</span><br><span class="line">      return &#123; ...newState, routing: newState.present.routing &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>5、 <code>onEffect(fn)</code></p>
<blockquote>
<p>封装 <code>effect</code> 执行。比如 <code>dva-loading</code> 基于此实现了自动处理 <code>loading</code> 状态</p>
</blockquote>
<p>6、 <code>onHmr(fn)</code></p>
<blockquote>
<p>热替换相关，目前用于 <code>babel-plugin-dva-hmr</code></p>
</blockquote>
<p>7、 <code>extraReducers</code></p>
<blockquote>
<p>指定额外的 <code>reducer</code>，比如 <code>redux-form</code> 需要指定额外的 <code>form reducer</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reducer as formReducer &#125; from &#x27;redux-form&#x27;</span><br><span class="line">const app = dva(&#123;</span><br><span class="line">  extraReducers: &#123;</span><br><span class="line">    form: formReducer,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里比较常用的是，<code>history</code>的配置，一般默认的是<code>hashHistory</code>，如果要配置 <code>history</code>为 <code>browserHistory</code>，可以这样</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import createHistory from &#x27;history/createBrowserHistory&#x27;;</span><br><span class="line">const app = dva(&#123;</span><br><span class="line">  history: createHistory(),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initialState`：指定初始数据，优先级高于 `model` 中的 `state`，默认是 `&#123;&#125;`，但是基本上都在`modal`里面设置相应的`state</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="2-2-2-app-use-Hooks"><a href="#2-2-2-app-use-Hooks" class="headerlink" title="2.2.2 app.use(Hooks)"></a>2.2.2 app.use(Hooks)</h3><blockquote>
<p>app.use(Hooks)：配置 hooks 或者注册插件</p>
</blockquote>
<p>这里最常见的就是<code>dva-loading</code>插件的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import createLoading from &#x27;dva-loading&#x27;;</span><br><span class="line">...</span><br><span class="line">app.use(createLoading(opts));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>但是一般对于全局的<code>loading</code>我们会根据业务的不同来显示相应不同的<code>loading</code>图标，我们可以根据自己的需要来选择注册相应的插件</p>
</blockquote>
<h3 id="2-2-3-app-model-ModelObject"><a href="#2-2-3-app-model-ModelObject" class="headerlink" title="2.2.3 app.model(ModelObject)"></a>2.2.3 app.model(ModelObject)</h3><blockquote>
<p><code>app.model(ModelObject)</code>：这个是你数据逻辑处理，数据流动的地方</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/20191001/44.png" alt="img"></p>
<h3 id="2-2-4-app-unmodel-namespace"><a href="#2-2-4-app-unmodel-namespace" class="headerlink" title="2.2.4 app.unmodel(namespace)"></a>2.2.4 app.unmodel(namespace)</h3><blockquote>
<p>取消 <code>model</code> 注册，清理 <code>reducers</code>,<code>effects</code> 和 <code>subscriptions</code>。<code>subscription</code> 如果没有返回 <code>unlisten</code> 函数，使用 <code>app.unmodel</code> 会给予警告</p>
</blockquote>
<h3 id="2-2-5-app-router-Function"><a href="#2-2-5-app-router-Function" class="headerlink" title="2.2.5 app.router(Function)"></a>2.2.5 app.router(Function)</h3><blockquote>
<p>注册路由表，这一操作步骤在dva中也很重要</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 注册路由</span><br><span class="line">app.router(require(&#x27;./router&#x27;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 路由文件</span><br><span class="line">import &#123; Router, Route &#125; from &#x27;dva/router&#x27;;</span><br><span class="line">import IndexPage from &#x27;./routes/IndexPage&#x27;</span><br><span class="line">import TodoList from &#x27;./routes/TodoList&#x27;</span><br><span class="line"></span><br><span class="line">function RouterConfig(&#123; history &#125;) &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">        &lt;Route path=&quot;/&quot; component=&#123;IndexPage&#125; /&gt;</span><br><span class="line">        &lt;Route path=&#x27;/todoList&#x27; components=&#123;TodoList&#125;/&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line">export default RouterConfig</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果我们想解决组件动态加载问题，我们的路由文件也可以按照下面的写法来写</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Router, Switch, Route &#125; from &#x27;dva/router&#x27;</span><br><span class="line">import dynamic from &#x27;dva/dynamic&#x27;</span><br><span class="line"></span><br><span class="line">function RouterConfig(&#123; history, app &#125;) &#123;</span><br><span class="line">  const IndexPage = dynamic(&#123;</span><br><span class="line">    app,</span><br><span class="line">    component: () =&gt; import(&#x27;./routes/IndexPage&#x27;),</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const Users = dynamic(&#123;</span><br><span class="line">    app,</span><br><span class="line">    models: () =&gt; [import(&#x27;./models/users&#x27;)],</span><br><span class="line">    component: () =&gt; import(&#x27;./routes/Users&#x27;),</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;Switch&gt;</span><br><span class="line">        &lt;Route exact path=&quot;/&quot; component=&#123;IndexPage&#125; /&gt;</span><br><span class="line">        &lt;Route exact path=&quot;/users&quot; component=&#123;Users&#125; /&gt;</span><br><span class="line">      &lt;/Switch&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default RouterConfig</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中<code>dynamic(opts)</code> 中<code>opt</code>包含三个配置项：</p>
</blockquote>
<ul>
<li><code>app</code>: <code>dva</code> 实例，加载 <code>models</code> 时需要</li>
<li><code>models</code>: 返回 <code>Promise</code> 数组的函数，<code>Promise</code>返回 dva model&#96;</li>
<li><code>component</code>：返回 <code>Promise</code>的函数，<code>Promise</code>返回 <code>React Component</code></li>
</ul>
<h3 id="2-2-6-app-start"><a href="#2-2-6-app-start" class="headerlink" title="2.2.6 app.start"></a>2.2.6 app.start</h3><blockquote>
<p>启动应用，即将我们的应用跑起来</p>
</blockquote>
<h2 id="2-3-Dva九个概念"><a href="#2-3-Dva九个概念" class="headerlink" title="2.3 Dva九个概念"></a>2.3 Dva九个概念</h2><h3 id="2-3-1-State"><a href="#2-3-1-State" class="headerlink" title="2.3.1 State"></a>2.3.1 State</h3><blockquote>
<p>初始值，我们在 <code>dva()</code> 初始化的时候和在 modal 里面的 <code>state</code> 对其两处进行定义，其中 modal 中的优先级低于传给 <code>dva()</code> 的 <code>opts.initialState</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// dva()初始化</span><br><span class="line">const app = dva(&#123;</span><br><span class="line">  initialState: &#123; count: 1 &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// modal()定义事件</span><br><span class="line">app.model(&#123;</span><br><span class="line">  namespace: &#x27;count&#x27;,</span><br><span class="line">  state: 0,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-Action"><a href="#2-3-2-Action" class="headerlink" title="2.3.2 Action"></a>2.3.2 Action</h3><blockquote>
<p>表示操作事件，可以是同步，也可以是异步</p>
</blockquote>
<ul>
<li><code>action</code> 的格式如下，它需要有一个 <code>type</code>，表示这个 <code>action</code> 要触发什么操作；<code>payload</code> 则表示这个 <code>action</code> 将要传递的数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: String,</span><br><span class="line">  payload: data,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们通过 dispatch 方法来发送一个 action</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch(&#123; type: &#x27;todos/add&#x27;, payload: &#x27;Learn Dva&#x27; &#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其实我们可以构建一个Action 创建函数，如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function addTodo(text) &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    type: ADD_TODO,</span><br><span class="line">    text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//我们直接dispatch(addTodo()),就发送了一个action。</span><br><span class="line">dispatch(addTodo())</span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-Model"><a href="#2-3-3-Model" class="headerlink" title="2.3.3 Model"></a>2.3.3 Model</h3><blockquote>
<p><code>model</code> 是 <code>dva</code> 中最重要的概念，<code>Model</code> 非 <code>MVC</code> 中的 <code>M</code>，而是领域模型，用于把数据相关的逻辑聚合到一起，几乎所有的数据，逻辑都在这边进行处理分发</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">import queryString from &#x27;query-string&#x27;</span><br><span class="line">import * as todoService from &#x27;../services/todo&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  namespace: &#x27;todo&#x27;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    list: []</span><br><span class="line">  &#125;,</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    save(state, &#123; payload: &#123; list &#125; &#125;) &#123;</span><br><span class="line">      return &#123; ...state, list &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  effects: &#123;</span><br><span class="line">    *addTodo(&#123; payload: value &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      // 模拟网络请求</span><br><span class="line">      const data = yield call(todoService.query, value)</span><br><span class="line">      console.log(data)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      const tempObj = &#123;&#125;</span><br><span class="line">      tempObj.title = value</span><br><span class="line">      tempObj.id = list.length</span><br><span class="line">      tempObj.finished = false</span><br><span class="line">      list.push(tempObj)</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125;&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    *toggle(&#123; payload: index &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      // 模拟网络请求</span><br><span class="line">      const data = yield call(todoService.query, index)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      let obj = list[index]</span><br><span class="line">      obj.finished = !obj.finished</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125; &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    *delete(&#123; payload: index &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      const data = yield call(todoService.query, index)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      list.splice(index, 1)</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125; &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    *modify(&#123; payload: &#123; value, index &#125; &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      const data = yield call(todoService.query, value)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      let obj = list[index]</span><br><span class="line">      obj.title = value</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125; &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  subscriptions: &#123;</span><br><span class="line">    setup(&#123; dispatch, history &#125;) &#123;</span><br><span class="line">      // 监听路由的变化，请求页面数据</span><br><span class="line">      return history.listen((&#123; pathname, search &#125;) =&gt; &#123;</span><br><span class="line">        const query = queryString.parse(search)</span><br><span class="line">        let list = []</span><br><span class="line">        if (pathname === &#x27;todoList&#x27;) &#123;</span><br><span class="line">          dispatch(&#123; type: &#x27;save&#x27;, payload: &#123;list&#125; &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>model</code>对象中包含5个重要的属性</p>
</blockquote>
<p><strong>state</strong></p>
<blockquote>
<p>这里的 state 跟我们刚刚讲的 state 的概念是一样的，只不过她的优先级比初始化的低，但是基本上项目中的 state 都是在这里定义的</p>
</blockquote>
<p><strong>namespace</strong></p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model` 的命名空间，同时也是他在全局 `state` 上的属性，只能用字符串，我们发送在发送 `action` 到相应的 `reducer` 时，就会需要用到 `namespace</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>Reducer</strong></p>
<blockquote>
<p>以<code>key/value</code> 格式定义 <code>reducer</code>，用于处理同步操作，唯一可以修改 <code>state</code> 的地方。由 <code>action</code> 触发。其实一个纯函数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">namespace: &#x27;todo&#x27;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    list: []</span><br><span class="line">  &#125;,</span><br><span class="line">  // reducers 写法</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    save(state, &#123; payload: &#123; list &#125; &#125;) &#123;</span><br><span class="line">      return &#123; ...state, list &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Effect</strong></p>
<blockquote>
<p>用于处理异步操作和业务逻辑，不直接修改 <code>state</code>，简单的来说，就是获取从服务端获取数据，并且发起一个 <code>action</code>交给<code>reducer</code> 的地方</p>
</blockquote>
<p>其中它用到了<code>redux-saga</code>，里面有几个常用的函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// effects 写法</span><br><span class="line">effects: &#123;</span><br><span class="line">    *addTodo(&#123; payload: value &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      // 模拟网络请求</span><br><span class="line">      const data = yield call(todoService.query, value)</span><br><span class="line">      console.log(data)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      const tempObj = &#123;&#125;</span><br><span class="line">      tempObj.title = value</span><br><span class="line">      tempObj.id = list.length</span><br><span class="line">      tempObj.finished = false</span><br><span class="line">      list.push(tempObj)</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125;&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    *toggle(&#123; payload: index &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      // 模拟网络请求</span><br><span class="line">      const data = yield call(todoService.query, index)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      let obj = list[index]</span><br><span class="line">      obj.finished = !obj.finished</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125; &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    *delete(&#123; payload: index &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      const data = yield call(todoService.query, index)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      list.splice(index, 1)</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125; &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    *modify(&#123; payload: &#123; value, index &#125; &#125;, &#123; call, put, select &#125;) &#123;</span><br><span class="line">      const data = yield call(todoService.query, value)</span><br><span class="line">      let tempList = yield select(state =&gt; state.todo.list)</span><br><span class="line">      let list = []</span><br><span class="line">      list = list.concat(tempList)</span><br><span class="line">      let obj = list[index]</span><br><span class="line">      obj.title = value</span><br><span class="line">      yield put(&#123; type: &#x27;save&#x27;, payload: &#123; list &#125; &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1505342-9ecb8ba2d8fd3ec2.png" alt="img"></p>
<blockquote>
<p>在项目中最主要的会用到的是 <code>put</code> 与 <code>call</code></p>
</blockquote>
<p><strong>Subscription</strong></p>
<blockquote>
<ul>
<li>以 <code>key/value</code> 格式定义 <code>subscription</code>，<code>subscription</code> 是订阅，用于订阅一个数据源，然后根据需要 dispatch 相应的 action</li>
<li><code>subscription</code> 是订阅，用于订阅一个数据源，然后根据需要 <code>dispatch</code> 相应的<code>action</code>。在 <code>app.start()</code> 时被执行，数据源可以是当前的时间、当前页面的<code>url</code>、服务器的 <code>websocket</code> 连接、<code>history</code>路由变化等等。</li>
</ul>
</blockquote>
<ul>
<li><strong>注意</strong>：如果要使用 <code>app.unmodel()</code>，<code>subscription</code> 必须返回 <code>unlisten</code> 方法，用于取消数据订阅</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// subscriptions 写法</span><br><span class="line">subscriptions: &#123;</span><br><span class="line">    setup(&#123; dispatch, history &#125;) &#123;</span><br><span class="line">      // 监听路由的变化，请求页面数据</span><br><span class="line">      return history.listen((&#123; pathname, search &#125;) =&gt; &#123;</span><br><span class="line">        const query = queryString.parse(search)</span><br><span class="line">        let list = []</span><br><span class="line">        if (pathname === &#x27;todoList&#x27;) &#123;</span><br><span class="line">          dispatch(&#123; type: &#x27;save&#x27;, payload: &#123;list&#125; &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-4-Router"><a href="#2-3-4-Router" class="headerlink" title="2.3.4 Router"></a>2.3.4 Router</h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Router` 表示路由配置信息，项目中的 `router.js</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export default function(&#123; history &#125;)&#123;</span><br><span class="line">  return(</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;Route path=&quot;/&quot; component=&#123;App&#125; /&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>RouteComponent</strong></p>
<blockquote>
<p><code>RouteComponent</code> 表示<code>Router</code> 里匹配路径的 <code>Component</code>，通常会绑定<code>model</code>的数据。如下:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line"></span><br><span class="line">function App() &#123;</span><br><span class="line">  return &lt;div&gt;App&lt;/div&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mapStateToProps(state) &#123;</span><br><span class="line">  return &#123; todos: state.todos &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default connect(mapStateToProps)(App);</span><br></pre></td></tr></table></figure>

<h2 id="2-4-整体架构"><a href="#2-4-整体架构" class="headerlink" title="2.4 整体架构"></a>2.4 整体架构</h2><p><img src="https://poetries1.gitee.io/img-repo/20191001/45.png" alt="img"></p>
<ul>
<li>首先我们根据 <code>url</code> 访问相关的 <code>Route-Component</code>，在组件中我们通过 <code>dispatch</code>发送 <code>action</code> 到 <code>model</code>里面的 <code>effect</code> 或者直接 <code>Reducer</code></li>
<li>当我们将<code>action</code>发送给<code>Effect</code>，基本上是取服务器上面请求数据的，服务器返回数据之后，<code>effect</code> 会发送相应的 <code>action</code>给 <code>reducer</code>，由唯一能改变 <code>state</code>的 <code>reducer</code> 改变 <code>state</code> ，然后通过<code>connect</code>重新渲染组件。</li>
<li>当我们将<code>action</code>发送给<code>reducer</code>，那直接由 <code>reducer</code> 改变 <code>state</code>，然后通过<code>connect</code>重新渲染组件</li>
</ul>
<h2 id="2-5-Dva图解"><a href="#2-5-Dva图解" class="headerlink" title="2.5 Dva图解"></a>2.5 Dva图解</h2><p><strong>图解一：加入Saga</strong></p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">React` 只负责页面渲染, 而不负责页面逻辑, 页面逻辑可以从中单独抽取出来, 变成 `store</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/20191001/46.png" alt="img"></p>
<blockquote>
<p>使用 <code>Middleware</code> 拦截 <code>action</code>, 这样一来异步的网络操作也就很方便了, 做成一个 <code>Middleware</code>就行了, 这里使用<code>redux-saga</code> 这个类库</p>
</blockquote>
<ul>
<li>点击创建 <code>Todo</code>的按钮, 发起一个 <code>type == addTodo</code> 的 <code>action</code></li>
<li><code>saga</code> 拦截这个 <code>action</code>, 发起 <code>http</code> 请求, 如果请求成功, 则继续向 <code>reducer</code> 发一个 <code>type == addTodoSucc</code> 的 <code>action</code>, 提示创建成功, 反之则发送 <code>type == addTodoFail</code> 的<code>action</code> 即可</li>
</ul>
<p><strong>图解二：Dva表示法</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/20191001/47.png" alt="img"></p>
<blockquote>
<p>dva做了 3 件很重要的事情</p>
</blockquote>
<ul>
<li>把 <code>store</code>及 <code>saga</code> 统一为一个 <code>model</code> 的概念, 写在一个 js 文件里面</li>
<li>增加了一个 <code>Subscriptions</code>, 用于收集其他来源的 <code>action</code>, eg: 键盘操作</li>
<li><code>model</code> 写法很简约, 类似于 <code>DSL</code> 或者 <code>RoR</code></li>
</ul>
<h1 id="三、计数器例子"><a href="#三、计数器例子" class="headerlink" title="三、计数器例子"></a>三、计数器例子</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dva new myapp</span><br></pre></td></tr></table></figure>

<p><strong>目录结构介绍</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── mock    // mock数据文件夹</span><br><span class="line">├── node_modules // 第三方的依赖</span><br><span class="line">├── public  // 存放公共public文件的文件夹</span><br><span class="line">├── src  // 最重要的文件夹，编写代码都在这个文件夹下</span><br><span class="line">│   ├── assets // 可以放图片等公共资源</span><br><span class="line">│   ├── components // 就是react中的木偶组件</span><br><span class="line">│   ├── models // dva最重要的文件夹，所有的数据交互及逻辑都写在这里</span><br><span class="line">│   ├── routes // 就是react中的智能组件，不要被文件夹名字误导。</span><br><span class="line">│   ├── services // 放请求借口方法的文件夹</span><br><span class="line">│   ├── utils // 自己的工具方法可以放在这边</span><br><span class="line">│   ├── index.css // 入口文件样式</span><br><span class="line">│   ├── index.ejs // ejs模板引擎</span><br><span class="line">│   ├── index.js // 入口文件</span><br><span class="line">│   └── router.js // 项目的路由文件</span><br><span class="line">├── .eslintrc // bower安装目录的配置</span><br><span class="line">├── .editorconfig // 保证代码在不同编辑器可视化的工具</span><br><span class="line">├── .gitignore // git上传时忽略的文件</span><br><span class="line">├── .roadhogrc.js // 项目的配置文件，配置接口转发，css_module等都在这边。</span><br><span class="line">├── .roadhogrc.mock.js // 项目的配置文件</span><br><span class="line">└── package.json // 当前整一个项目的依赖</span><br></pre></td></tr></table></figure>

<p><strong>首先是前端的页面，我们使用 class 形式来创建组件，原例子中是使用无状态来创建的。react 创建组件的各种方式，大家可以看<a target="_blank" rel="noopener" href="http://www.cnblogs.com/wonyun/p/5930333.html">React创建组件的三种方式及其区别</a></strong></p>
<blockquote>
<p>我们先修改<code>route/IndexPage.js</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line">import styles from &#x27;./IndexPage.css&#x27;;</span><br><span class="line"></span><br><span class="line">class IndexPage extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; dispatch &#125; = this.props;</span><br><span class="line"></span><br><span class="line">    return (</span><br><span class="line">      &lt;div className=&#123;styles.normal&#125;&gt;</span><br><span class="line">        &lt;div className=&#123;styles.record&#125;&gt;Highest Record: 1&lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;styles.current&#125;&gt;2&lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;styles.button&#125;&gt;</span><br><span class="line">          &lt;button onClick=&#123;() =&gt; &#123;&#125;&#125;&gt;+&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default connect()(IndexPage);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同时修改样式<code>routes/IndexPage.css</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.normal &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  margin: 100px auto;</span><br><span class="line">  padding: 20px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  box-shadow: 0 0 20px #ccc;</span><br><span class="line">&#125;</span><br><span class="line">.record &#123;</span><br><span class="line">  border-bottom: 1px solid #ccc;</span><br><span class="line">  padding-bottom: 8px;</span><br><span class="line">  color: #ccc;</span><br><span class="line">&#125;</span><br><span class="line">.current &#123;</span><br><span class="line">  text-align: center;</span><br><span class="line">  font-size: 40px;</span><br><span class="line">  padding: 40px 0;</span><br><span class="line">&#125;</span><br><span class="line">.button &#123;</span><br><span class="line">  text-align: center;</span><br><span class="line">  button &#123;</span><br><span class="line">    width: 100px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    background: #aaa;</span><br><span class="line">    color: #fff;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 <code>model</code> 处理<code>state</code>，在页面里面输出 <code>model</code> 中的 <code>state</code></p>
</blockquote>
<ul>
<li>首先我们在index.js中将<code>models/example.js</code>，即将model下一行的的注释打开</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import dva from &#x27;dva&#x27;;</span><br><span class="line">import &#x27;./index.css&#x27;;</span><br><span class="line"></span><br><span class="line">// 1. Initialize</span><br><span class="line">const app = dva();</span><br><span class="line"></span><br><span class="line">// 2. Plugins</span><br><span class="line">// app.use(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">// 3. Model</span><br><span class="line">app.model(require(&#x27;./models/example&#x27;)); // 打开注释</span><br><span class="line"></span><br><span class="line">// 4. Router</span><br><span class="line">app.router(require(&#x27;./router&#x27;));</span><br><span class="line"></span><br><span class="line">// 5. Start</span><br><span class="line">app.start(&#x27;#root&#x27;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>接下来我们进入 <code>models/example.js</code>，将<code>namespace</code> 名字改为 <code>count</code>，<code>state</code>对象加上 <code>record</code> 与 <code>current</code> 属性。如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  namespace: &#x27;count&#x27;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    record: 0,</span><br><span class="line">    current: 0,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>接着我们来到 <code>routes/indexpage.js</code> 页面，通过的 <code>mapStateToProps</code>引入相关的 <code>state</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line">import styles from &#x27;./IndexPage.css&#x27;;</span><br><span class="line"></span><br><span class="line">class IndexPage extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; dispatch, count &#125; = this.props;</span><br><span class="line">    </span><br><span class="line">    return (</span><br><span class="line">      &lt;div className=&#123;styles.normal&#125;&gt;</span><br><span class="line">        &lt;div className=&#123;styles.record&#125;&gt;</span><br><span class="line">         Highest Record: &#123;count.record&#125; // 将count的record输出</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;styles.current&#125;&gt;</span><br><span class="line">         &#123;count.current&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;styles.button&#125;&gt;</span><br><span class="line">          &lt;button onClick=&#123;() =&gt; &#123;&#125; &#125; &gt;</span><br><span class="line">                 +</span><br><span class="line">          &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mapStateToProps(state) &#123;</span><br><span class="line">  return &#123; count: state.count &#125;;</span><br><span class="line">&#125; // 获取state</span><br><span class="line"></span><br><span class="line">export default connect(mapStateToProps)(IndexPage);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 <code>+</code> 发送 <code>action</code>，通过 <code>reducer</code> 改变相应的 <code>state</code></p>
</blockquote>
<ul>
<li>首先我们在 <code>models/example.js</code>，写相应的 <code>reducer</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  ...</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    add1(state) &#123;</span><br><span class="line">      const newCurrent = state.current + 1;</span><br><span class="line">      return &#123; ...state,</span><br><span class="line">        record: newCurrent &gt; state.record ? newCurrent : state.record,</span><br><span class="line">        current: newCurrent,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    minus(state) &#123;</span><br><span class="line">      return &#123; ...state, current: state.current - 1 &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在页面的模板 <code>routes/IndexPage.js</code> 中 <code>+</code> 号点击的时候，<code>dispatch</code>一个 <code>action</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line">import styles from &#x27;./IndexPage.css&#x27;;</span><br><span class="line"></span><br><span class="line">class IndexPage extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; dispatch, count &#125; = this.props;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div className=&#123;styles.normal&#125;&gt;</span><br><span class="line">        &lt;div className=&#123;styles.record&#125;&gt;Highest Record: &#123;count.record&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;styles.current&#125;&gt;&#123;count.current&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div className=&#123;styles.button&#125;&gt;</span><br><span class="line">          &lt;button </span><br><span class="line">+            onClick=&#123;() =&gt; &#123; dispatch(&#123; type: &#x27;count/add1&#x27; &#125;);&#125;</span><br><span class="line">          &#125;&gt;+&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function mapStateToProps(state) &#123;</span><br><span class="line">  return &#123; count: state.count &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default connect(mapStateToProps)(IndexPage);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>接下来我们来使用 <code>effect</code> 模拟一个数据接口请求，返回之后，通过 <code>yield put()</code> 改变相应的 <code>state</code></p>
</blockquote>
<ul>
<li>首先我们替换相应的 <code>models/example.js</code> 的 <code>effect</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">effects: &#123;</span><br><span class="line">    *add(action, &#123; call, put &#125;) &#123;</span><br><span class="line">      yield call(delay, 1000);</span><br><span class="line">      yield put(&#123; type: &#x27;minus&#x27; &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的 <code>delay</code>，是我这边写的一个延时的函数，我们在 <code>utils</code> 里面编写一个 <code>utils.js</code> ，一般请求接口的函数都会写在 <code>servers</code> 文件夹中</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export function delay(timeout) &#123;</span><br><span class="line">  return new Promise((resolve) =&gt; &#123;</span><br><span class="line">    setTimeout(resolve, timeout);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>订阅订阅键盘事件，使用 <code>subscriptions</code>，当用户按住 <code>command+up</code> 时候触发添加数字的 <code>action</code></p>
</blockquote>
<ul>
<li>在 <code>models/example.js</code> 中作如下修改</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+import key from &#x27;keymaster&#x27;;</span><br><span class="line">...</span><br><span class="line">app.model(&#123;</span><br><span class="line">  namespace: &#x27;count&#x27;,</span><br><span class="line">+ subscriptions: &#123;</span><br><span class="line">+   keyboardWatcher(&#123; dispatch &#125;) &#123;</span><br><span class="line">+     key(&#x27;⌘+up, ctrl+up&#x27;, () =&gt; &#123; dispatch(&#123;type:&#x27;add&#x27;&#125;) &#125;);</span><br><span class="line">+   &#125;,</span><br><span class="line">+ &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>在这里你需要安装 <code>keymaster</code> 这个依赖</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install keymaster --save</span><br></pre></td></tr></table></figure>

<ul>
<li>现在你可以按住 <code>command+up</code> 就可以使 <code>current</code> 加1</li>
</ul>
<h1 id="四、Dva实践"><a href="#四、Dva实践" class="headerlink" title="四、Dva实践"></a>四、Dva实践</h1><h2 id="4-1-抽离Model"><a href="#4-1-抽离Model" class="headerlink" title="4.1 抽离Model"></a>4.1 抽离Model</h2><blockquote>
<p>抽离<code>Model</code>，根据设计页面需求，设计相应的<code>Model</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// models/users.js</span><br><span class="line">// version1: 从数据维度抽取，更适用于无状态的数据</span><br><span class="line">// version2: 从业务状态抽取，将数据与组件的业务状态统一抽离成一个model</span><br><span class="line">// 新增部分为在数据维度基础上，改为从业务状态抽取而添加的代码</span><br><span class="line">export default &#123;</span><br><span class="line">  namespace: &#x27;users&#x27;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    list: [],</span><br><span class="line">    total: null,</span><br><span class="line">+   loading: false, // 控制加载状态</span><br><span class="line">+   current: null, // 当前分页信息</span><br><span class="line">+   currentItem: &#123;&#125;, // 当前操作的用户对象</span><br><span class="line">+   modalVisible: false, // 弹出窗的显示状态</span><br><span class="line">+   modalType: &#x27;create&#x27;, // 弹出窗的类型（添加用户，编辑用户）</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">    // 异步操作</span><br><span class="line">    effects: &#123;</span><br><span class="line">        *query()&#123;&#125;,</span><br><span class="line">        *create()&#123;&#125;,</span><br><span class="line">        *&#x27;delete&#x27;()&#123;&#125;,   // 因为delete是关键字，特殊处理</span><br><span class="line">        *update()&#123;&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // 替换状态树</span><br><span class="line">    reducers: &#123;</span><br><span class="line">+       showLoading()&#123;&#125;, // 控制加载状态的 reducer</span><br><span class="line">+       showModel()&#123;&#125;, // 控制 Model 显示状态的 reducer</span><br><span class="line">+       hideModel()&#123;&#125;,</span><br><span class="line">        querySuccess()&#123;&#125;,</span><br><span class="line">        createSuccess()&#123;&#125;,</span><br><span class="line">        deleteSuccess()&#123;&#125;,</span><br><span class="line">        updateSuccess()&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-设计组件"><a href="#4-2-设计组件" class="headerlink" title="4.2 设计组件"></a>4.2 设计组件</h2><blockquote>
<p>先设置容器组件的访问路径，再创建组件文件</p>
</blockquote>
<h3 id="4-2-1-容器组件"><a href="#4-2-1-容器组件" class="headerlink" title="4.2.1 容器组件"></a>4.2.1 容器组件</h3><blockquote>
<p>具有监听数据行为的组件，职责是绑定相关联的 model 数据，包含子组件；传入的数据来源于model</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; Component, PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">// dva 的 connect 方法可以将组件和数据关联在一起</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line"></span><br><span class="line">// 组件本身</span><br><span class="line">const MyComponent = (props)=&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">// propTypes属性，用于限制props的传入数据类型</span><br><span class="line">MyComponent.propTypes = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">// 声明模型传递函数，用于建立组件和数据的映射关系</span><br><span class="line">// 实际表示 将ModelA这一个数据模型，绑定到当前的组件中，则在当前组件中，随时可以取到ModelA的最新值</span><br><span class="line">// 可以绑定多个Model</span><br><span class="line">function mapStateToProps(&#123;ModelA&#125;) &#123;</span><br><span class="line">  return &#123;ModelA&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 关联 model</span><br><span class="line">// 正式调用模型传递函数，完成模型绑定</span><br><span class="line">export default connect(mapStateToProps)(MyComponent);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-展示组件"><a href="#4-2-2-展示组件" class="headerlink" title="4.2.2 展示组件"></a>4.2.2 展示组件</h3><blockquote>
<p>展示通过 <code>props</code> 传递到组件内部数据；传入的数据来源于容器组件向展示组件的<code>props</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; Component, PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">// 组件本身</span><br><span class="line">// 所需要的数据通过 Container Component 通过 props 传递下来</span><br><span class="line">const MyComponent = (props)=&gt;&#123;&#125;</span><br><span class="line">MyComponent.propTypes = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">// 并不会监听数据</span><br><span class="line">export default MyComponent;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-设置路由"><a href="#4-2-3-设置路由" class="headerlink" title="4.2.3 设置路由"></a>4.2.3 设置路由</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// .src/router.js</span><br><span class="line">import React, &#123; PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123; Router, Route &#125; from &#x27;dva/router&#x27;;</span><br><span class="line">import Users from &#x27;./routes/Users&#x27;;</span><br><span class="line"></span><br><span class="line">export default function(&#123; history &#125;) &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;Route path=&quot;/users&quot; component=&#123;Users&#125; /&gt;</span><br><span class="line">    &lt;/Router&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>容器组件雏形</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// .src/routes/Users.jsx</span><br><span class="line">import React, &#123; PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">function Users() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;User Router Component&lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Users;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-设计容器组件"><a href="#4-2-4-设计容器组件" class="headerlink" title="4.2.4 设计容器组件"></a>4.2.4 设计容器组件</h3><blockquote>
<p>自顶向下的设计方法：先设计容器组件，再逐步细化内部的展示容器</p>
</blockquote>
<p>组件的定义方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 方法一： es6 的写法，当组件设计react生命周期时，可采用这种写法</span><br><span class="line">// 具有生命周期的组件，可以在接收到传入数据变化时，自定义执行方法，有自己的行为模式</span><br><span class="line">// 比如在组件生成后调用xx请求(componentDidMount)、可以自己决定要不要更新渲染(shouldComponentUpdate)等</span><br><span class="line">class App extends React.Component(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">// 方法二： stateless 的写法，定义无状态组件</span><br><span class="line">// 无状态组件，仅仅根据传入的数据更新，修改自己的渲染内容</span><br><span class="line">const App = (props) =&gt; (&#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>容器组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// ./src/routes/Users.jsx</span><br><span class="line">import React, &#123; Component, PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入展示组件 （暂时都没实现）</span><br><span class="line">import UserList from &#x27;../components/Users/UserList&#x27;;</span><br><span class="line">import UserSearch from &#x27;../components/Users/UserSearch&#x27;;</span><br><span class="line">import UserModal from &#x27;../components/Users/UserModal&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入css样式表</span><br><span class="line">import styles from &#x27;./style.less&#x27;</span><br><span class="line"></span><br><span class="line">function Users() &#123;</span><br><span class="line"></span><br><span class="line">  // 向userListProps中传入静态数据</span><br><span class="line">  const userSearchProps = &#123;&#125;;</span><br><span class="line">  const userListProps = &#123;</span><br><span class="line">    total: 3,</span><br><span class="line">    current: 1,</span><br><span class="line">    loading: false,</span><br><span class="line">    dataSource: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;张三&#x27;,</span><br><span class="line">        age: 23,</span><br><span class="line">        address: &#x27;成都&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;李四&#x27;,</span><br><span class="line">        age: 24,</span><br><span class="line">        address: &#x27;杭州&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;王五&#x27;,</span><br><span class="line">        age: 25,</span><br><span class="line">        address: &#x27;上海&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line">  const userModalProps = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div className=&#123;styles.normal&#125;&gt;</span><br><span class="line">      &#123;/* 用户筛选搜索框 */&#125;</span><br><span class="line">      &lt;UserSearch &#123;...userSearchProps&#125; /&gt;</span><br><span class="line">      &#123;/* 用户信息展示列表 */&#125;</span><br><span class="line">      &lt;UserList &#123;...userListProps&#125; /&gt;</span><br><span class="line">      &#123;/* 添加用户 &amp; 修改用户弹出的浮层 */&#125;</span><br><span class="line">      &lt;UserModal &#123;...userModalProps&#125; /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 很关键的对外输出export；使外部可通过import引用使用此组件</span><br><span class="line">export default Users;</span><br></pre></td></tr></table></figure>

<p>展示组件UserList</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// ./src/components/Users/UserList.jsx</span><br><span class="line">import React, &#123; Component, PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">// 采用antd的UI组件</span><br><span class="line">import &#123; Table, message, Popconfirm &#125; from &#x27;antd&#x27;;</span><br><span class="line"></span><br><span class="line">// 采用 stateless 的写法</span><br><span class="line">const UserList = (&#123;</span><br><span class="line">    total,</span><br><span class="line">    current,</span><br><span class="line">    loading,</span><br><span class="line">    dataSource,</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">  const columns = [&#123;</span><br><span class="line">    title: &#x27;姓名&#x27;,</span><br><span class="line">    dataIndex: &#x27;name&#x27;,</span><br><span class="line">    key: &#x27;name&#x27;,</span><br><span class="line">    render: (text) =&gt; &lt;a href=&quot;#&quot;&gt;&#123;text&#125;&lt;/a&gt;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;年龄&#x27;,</span><br><span class="line">    dataIndex: &#x27;age&#x27;,</span><br><span class="line">    key: &#x27;age&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;住址&#x27;,</span><br><span class="line">    dataIndex: &#x27;address&#x27;,</span><br><span class="line">    key: &#x27;address&#x27;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: &#x27;操作&#x27;,</span><br><span class="line">    key: &#x27;operation&#x27;,</span><br><span class="line">    render: (text, record) =&gt; (</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        &lt;a onClick=&#123;()=&gt;&#123;&#125;&#125;&gt;编辑&lt;/a&gt;</span><br><span class="line">         </span><br><span class="line">        &lt;Popconfirm title=&quot;确定要删除吗？&quot; onConfirm=&#123;()=&gt;&#123;&#125;&#125;&gt;</span><br><span class="line">          &lt;a&gt;删除&lt;/a&gt;</span><br><span class="line">        &lt;/Popconfirm&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">    ),</span><br><span class="line">  &#125;];</span><br><span class="line"></span><br><span class="line">  // 定义分页对象</span><br><span class="line">  const pagination = &#123;</span><br><span class="line">    total,</span><br><span class="line">    current,</span><br><span class="line">    pageSize: 10,</span><br><span class="line">    onChange: ()=&gt;&#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // 此处的Table标签使用了antd组件，传入的参数格式是由antd组件库本身决定的</span><br><span class="line">  // 此外还需要在index.js中引入antd  import &#x27;antd/dist/antd.css&#x27;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Table</span><br><span class="line">        columns=&#123;columns&#125;</span><br><span class="line">        dataSource=&#123;dataSource&#125;</span><br><span class="line">        loading=&#123;loading&#125;</span><br><span class="line">        rowKey=&#123;record =&gt; record.id&#125;</span><br><span class="line">        pagination=&#123;pagination&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default UserList;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-添加Reducer"><a href="#4-3-添加Reducer" class="headerlink" title="4.3 添加Reducer"></a>4.3 添加Reducer</h2><blockquote>
<p>在整个应用中，只有<code>model</code>中的<code>reducer</code>函数可以直接修改自己所在<code>model</code>的<code>state</code>参数，其余都是非法操作；<br>并且必须使用<code>return &#123;...state&#125;</code>的形式进行修改</p>
</blockquote>
<h3 id="4-3-1-第一步：实现reducer函数"><a href="#4-3-1-第一步：实现reducer函数" class="headerlink" title="4.3.1 第一步：实现reducer函数"></a>4.3.1 第一步：实现reducer函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// models/users.js</span><br><span class="line">// 使用静态数据返回，把userList中的静态数据移到此处</span><br><span class="line">// querySuccess这个action的作用在于，修改了model的数据</span><br><span class="line">export default &#123;</span><br><span class="line">  namespace: &#x27;users&#x27;,</span><br><span class="line">  state： &#123;&#125;，</span><br><span class="line">  subscriptions: &#123;&#125;,</span><br><span class="line">  effects: &#123;&#125;,</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    querySuccess(state)&#123;</span><br><span class="line">        const mock = &#123;</span><br><span class="line">          total: 3,</span><br><span class="line">          current: 1,</span><br><span class="line">          loading: false,</span><br><span class="line">          list: [</span><br><span class="line">            &#123;</span><br><span class="line">              id: 1,</span><br><span class="line">              name: &#x27;张三&#x27;,</span><br><span class="line">              age: 23,</span><br><span class="line">              address: &#x27;成都&#x27;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              id: 2,</span><br><span class="line">              name: &#x27;李四&#x27;,</span><br><span class="line">              age: 24,</span><br><span class="line">              address: &#x27;杭州&#x27;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              id: 3,</span><br><span class="line">              name: &#x27;王五&#x27;,</span><br><span class="line">              age: 25,</span><br><span class="line">              address: &#x27;上海&#x27;,</span><br><span class="line">            &#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;;</span><br><span class="line">        // return 的内容是一个对象，涵盖原state中的所有属性，以实现“更新替换”的效果</span><br><span class="line">        return &#123;...state, ...mock, loading: false&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-第二步：关联Model中的数据源"><a href="#4-3-2-第二步：关联Model中的数据源" class="headerlink" title="4.3.2 第二步：关联Model中的数据源"></a>4.3.2 第二步：关联Model中的数据源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// routes/Users.jsx</span><br><span class="line"></span><br><span class="line">import React, &#123; PropTypes &#125; from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">// 最后用到了connect函数，需要在头部预先引入connect</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line"></span><br><span class="line">function Users(&#123; location, dispatch, users &#125;) &#123;</span><br><span class="line"></span><br><span class="line">  const &#123;</span><br><span class="line">    loading, list, total, current,</span><br><span class="line">    currentItem, modalVisible, modalType</span><br><span class="line">    &#125; = users;</span><br><span class="line"></span><br><span class="line">  const userSearchProps=&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  // 使用传入的数据源，进行数据渲染</span><br><span class="line">  const userListProps=&#123;</span><br><span class="line">    dataSource: list,</span><br><span class="line">    total,</span><br><span class="line">    loading,</span><br><span class="line">    current,</span><br><span class="line">  &#125;;</span><br><span class="line">  const userModalProps=&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div className=&#123;styles.normal&#125;&gt;</span><br><span class="line">      &#123;/* 用户筛选搜索框 */&#125;</span><br><span class="line">      &lt;UserSearch &#123;...userSearchProps&#125; /&gt;</span><br><span class="line">      &#123;/* 用户信息展示列表 */&#125;</span><br><span class="line">      &lt;UserList &#123;...userListProps&#125; /&gt;</span><br><span class="line">      &#123;/* 添加用户 &amp; 修改用户弹出的浮层 */&#125;</span><br><span class="line">      &lt;UserModal &#123;...userModalProps&#125; /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 声明组件的props类型</span><br><span class="line">Users.propTypes = &#123;</span><br><span class="line">  users: PropTypes.object,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 指定订阅数据，并且关联到users中</span><br><span class="line">function mapStateToProps(&#123; users &#125;) &#123;</span><br><span class="line">  return &#123;users&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 建立数据关联关系</span><br><span class="line">export default connect(mapStateToProps)(Users);</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-第三步：通过发起Action，在组件中获取Model中的数据"><a href="#4-3-3-第三步：通过发起Action，在组件中获取Model中的数据" class="headerlink" title="4.3.3 第三步：通过发起Action，在组件中获取Model中的数据"></a>4.3.3 第三步：通过发起Action，在组件中获取Model中的数据</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// models/users.js</span><br><span class="line">// 在组件生成后发出action，示例：</span><br><span class="line">componentDidMount() &#123;</span><br><span class="line">  this.props.dispatch(&#123;</span><br><span class="line">    type: &#x27;model/action&#x27;,     // type对应action的名字</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在本次实践中，在访问/users/路由时，就是我们获取用户数据的时机</span><br><span class="line">// 因此把dispatch移至subscription中</span><br><span class="line">// subcription，订阅(或是监听)一个数据源，然后根据条件dispatch对应的action</span><br><span class="line">// 数据源可以是当前的时间、服务器的 websocket 连接、keyboard 输入、geolocation 变化、history 路由变化等等  </span><br><span class="line">// 此处订阅的数据源就是路由信息，当路由为/users，则派发&#x27;querySuccess&#x27;这个effects方法</span><br><span class="line">subscriptions: &#123;</span><br><span class="line">    setup(&#123; dispatch, history &#125;) &#123;</span><br><span class="line">      history.listen(location =&gt; &#123;</span><br><span class="line">        if (location.pathname === &#x27;/users&#x27;) &#123;</span><br><span class="line">          dispatch(&#123;</span><br><span class="line">            type: &#x27;querySuccess&#x27;,</span><br><span class="line">            payload: &#123;&#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="4-3-4-第四步：-在index-js中添加models"><a href="#4-3-4-第四步：-在index-js中添加models" class="headerlink" title="4.3.4 第四步： 在index.js中添加models"></a>4.3.4 第四步： 在index.js中添加models</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// model必须在此完成注册，才能全局有效</span><br><span class="line">// index.js</span><br><span class="line">app.model(require(&#x27;./models/users.js&#x27;));</span><br></pre></td></tr></table></figure>

<h3 id="4-4-添加Effects"><a href="#4-4-添加Effects" class="headerlink" title="4.4 添加Effects"></a>4.4 添加Effects</h3><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Effects`的作用在于处理异步函数，控制数据流程。</span><br><span class="line">因为在真实场景中，数据都来自服务器，需要在发起异步请求获得返回值后再设置数据，更新`state`。</span><br><span class="line">因此我们往往在`Effects`中调用`reducer</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  namespace: &#x27;users&#x27;,</span><br><span class="line">  state： &#123;&#125;，</span><br><span class="line">  subscriptions: &#123;&#125;,</span><br><span class="line">  effects: &#123;</span><br><span class="line">    // 添加effects函数</span><br><span class="line">    // call与put是dva的函数</span><br><span class="line">    // call调用执行一个函数</span><br><span class="line">    // put则是dispatch执行一个action</span><br><span class="line">    // select用于访问其他model</span><br><span class="line">    *query(&#123; payload &#125;, &#123; select, call, put &#125;) &#123;</span><br><span class="line">        yield put(&#123; type: &#x27;showLoading&#x27; &#125;);</span><br><span class="line">        const &#123; data &#125; = yield call(query);</span><br><span class="line">        if (data) &#123;</span><br><span class="line">          yield put(&#123;</span><br><span class="line">            type: &#x27;querySuccess&#x27;,</span><br><span class="line">            payload: &#123;</span><br><span class="line">              list: data.data,</span><br><span class="line">              total: data.page.total,</span><br><span class="line">              current: data.page.current</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  reducers: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 添加请求处理   包含了一个ajax请求</span><br><span class="line">// models/users.js</span><br><span class="line">import request from &#x27;../utils/request&#x27;;</span><br><span class="line">import qs from &#x27;qs&#x27;;</span><br><span class="line">async function query(params) &#123;</span><br><span class="line">  return request(`/api/users?$&#123;qs.stringify(params)&#125;`);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-把请求处理分离到service中"><a href="#4-5-把请求处理分离到service中" class="headerlink" title="4.5 把请求处理分离到service中"></a>4.5 把请求处理分离到service中</h3><blockquote>
<p>用意在于分离(可复用的)ajax请求</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// services/users.js</span><br><span class="line">import request from &#x27;../utils/request&#x27;;</span><br><span class="line">import qs from &#x27;qs&#x27;;</span><br><span class="line">export async function query(params) &#123;</span><br><span class="line">  return request(`/api/users?$&#123;qs.stringify(params)&#125;`);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在models中引用</span><br><span class="line">// models/users.js</span><br><span class="line">import &#123;query&#125; from &#x27;../services/users&#x27;;</span><br></pre></td></tr></table></figure>

<h2 id="五、使用dva框架和直接使用redux写法的区别"><a href="#五、使用dva框架和直接使用redux写法的区别" class="headerlink" title="五、使用dva框架和直接使用redux写法的区别"></a>五、使用dva框架和直接使用redux写法的区别</h2><h3 id="5-1-使用-redux"><a href="#5-1-使用-redux" class="headerlink" title="5.1 使用 redux"></a>5.1 使用 redux</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">// action.js</span><br><span class="line"></span><br><span class="line">export const REQUEST_TODO = &#x27;REQUEST_TODO&#x27;;</span><br><span class="line">export const RESPONSE_TODO = &#x27;RESPONSE_TODO&#x27;;</span><br><span class="line"></span><br><span class="line">const request = count =&gt; (&#123;type: REQUEST_TODO, payload: &#123;loading: true, count&#125;&#125;);</span><br><span class="line"></span><br><span class="line">const response = count =&gt; (&#123;type: RESPONSE_TODO, payload: &#123;loading: false, count&#125;&#125;);</span><br><span class="line"></span><br><span class="line">export const fetch = count =&gt; &#123;</span><br><span class="line">  return (dispatch) =&gt; &#123;</span><br><span class="line">    dispatch(request(count));</span><br><span class="line"></span><br><span class="line">    return new Promise(resolve =&gt; &#123;</span><br><span class="line">      setTimeout(() =&gt; &#123;</span><br><span class="line">        resolve(count + 1);</span><br><span class="line">      &#125;, 1000)</span><br><span class="line">    &#125;).then(data =&gt; &#123;</span><br><span class="line">      dispatch(response(data))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//reducer.js</span><br><span class="line">import &#123; REQUEST_TODO, RESPONSE_TODO &#125; from &#x27;./actions&#x27;;</span><br><span class="line"></span><br><span class="line">export default (state = &#123;</span><br><span class="line">  loading: false,</span><br><span class="line">  count: 0</span><br><span class="line">&#125;, action) =&gt; &#123;</span><br><span class="line">  switch (action.type) &#123;</span><br><span class="line">    case REQUEST_TODO:</span><br><span class="line">      return &#123;...state, ...action.payload&#125;;</span><br><span class="line">    case RESPONSE_TODO:</span><br><span class="line">      return &#123;...state, ...action.payload&#125;;</span><br><span class="line">    default:</span><br><span class="line">      return state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// app.js</span><br><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line">import &#123; bindActionCreators &#125; from &#x27;redux&#x27;;</span><br><span class="line">import &#123; connect &#125; from &#x27;react-redux&#x27;;</span><br><span class="line"></span><br><span class="line">import * as actions from &#x27;./actions&#x27;;</span><br><span class="line"></span><br><span class="line">const App = (&#123;fetch, count, loading&#125;) =&gt; &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;loading ? &lt;div&gt;loading...&lt;/div&gt; : &lt;div&gt;&#123;count&#125;&lt;/div&gt;&#125;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; fetch(count)&#125;&gt;add&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mapStateToProps(state) &#123;</span><br><span class="line">  return state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mapDispatchToProps(dispatch) &#123;</span><br><span class="line">  return bindActionCreators(actions, dispatch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default connect(mapStateToProps, mapDispatchToProps)(App)</span><br><span class="line">//index.js</span><br><span class="line">import &#123; render &#125; from &#x27;react-dom&#x27;;</span><br><span class="line">import &#123; createStore, applyMiddleware &#125; from &#x27;redux&#x27;;</span><br><span class="line">import &#123; Provider &#125; from &#x27;react-redux&#x27;</span><br><span class="line">import thunkMiddleware from &#x27;redux-thunk&#x27;;</span><br><span class="line"></span><br><span class="line">import reducer from &#x27;./app/reducer&#x27;;</span><br><span class="line">import App from &#x27;./app/app&#x27;;</span><br><span class="line"></span><br><span class="line">const store = createStore(reducer, applyMiddleware(thunkMiddleware));</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App/&gt;</span><br><span class="line">  &lt;/Provider&gt;</span><br><span class="line">  ,</span><br><span class="line">  document.getElementById(&#x27;app&#x27;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-使用dva"><a href="#5-2-使用dva" class="headerlink" title="5.2 使用dva"></a>5.2 使用dva</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">// model.js</span><br><span class="line">export default &#123;</span><br><span class="line">  namespace: &#x27;demo&#x27;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    loading: false,</span><br><span class="line">    count: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    request(state, payload) &#123;</span><br><span class="line">      return &#123;...state, ...payload&#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    response(state, payload) &#123;</span><br><span class="line">      return &#123;...state, ...payload&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  effects: &#123;</span><br><span class="line">    *&#x27;fetch&#x27;(action, &#123;put, call&#125;) &#123;</span><br><span class="line">      yield put(&#123;type: &#x27;request&#x27;, loading: true&#125;);</span><br><span class="line"></span><br><span class="line">      let count = yield call((count) =&gt; &#123;</span><br><span class="line">        return new Promise(resolve =&gt; &#123;</span><br><span class="line">          setTimeout(() =&gt; &#123;</span><br><span class="line">            resolve(count + 1);</span><br><span class="line">          &#125;, 1000);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;, action.count);</span><br><span class="line"></span><br><span class="line">      yield put(&#123;</span><br><span class="line">        type: &#x27;response&#x27;,</span><br><span class="line">        loading: false,</span><br><span class="line">        count</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//app.js</span><br><span class="line"></span><br><span class="line">import React from &#x27;react&#x27;</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line"></span><br><span class="line">const App = (&#123;fetch, count, loading&#125;) =&gt; &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;loading ? &lt;div&gt;loading...&lt;/div&gt; : &lt;div&gt;&#123;count&#125;&lt;/div&gt;&#125;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; fetch(count)&#125;&gt;add&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mapStateToProps(state) &#123;</span><br><span class="line">  return state.demo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mapDispatchToProps(dispatch) &#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    fetch(count)&#123;</span><br><span class="line">      dispatch(&#123;type: &#x27;demo/fetch&#x27;, count&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default connect(mapStateToProps, mapDispatchToProps)(App)</span><br><span class="line">// index.js</span><br><span class="line">import dva from &#x27;dva&#x27;;</span><br><span class="line">import model from &#x27;./model&#x27;;</span><br><span class="line">import App from &#x27;./app&#x27;;</span><br><span class="line"></span><br><span class="line">const app = dva();</span><br><span class="line"></span><br><span class="line">app.use(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">app.model(model);</span><br><span class="line"></span><br><span class="line">app.router(() =&gt; &lt;App /&gt;);</span><br><span class="line"></span><br><span class="line">app.start();</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>redux</code> 需要拆分出<code>action</code>模块和<code>reducer</code>模块</li>
<li><code>dva</code>将<code>action</code>和<code>reducer</code>封装到<code>model</code>中，异步流程采用<code>Generator</code>处理</li>
</ul>
<h1 id="六、使用axios统一处理"><a href="#六、使用axios统一处理" class="headerlink" title="六、使用axios统一处理"></a>六、使用axios统一处理</h1><h2 id="6-1-示例代码"><a href="#6-1-示例代码" class="headerlink" title="6.1 示例代码"></a>6.1 示例代码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">// request.js</span><br><span class="line">import axios from &#x27;axios&#x27;;</span><br><span class="line">import NProgress from &#x27;nprogress&#x27;;</span><br><span class="line">import &#123; notification, message &#125; from &#x27;antd&#x27;;</span><br><span class="line">import &#123; routerRedux &#125; from &#x27;dva/router&#x27;;</span><br><span class="line">import store from &#x27;../index&#x27;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 一、功能：</span><br><span class="line"> * 1. 统一拦截http错误请求码；</span><br><span class="line"> * 2. 统一拦截业务错误代码；</span><br><span class="line"> * 3. 统一设置请求前缀</span><br><span class="line"> * |-- 每个 http 加前缀 baseURL = /api/v1，从配置文件中获取 apiPrefix</span><br><span class="line"> * 4. 配置异步请求过渡状态：显示蓝色加载条表示正在请求中，避免给用户页面假死的不好体验。</span><br><span class="line"> * |-- 使用 NProgress 工具库。</span><br><span class="line"> * </span><br><span class="line"> * 二、引包：</span><br><span class="line"> * |-- axios：http 请求工具库</span><br><span class="line"> * |-- NProgress：异步请求过度条，在浏览器主体部分顶部显示蓝色小条</span><br><span class="line"> * |-- notification：Antd组件 &gt; 处理错误响应码提示信息</span><br><span class="line"> * |-- routerRedux：dva/router对象，用于路由跳转，错误响应码跳转相应页面</span><br><span class="line"> * |-- store：dva中对象，使用里面的 dispatch 对象，用于触发路由跳转</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">// 设置全局参数，如响应超市时间，请求前缀等。</span><br><span class="line">axios.defaults.timeout = 5000</span><br><span class="line">axios.defaults.baseURL = &#x27;/api/v1&#x27;;</span><br><span class="line">axios.defaults.withCredentials = true;</span><br><span class="line"></span><br><span class="line">// 状态码错误信息</span><br><span class="line">const codeMessage = &#123;</span><br><span class="line">  200: &#x27;服务器成功返回请求的数据。&#x27;,</span><br><span class="line">  201: &#x27;新建或修改数据成功。&#x27;,</span><br><span class="line">  202: &#x27;一个请求已经进入后台排队（异步任务）。&#x27;,</span><br><span class="line">  204: &#x27;删除数据成功。&#x27;,</span><br><span class="line">  400: &#x27;发出的请求有错误，服务器没有进行新建或修改数据的操作。&#x27;,</span><br><span class="line">  401: &#x27;用户没有权限（令牌、用户名、密码错误）。&#x27;,</span><br><span class="line">  403: &#x27;用户得到授权，但是访问是被禁止的。&#x27;,</span><br><span class="line">  404: &#x27;发出的请求针对的是不存在的记录，服务器没有进行操作。&#x27;,</span><br><span class="line">  406: &#x27;请求的格式不可得。&#x27;,</span><br><span class="line">  410: &#x27;请求的资源被永久删除，且不会再得到的。&#x27;,</span><br><span class="line">  422: &#x27;当创建一个对象时，发生一个验证错误。&#x27;,</span><br><span class="line">  500: &#x27;服务器发生错误，请检查服务器。&#x27;,</span><br><span class="line">  502: &#x27;网关错误。&#x27;,</span><br><span class="line">  503: &#x27;服务不可用，服务器暂时过载或维护。&#x27;,</span><br><span class="line">  504: &#x27;网关超时。&#x27;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 添加一个请求拦截器，用于设置请求过渡状态</span><br><span class="line">axios.interceptors.request.use((config) =&gt; &#123;</span><br><span class="line">  // 请求开始，蓝色过渡滚动条开始出现</span><br><span class="line">  NProgress.start();</span><br><span class="line">  return config;</span><br><span class="line">&#125;, (error) =&gt; &#123;</span><br><span class="line">  return Promise.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 添加一个返回拦截器</span><br><span class="line">axios.interceptors.response.use((response) =&gt; &#123;</span><br><span class="line">  // 请求结束，蓝色过渡滚动条消失</span><br><span class="line">  NProgress.done();</span><br><span class="line">  return response;</span><br><span class="line">&#125;, (error) =&gt; &#123;</span><br><span class="line">  // 请求结束，蓝色过渡滚动条消失</span><br><span class="line">  // 即使出现异常，也要调用关闭方法，否则一直处于加载状态很奇怪</span><br><span class="line">  NProgress.done();</span><br><span class="line">  return Promise.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">export default function request (opt) &#123;</span><br><span class="line">  // 调用 axios api，统一拦截</span><br><span class="line">  return axios(opt)</span><br><span class="line">    .then((response) =&gt; </span><br><span class="line">      // &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 请求成功 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">      console.log(`【$&#123;opt.method&#125; $&#123;opt.url&#125;】请求成功，响应数据：%o`, response);</span><br><span class="line"></span><br><span class="line">      // 打印业务错误提示</span><br><span class="line">      if (response.data &amp;&amp; response.data.code != &#x27;0000&#x27;) &#123;</span><br><span class="line">        message.error(response.data.message);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return &#123; ...response.data &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch((error) =&gt; &#123;</span><br><span class="line">      // &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 请求失败 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">      // 请求配置发生的错误</span><br><span class="line">      if (!error.response) &#123;</span><br><span class="line">        return console.log(&#x27;Error&#x27;, error.message);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 响应时状态码处理 </span><br><span class="line">      const status = error.response.status;</span><br><span class="line">      const errortext = codeMessage[status] || error.response.statusText;</span><br><span class="line">      </span><br><span class="line">      notification.error(&#123;</span><br><span class="line">        message: `请求错误 $&#123;status&#125;`,</span><br><span class="line">        description: errortext,</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      // 存在请求，但是服务器的返回一个状态码，它们都在2xx之外</span><br><span class="line">      const &#123; dispatch &#125; = store;</span><br><span class="line"></span><br><span class="line">      if (status === 401) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/user/login&#x27;));</span><br><span class="line">      &#125; else if (status === 403) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/exception/403&#x27;));</span><br><span class="line">      &#125; else if (status &lt;= 504 &amp;&amp; status &gt;= 500) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/exception/500&#x27;));</span><br><span class="line">      &#125; else if (status &gt;= 404 &amp;&amp; status &lt; 422) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/exception/404&#x27;));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 开发时使用，上线时删除</span><br><span class="line">      console.log(`【$&#123;opt.method&#125; $&#123;opt.url&#125;】请求失败，响应数据：%o`, error.response);</span><br><span class="line"></span><br><span class="line">      return &#123; code: status, message: errortext &#125;; </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-2-明确响应体"><a href="#6-2-明确响应体" class="headerlink" title="6.2 明确响应体"></a>6.2 明确响应体</h2><blockquote>
<p>以微信小程序为例，请求响应数据分为两部分：</p>
</blockquote>
<ul>
<li>网络请求是否成功；</li>
<li>业务场景值。即便网络请求成功了，业务处理上可能有时也会出错，比如校验不通过</li>
</ul>
<p>我们在拦截响应时要分别对这两部分进行处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">response = &#123;</span><br><span class="line">  status: 200,                // 网络请求状态。</span><br><span class="line">  statusText: &#x27;xxx&#x27;,</span><br><span class="line">  data: &#123;</span><br><span class="line">    code: &#x27;1001&#x27;,             // 业务请求状态。这里 &#x27;0000&#x27; 表示业务没问题，其它都有问题</span><br><span class="line">    message: &#x27;yyy&#x27;,</span><br><span class="line">    data: &#123;  &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-3-依赖包分析"><a href="#6-3-依赖包分析" class="headerlink" title="6.3 依赖包分析"></a>6.3 依赖包分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import axios from &#x27;axios&#x27;;</span><br><span class="line">import NProgress from &#x27;nprogress&#x27;;</span><br><span class="line">import &#123; notification, message &#125; from &#x27;antd&#x27;;</span><br><span class="line">import &#123; routerRedux &#125; from &#x27;dva/router&#x27;;</span><br><span class="line">import store from &#x27;../index&#x27;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>import store from &#39;../index&#39;;</code>这是 <code>dva</code> 中导出的对象。即下面代码最终导出的 <code>app._store</code>，引入它是因为 <code>dispatch</code> 对象在里面，我们需要 dispatch 对象进行路由跳转</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// index.js</span><br><span class="line">import dva from &#x27;dva&#x27;;</span><br><span class="line">import &#123; message &#125; from &#x27;antd&#x27;;</span><br><span class="line">import &#123; createBrowserHistory as createHistory &#125; from &#x27;history&#x27;;</span><br><span class="line"></span><br><span class="line">// 1. Initialize</span><br><span class="line">const app = dva(&#123;</span><br><span class="line">  history: createHistory(),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 2. Plugins</span><br><span class="line">app.use(createLoading());</span><br><span class="line"></span><br><span class="line">// 3. Model</span><br><span class="line">app.model(require(&#x27;./models/app/global&#x27;).default);</span><br><span class="line"></span><br><span class="line">// 4. Router</span><br><span class="line">app.router(require(&#x27;./router&#x27;).default);</span><br><span class="line"></span><br><span class="line">// 5. Start</span><br><span class="line">app.start(&#x27;#root&#x27;);</span><br><span class="line"></span><br><span class="line">export default app._store;</span><br></pre></td></tr></table></figure>

<h2 id="6-4-axios-全局配置"><a href="#6-4-axios-全局配置" class="headerlink" title="6.4 axios 全局配置"></a>6.4 axios 全局配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 设置全局参数，如响应超市时间，请求前缀等。</span><br><span class="line">axios.defaults.timeout = 5000</span><br><span class="line">axios.defaults.baseURL = &#x27;/api/v1&#x27;;</span><br><span class="line">axios.defaults.withCredentials = true;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>axios 可以设置很多全局配置，具体可参阅 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008470355">https://segmentfault.com/a/1190000008470355</a></p>
</blockquote>
<h2 id="6-5-加载-NProgress-过渡组件"><a href="#6-5-加载-NProgress-过渡组件" class="headerlink" title="6.5 加载 NProgress 过渡组件"></a>6.5 加载 NProgress 过渡组件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/ 添加一个请求拦截器，用于设置请求过渡状态</span><br><span class="line">axios.interceptors.request.use((config) =&gt; &#123;</span><br><span class="line">  // 请求开始，蓝色过渡滚动条开始出现</span><br><span class="line">  NProgress.start();</span><br><span class="line">  return config;</span><br><span class="line">&#125;, (error) =&gt; &#123;</span><br><span class="line">  return Promise.reject(error);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 添加一个返回拦截器</span><br><span class="line">axios.interceptors.response.use((response) =&gt; &#123;</span><br><span class="line">  // 请求结束，蓝色过渡滚动条消失</span><br><span class="line">  NProgress.done();</span><br><span class="line">  return response;</span><br><span class="line">&#125;, (error) =&gt; &#123;</span><br><span class="line">  // 请求结束，蓝色过渡滚动条消失</span><br><span class="line">  // 即使出现异常，也要调用关闭方法，否则一直处于加载状态很奇怪</span><br><span class="line">  NProgress.done();</span><br><span class="line">  return Promise.reject(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>NProgress</code> 的使用主要有两个方法，当调用 <code>NProgress.start();</code> 时在浏览器顶部就会出现蓝色小条，当调用 <code>NProgress.done();</code> 蓝色小条就会消失。我们分别在请求开始和接收到响应调用这两个方法</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/6693922-948c3efcfeeaf4fd.gif" alt="img"></p>
<h2 id="6-6-网络请求成功处理"><a href="#6-6-网络请求成功处理" class="headerlink" title="6.6 网络请求成功处理"></a>6.6 网络请求成功处理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.then((response) =&gt; </span><br><span class="line">      // &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 请求成功 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">      console.log(`【$&#123;opt.method&#125; $&#123;opt.url&#125;】请求成功，响应数据：%o`, response);</span><br><span class="line"></span><br><span class="line">      // 打印业务错误提示</span><br><span class="line">      if (response.data &amp;&amp; response.data.code != &#x27;0000&#x27;) &#123;</span><br><span class="line">        message.error(response.data.message);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return &#123; ...response.data &#125;;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>网络请求状态码为 <code>200-300</code> 表示成功，此时还应该判断业务处理是否成功。这个根据具体项目具体规定，比如微信小程序有一套场景值。在实际项目中可以自行规定 <code>code = &#39;0000&#39;</code> 业务处理完全没问题，<code>code = &#39;1111&#39;</code>校验不通过，<code>code = &#39;2222&#39;</code> 数据库出错等等。</p>
</blockquote>
<ul>
<li>最后别忘了要返回具体对象 <code>&#123; ...response.data &#125;</code></li>
</ul>
<h2 id="6-7-网络请求失败处理"><a href="#6-7-网络请求失败处理" class="headerlink" title="6.7 网络请求失败处理"></a>6.7 网络请求失败处理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// 状态码错误信息</span><br><span class="line">const codeMessage = &#123;</span><br><span class="line">  200: &#x27;服务器成功返回请求的数据。&#x27;,</span><br><span class="line">  201: &#x27;新建或修改数据成功。&#x27;,</span><br><span class="line">  202: &#x27;一个请求已经进入后台排队（异步任务）。&#x27;,</span><br><span class="line">  204: &#x27;删除数据成功。&#x27;,</span><br><span class="line">  400: &#x27;发出的请求有错误，服务器没有进行新建或修改数据的操作。&#x27;,</span><br><span class="line">  401: &#x27;用户没有权限（令牌、用户名、密码错误）。&#x27;,</span><br><span class="line">  403: &#x27;用户得到授权，但是访问是被禁止的。&#x27;,</span><br><span class="line">  404: &#x27;发出的请求针对的是不存在的记录，服务器没有进行操作。&#x27;,</span><br><span class="line">  406: &#x27;请求的格式不可得。&#x27;,</span><br><span class="line">  410: &#x27;请求的资源被永久删除，且不会再得到的。&#x27;,</span><br><span class="line">  422: &#x27;当创建一个对象时，发生一个验证错误。&#x27;,</span><br><span class="line">  500: &#x27;服务器发生错误，请检查服务器。&#x27;,</span><br><span class="line">  502: &#x27;网关错误。&#x27;,</span><br><span class="line">  503: &#x27;服务不可用，服务器暂时过载或维护。&#x27;,</span><br><span class="line">  504: &#x27;网关超时。&#x27;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ...........</span><br><span class="line"></span><br><span class="line">.catch((error) =&gt; &#123;</span><br><span class="line">      // &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 请求失败 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">      // 请求配置发生的错误</span><br><span class="line">      if (!error.response) &#123;</span><br><span class="line">        return console.log(&#x27;Error&#x27;, error.message);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 响应时状态码处理 </span><br><span class="line">      const status = error.response.status;</span><br><span class="line">      const errortext = codeMessage[status] || error.response.statusText;</span><br><span class="line">      </span><br><span class="line">      notification.error(&#123;</span><br><span class="line">        message: `请求错误 $&#123;status&#125;`,</span><br><span class="line">        description: errortext,</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      // 存在请求，但是服务器的返回一个状态码，它们都在2xx之外</span><br><span class="line">      const &#123; dispatch &#125; = store;</span><br><span class="line"></span><br><span class="line">      if (status === 401) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/user/login&#x27;));</span><br><span class="line">      &#125; else if (status === 403) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/exception/403&#x27;));</span><br><span class="line">      &#125; else if (status &lt;= 504 &amp;&amp; status &gt;= 500) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/exception/500&#x27;));</span><br><span class="line">      &#125; else if (status &gt;= 404 &amp;&amp; status &lt; 422) &#123;</span><br><span class="line">        dispatch(routerRedux.push(&#x27;/exception/404&#x27;));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 开发时使用，上线时删除</span><br><span class="line">      console.log(`【$&#123;opt.method&#125; $&#123;opt.url&#125;】请求失败，响应数据：%o`, error.response);</span><br><span class="line"></span><br><span class="line">      return &#123; code: status, message: errortext &#125;; </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>网络请求失败，首先需要根据 <code>status</code> 打印提示消息，告诉用户为什么请求失败。如响应码为 <code>401</code>，那么提示用户的文字就会是 用户没有权限（令牌、用户名、密码错误）</li>
<li>如果是 <code>401</code> 错误，表示用户没有权限访问或者用户名密码输入错误，应该跳转到登录页面：<code>dispatch(routerRedux.push(&#39;/user/login&#39;));</code></li>
</ul>
<h1 id="七、更多参考"><a href="#七、更多参考" class="headerlink" title="七、更多参考"></a>七、更多参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dvajs/dva-docs/blob/master/v1/zh-cn/tutorial/01-%E6%A6%82%E8%A6%81.md">dva官方教程</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dvajs/dva/blob/master/README_zh-CN.md">官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dvajs/dva-knowledgemap">使用Dva的所有知识点</a></li>
<li><a target="_blank" rel="noopener" href="http://slides.com/sorrycc/dva#/">Dva-React 应用框架在蚂蚁金服的实践</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sorrycc/roadhog#%E9%85%8D%E7%BD%AE">roadhog介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/dkvirus/blog/1057996">创建一个 dva 脚手架工程</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/dkvirus/blog/1058203">dva 脚手架目录分析</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sorrycc/blog/issues/18">12 步 30 分钟，完成用户管理的 CURD 应用 (react+dva+antd)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c5ec9ffa29be">dva router4.0 使用实践总结</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7de59752b8a8">dva 2.0中如何使用代码进行路由跳转</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2e9e45e9a880">dva 配置 browserHistory 实践总结</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/61fe7a57fad4">dva-loading 实践用法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/649e97ff4354">dva 升级2.0版本遇到的问题小结</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e0a220906301">dva 中进行页面复用实践总结</a></li>
<li><a target="_blank" rel="noopener" href="https://dvajs.com/knowledgemap/#javascript-%E8%AF%AD%E8%A8%80">Dva知识地图</a></li>
<li><a target="_blank" rel="noopener" href="https://dvajs.com/api/">dva-API文档</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/12/12/React/React-dva/" data-id="cl7icg77300ruugunh6jw413i" data-title="React dva总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-React/React-03-组件协同(不)可控组件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/28/React/React-03-%E7%BB%84%E4%BB%B6%E5%8D%8F%E5%90%8C(%E4%B8%8D)%E5%8F%AF%E6%8E%A7%E7%BB%84%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2019-11-28T02:49:27.000Z" itemprop="datePublished">2019-11-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/28/React/React-03-%E7%BB%84%E4%BB%B6%E5%8D%8F%E5%90%8C(%E4%B8%8D)%E5%8F%AF%E6%8E%A7%E7%BB%84%E4%BB%B6/">React 组件协议(不)可控组件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、为什么要进行组件的协同"><a href="#一、为什么要进行组件的协同" class="headerlink" title="一、为什么要进行组件的协同"></a>一、为什么要进行组件的协同</h2><ul>
<li>我们在实际的开发项目的时候，不会只用几个组件，有时候遇到大型的项目，可能会有成千上百的组件，难免会遇到有功能重复的组件。要进行修改，就会修改大部分的文件。所以我们需要进行组件的协同开发。</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/451.png" alt="img"></p>
<h2 id="二、什么是组件的协同使用？"><a href="#二、什么是组件的协同使用？" class="headerlink" title="二、什么是组件的协同使用？"></a>二、什么是组件的协同使用？</h2><ul>
<li>组件的协同本质上是对组件的一种组织、管理的方式。</li>
<li>目的：<ul>
<li>逻辑清晰：这是组件与组件之间的逻辑</li>
<li>代码模块化</li>
<li>封装细节：像面向对象一样将常用的方法以及数据封装起来</li>
<li>提高代码的复用性：因为是组件，相当于一个封装好的东西，用的时候直接调用</li>
</ul>
</li>
</ul>
<h2 id="三、如何实现组件的协同使用"><a href="#三、如何实现组件的协同使用" class="headerlink" title="三、如何实现组件的协同使用"></a>三、如何实现组件的协同使用</h2><ul>
<li>第一种：增加一个父组件，将其他的组件进行嵌套，更多的是实现代码的封装</li>
<li>第二种：通过一些操作从后台获取数据，<code>React</code>中的<code>Mixin</code>，更多的是实现代码的复用</li>
</ul>
<h2 id="四、组件嵌套的含义"><a href="#四、组件嵌套的含义" class="headerlink" title="四、组件嵌套的含义"></a>四、组件嵌套的含义</h2><ul>
<li>组件嵌套的本质是父子关系</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/452.png" alt="img"></p>
<h2 id="五、组件嵌套的优缺点"><a href="#五、组件嵌套的优缺点" class="headerlink" title="五、组件嵌套的优缺点"></a>五、组件嵌套的优缺点</h2><ul>
<li>优点：<ul>
<li>逻辑清晰：父子关系类似于人类中的父子关系</li>
<li>模块化开发：每个模块对应一个功能，不同的模块可以同步开发</li>
<li>封装细节：开发者必须要关注组件的功能，不需要了解细节</li>
</ul>
</li>
<li>缺点：<ul>
<li>编写难度高：父子组件的关系需要经过深思熟虑，贸然编写可能导致关系混乱，代码难以维护</li>
<li>无法掌握所有细节：使用者只知道组件的用法，不知道实现细节，遇到问题难以修复</li>
</ul>
</li>
</ul>
<h2 id="六、Mixin"><a href="#六、Mixin" class="headerlink" title="六、Mixin"></a>六、Mixin</h2><p><strong>Mixin的含义</strong></p>
<ul>
<li><code>Mixin=一组方法</code>。</li>
<li>他的目的是横向抽离出组件的相似代码，把组件的共同作用以及效果的代码提出来</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/453.png" alt="img"></p>
<p><strong>Mixin的优缺点</strong></p>
<ul>
<li>优点<ul>
<li>代码复用：抽离出通用的代码，减少开发成本，提高开发效率</li>
<li>即插即用：可以使用许多现有的<code>Mixin</code>来开发自己的代码</li>
<li>适应性强：改动一次代码，影响多个组件</li>
</ul>
</li>
<li>缺点<ul>
<li>编写难度高：<code>Mixin</code>可能被用在各种环境中，想要兼容多种环境就需要更多的 - 码与逻辑，通用的代价是提高复杂度</li>
<li>降低代码的可读性：组件的优势在于将逻辑与是界面直接结合在一起，<code>Mixin</code>本质上会分散逻辑，理解起来难度大</li>
</ul>
</li>
</ul>
<h2 id="七、不可控组件"><a href="#七、不可控组件" class="headerlink" title="七、不可控组件"></a>七、不可控组件</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/454.png" alt="img"></p>
<ul>
<li>上图：<code>defaultValue</code>的值是固定的，这就是一个不可控组件</li>
<li>如果要获取<code>input</code>的<code>value</code>值，只有使用<code>ref</code>获取节点来获取值</li>
</ul>
<h2 id="八、可控组件"><a href="#八、可控组件" class="headerlink" title="八、可控组件"></a>八、可控组件</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/455.png" alt="img"></p>
<ul>
<li><code>defaultValue</code>的值是根据状态确定了，只需要拿到<code>this.state.value</code>的值就可以了</li>
<li>这里需要注意一下：使用<code>value</code>的值是不可修改的，<code>defaultValue</code>的值是可以修改的</li>
</ul>
<p><strong>可控组件的优点</strong></p>
<ul>
<li>符合<code>React</code>的数据流</li>
<li>数据存储在<code>state</code>中，便于获取</li>
<li>便于处理数据</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/28/React/React-03-%E7%BB%84%E4%BB%B6%E5%8D%8F%E5%90%8C(%E4%B8%8D)%E5%8F%AF%E6%8E%A7%E7%BB%84%E4%BB%B6/" data-id="cl7idql070000v8un4dih83wr" data-title="React 组件协议(不)可控组件" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-React/React-04-事件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/17/React/React-04-%E4%BA%8B%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2019-11-17T08:45:13.000Z" itemprop="datePublished">2019-11-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/17/React/React-04-%E4%BA%8B%E4%BB%B6/">React 事件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、编写事件处理函数"><a href="#一、编写事件处理函数" class="headerlink" title="一、编写事件处理函数"></a>一、编写事件处理函数</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/456.png" alt="img"></p>
<ul>
<li>在函数体中进行一些操作，常见的有：更新页面内容，更新组件状态，与后台交互</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/457.png" alt="img"></p>
<p><strong>书写方式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var Demo = React.createClass(&#123;</span><br><span class="line">		getInitialState:function()&#123;		&#125;,</span><br><span class="line">		handleClick: function(event)&#123;		&#125;,</span><br><span class="line">		handleChange: function()&#123;		&#125;,</span><br><span class="line">		render:function()&#123;		&#125;,</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码中有的有参数<code>event</code>，有的没有，这个根据自己的需求</li>
</ul>
<h2 id="二、绑定事件处理函数"><a href="#二、绑定事件处理函数" class="headerlink" title="二、绑定事件处理函数"></a>二、绑定事件处理函数</h2><ul>
<li><code>onClick=&#123;this,handleClick&#125;</code></li>
<li>需要注意的是：不要在事件后面添加上一个<code>（）</code></li>
</ul>
<p><strong>其他的事件</strong></p>
<ul>
<li>触摸事件：<code>onTouchCancel</code>，<code>onTouchEnd</code>，<code>onTouchMove</code>，<code>onTouchStart</code></li>
<li>键盘事件：<code>onKeyDown</code>，<code>onKeyUp</code>， <code>onKeyPress</code>（前两者的组合）</li>
<li>表单时间：<code>onChange</code>，<code>onInput</code>，<code>onSubmit</code></li>
<li>焦点事件：<code>onFocus</code>，<code>onBlur</code></li>
<li>UI元素事件：<code>onScroll</code></li>
<li>滚动事件：<code>onWhell</code>（鼠标滚动）</li>
<li>鼠标事件：<code>onClick</code>，<code>onContextMenu</code>，<code>onDoubleClick</code>……</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">var Demo = React.createClass(&#123;</span><br><span class="line">    handleClick:function(e)&#123;</span><br><span class="line">        console.log(e)</span><br><span class="line">        console.log(e.target)</span><br><span class="line">        console.log(e.nativeEvent)</span><br><span class="line">    &#125;,</span><br><span class="line">    render:function()&#123;</span><br><span class="line">        return &lt;div onClick=&#123;this.handleClick&#125;&gt;Hello World&lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">ReactDOM.render(&lt;Demo/&gt;,document.getElementById(&#x27;app&#x27;))</span><br><span class="line">var Demo = React.createClass(&#123;</span><br><span class="line">    getInitialState:function()&#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            width: 200,</span><br><span class="line">            height: 200,</span><br><span class="line">            backgroundColor: &#x27;#DDDDDD&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    /*handleWheel:function(e)&#123;</span><br><span class="line">        var newColor = (parseInt(this.state.backgroundColor.substr(1),16) + e.deltaY).toString(16)</span><br><span class="line">        newColor = &#x27;#&#x27; + newColor.toUpperCase()</span><br><span class="line">        console.log(newColor)</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">            backgroundColor:newColor</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,*/</span><br><span class="line">    randomColor:function()&#123;</span><br><span class="line">        var r = Math.floor(Math.random()*256);</span><br><span class="line">        var g = Math.floor(Math.random()*256);</span><br><span class="line">        var b = Math.floor(Math.random()*256);</span><br><span class="line">        return &#x27;rgb(&#x27;+r+&#x27;,&#x27;+g+&#x27;,&#x27;+b+&#x27;)&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleWheel:function()&#123;</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">            backgroundColor:this.randomColor()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    render:function()&#123;</span><br><span class="line">        return &lt;div onWheel=&#123;this.handleWheel&#125; style=&#123;this.state&#125;&gt;这是一个案例，鼠标滚动实现背景颜色的变化&lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">ReactDOM.render(&lt;Demo/&gt;,document.getElementById(&#x27;app&#x27;))</span><br></pre></td></tr></table></figure>

<h2 id="三、事件对象"><a href="#三、事件对象" class="headerlink" title="三、事件对象"></a>三、事件对象</h2><p><strong>事件对象的使用</strong></p>
<ul>
<li>通用：所有的事件都有事件属性</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/458.png" alt="img"></p>
<ul>
<li>键盘：键盘事件拥有的事件属性</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/459.png" alt="img"></p>
<ul>
<li>鼠标：鼠标事件拥有的事件属性</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/460.png" alt="img"></p>
<ul>
<li>滚动：滚动事件拥有的事件属性<ul>
<li>为什么会有三个，因为有的设备可以实现三个方向的移动</li>
</ul>
</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/461.png" alt="img"></p>
<h2 id="四、事件与状态关联"><a href="#四、事件与状态关联" class="headerlink" title="四、事件与状态关联"></a>四、事件与状态关联</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">inputChange:function(event)&#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">    	inputText:event.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>总的来说就是使用<code>this.setState</code>来更新状态，而状态的值因为事件的不同会不同</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/17/React/React-04-%E4%BA%8B%E4%BB%B6/" data-id="cl7icg6vo00p9ugun3j2gb4tp" data-title="React 事件" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-React/Redux-action+store+reducer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/30/React/Redux-action+store+reducer/" class="article-date">
  <time class="dt-published" datetime="2019-10-30T07:28:17.000Z" itemprop="datePublished">2019-10-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/30/React/Redux-action+store+reducer/">Redux action+store+reducer</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>redux的核心概念就是store、action、reducer，从调用关系来看如下所示</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(action) --&gt; reducer(state, action) --&gt; final state</span><br><span class="line">// reducer方法, 传入的参数有两个</span><br><span class="line">// state: 当前的state</span><br><span class="line">// action: 当前触发的行为, &#123;type: &#x27;xx&#x27;&#125;</span><br><span class="line">// 返回值: 新的state</span><br><span class="line">var reducer = function(state, action)&#123;</span><br><span class="line">    switch (action.type) &#123;</span><br><span class="line">        case &#x27;add_todo&#x27;:</span><br><span class="line">            return state.concat(action.text);</span><br><span class="line">        default:</span><br><span class="line">            return state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 创建store, 传入两个参数</span><br><span class="line">// 参数1: reducer 用来修改state</span><br><span class="line">// 参数2(可选): [], 默认的state值,如果不传, 则为undefined</span><br><span class="line">var store = redux.createStore(reducer, []);</span><br><span class="line"></span><br><span class="line">// 通过 store.getState() 可以获取当前store的状态(state)</span><br><span class="line">// 默认的值是 createStore 传入的第二个参数</span><br><span class="line">console.log(&#x27;state is: &#x27; + store.getState());  // state is:</span><br><span class="line"></span><br><span class="line">// 通过 store.dispatch(action) 来达到修改 state 的目的</span><br><span class="line">// 注意: 在redux里,唯一能够修改state的方法,就是通过 store.dispatch(action)</span><br><span class="line">store.dispatch(&#123;type: &#x27;add_todo&#x27;, text: &#x27;读书&#x27;&#125;);</span><br><span class="line">// 打印出修改后的state</span><br><span class="line">console.log(&#x27;state is: &#x27; + store.getState());  // state is: 读书</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;type: &#x27;add_todo&#x27;, text: &#x27;写作&#x27;&#125;);</span><br><span class="line">console.log(&#x27;state is: &#x27; + store.getState());  // state is: 读书,写作</span><br></pre></td></tr></table></figure>

<h2 id="一、store、reducer、action关联"><a href="#一、store、reducer、action关联" class="headerlink" title="一、store、reducer、action关联"></a>一、store、reducer、action关联</h2><p><strong>store</strong></p>
<ul>
<li><code>store</code>在这里代表的是数据模型，内部维护了一个<code>state</code>变量</li>
<li><code>store</code>有两个核心方法，分别是<code>getState</code>、<code>dispatch</code>。前者用来获取<code>store</code>的状态（<code>state</code>），后者用来修改<code>store</code>的状态</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 创建store, 传入两个参数</span><br><span class="line">// 参数1: reducer 用来修改state</span><br><span class="line">// 参数2(可选): [], 默认的state值,如果不传, 则为undefined</span><br><span class="line">var store = redux.createStore(reducer, []);</span><br><span class="line"></span><br><span class="line">// 通过 store.getState() 可以获取当前store的状态(state)</span><br><span class="line">// 默认的值是 createStore 传入的第二个参数</span><br><span class="line">console.log(&#x27;state is: &#x27; + store.getState());  // state is:</span><br><span class="line"></span><br><span class="line">// 通过 store.dispatch(action) 来达到修改 state 的目的</span><br><span class="line">// 注意: 在redux里,唯一能够修改state的方法,就是通过 store.dispatch(action)</span><br><span class="line">store.dispatch(&#123;type: &#x27;add_todo&#x27;, text: &#x27;读书&#x27;&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>action</strong></p>
<ul>
<li>对行为（如用户行为）的抽象，在<code>redux</code>里是一个普通的<code>js</code>对象</li>
<li><code>action</code>必须有一个<code>type</code>字段来标识这个行为的类型</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;type:&#x27;add_todo&#x27;, text:&#x27;读书&#x27;&#125;</span><br><span class="line">&#123;type:&#x27;add_todo&#x27;, text:&#x27;写作&#x27;&#125;</span><br><span class="line">&#123;type:&#x27;add_todo&#x27;, text:&#x27;睡觉&#x27;, time:&#x27;晚上&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>reducer</strong></p>
<ul>
<li>一个普通的函数，用来修改<code>store</code>的状态。传入两个参数 <code>state</code>、<code>action</code></li>
<li>其中，<code>state</code>为当前的状态（可通过<code>store.getState()</code>获得），而<code>action</code>为当前触发的行为（通过<code>store.dispatch(action)</code>调用触发）</li>
<li><code>reducer(state, action)</code> 返回的值，就是<code>store</code>最新的<code>state</code>值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// reducer方法, 传入的参数有两个</span><br><span class="line">// state: 当前的state</span><br><span class="line">// action: 当前触发的行为, &#123;type: &#x27;xx&#x27;&#125;</span><br><span class="line">// 返回值: 新的state</span><br><span class="line">var reducer = function(state, action)&#123;</span><br><span class="line">    switch (action.type) &#123;</span><br><span class="line">        case &#x27;add_todo&#x27;:</span><br><span class="line">            return state.concat(action.text);</span><br><span class="line">        default:</span><br><span class="line">            return state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="二、关于actionCreator"><a href="#二、关于actionCreator" class="headerlink" title="二、关于actionCreator"></a>二、关于actionCreator</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">actionCreator(args) =&gt; action</span><br><span class="line">var addTodo = function(text)&#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        type: &#x27;add_todo&#x27;,</span><br><span class="line">        text: text</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">addTodo(&#x27;睡觉&#x27;);  // 返回：&#123;type: &#x27;add_todo&#x27;, text: &#x27;睡觉&#x27;&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/30/React/Redux-action+store+reducer/" data-id="cl7icg76r00r7ugun5elu060i" data-title="Redux action+store+reducer" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redux/" rel="tag">Redux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-React/React-02-jsx与非DOM" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/26/React/React-02-jsx%E4%B8%8E%E9%9D%9EDOM/" class="article-date">
  <time class="dt-published" datetime="2019-10-26T05:18:54.000Z" itemprop="datePublished">2019-10-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/26/React/React-02-jsx%E4%B8%8E%E9%9D%9EDOM/">React-jsx与非DOM</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、JSX是什么"><a href="#一、JSX是什么" class="headerlink" title="一、JSX是什么"></a>一、JSX是什么</h2><ul>
<li>一个语法或者说是语法糖</li>
<li>基于<code>ECMAScript</code>一种新的特性</li>
<li>一种定义带属性（<code>DOM</code>节点）树结构（<code>DOM</code>结构）的语法</li>
</ul>
<p><strong>JSX不是</strong></p>
<ul>
<li>一门新的语言</li>
<li><code>XML</code>或者<code>HTML</code></li>
<li>一种限制，可以不使用<code>JSX</code></li>
</ul>
<h2 id="二、JSX的特点"><a href="#二、JSX的特点" class="headerlink" title="二、JSX的特点"></a>二、JSX的特点</h2><ul>
<li>类<code>XML</code>语法，易于接受</li>
<li>增强<code>JS</code>语义，在<code>js</code>中编辑<code>HTML</code></li>
<li>结构清晰</li>
<li>抽象程度高（核心）：避免手<code>动DOM</code>操作，跨平台</li>
<li>代码模块化</li>
</ul>
<h2 id="三、JSX语法"><a href="#三、JSX语法" class="headerlink" title="三、JSX语法"></a>三、JSX语法</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/463.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    JSX（javaScriptXML）语法入门：</span><br><span class="line">        1、不是一门语言，是一个语法或者说是语法糖</span><br><span class="line">        2、JSX标签其实就是HTML标签，只不过在javascript中这些标签的时候，</span><br><span class="line">            不使用“”,遇到HTML标签（以&lt;开始），就用HTML规则解析，遇到代码块</span><br><span class="line">            （以&#123;开始），就用javascript规则解析</span><br><span class="line">        3、JSX语法浏览器无法解析，需要使用插件将其转化为js代码</span><br><span class="line">        4、代码更加直观</span><br><span class="line">*/</span><br><span class="line">/*</span><br><span class="line">    1、首字母必须大写</span><br><span class="line">    2、驼峰命名</span><br><span class="line">    3、使用className与htmlFor代替class和for</span><br><span class="line">    4、组件与组件之间是可以嵌套的</span><br><span class="line">    5、在JSX语法中只能使用求值表达式，不能使用语句</span><br><span class="line">    6、只有一个顶层标签</span><br><span class="line">*/</span><br><span class="line">var Demo = React.createClass(&#123;</span><br><span class="line">    change:function ()&#123;</span><br><span class="line">        return &#x27;demo&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleClick:function()&#123;</span><br><span class="line">        alert(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    render: function()&#123;</span><br><span class="line">        // this指向整个（当前的组件）组件</span><br><span class="line">        return &lt;div className=&quot;demo&quot; onClick=&#123;this.handleClick&#125;&gt;这是一个&#123;this.change()&#125;&lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">// console.log(Demo)</span><br><span class="line">ReactDOM.render(&lt;Demo /&gt;,document.getElementById(&#x27;app&#x27;))</span><br></pre></td></tr></table></figure>

<h2 id="四、JSX的注释"><a href="#四、JSX的注释" class="headerlink" title="四、JSX的注释"></a>四、JSX的注释</h2><ul>
<li>在<code>JSX</code>语法中，添加注释需要写在 <code>&#123; &#125;</code> 中</li>
<li>可以使用多行注释与单行注释</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var HelloWorld = React.createClass(&#123;</span><br><span class="line">    render:function()&#123;</span><br><span class="line">        // 现在这里是属于js的部分,不属于JSX语法的部分</span><br><span class="line">        return (</span><br><span class="line">            &lt;div className=&quot;box&quot; // class名字</span><br><span class="line">            &gt;</span><br><span class="line">                &#123;/*这是一个标题*/&#125;</span><br><span class="line">                &lt;h1 className=&quot;title&quot;&gt;Hello World&lt;/h1&gt;</span><br><span class="line">                &#123;/*这是说明*/&#125;</span><br><span class="line">                &lt;p&gt;你好世界！&lt;/p&gt;</span><br><span class="line">                &lt;div className=&quot;box2&quot;&gt;你好&lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">ReactDOM.render(&lt;HelloWorld/&gt;,document.getElementById(&quot;app&quot;))</span><br></pre></td></tr></table></figure>

<h2 id="五、JSX中使用样式"><a href="#五、JSX中使用样式" class="headerlink" title="五、JSX中使用样式"></a>五、JSX中使用样式</h2><ul>
<li>内联样式</li>
<li>对象样式</li>
<li>选择器样式（<code>CSS</code>样式）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">组件的样式:</span><br><span class="line">    1、行内样式：写行内样式的时候需要使用两个&#123;&#125;  ==&gt;&#123;&#123;&#125;&#125;</span><br><span class="line">    2、对象样式：在return前面定义一个样式对象，注意样式的写法，与HTML的不同点</span><br><span class="line">    3、CSS样式</span><br><span class="line"></span><br><span class="line">注意事项，在HTML5中与在React中的样式的书写区别：</span><br><span class="line">    1、HTML5中以;结束</span><br><span class="line">        在React中以,结束</span><br><span class="line">    2、在HTML5中属性与值都不需要加上引号</span><br><span class="line">        在React中，属于javascript对象，key中不能存在 - ,</span><br><span class="line">        需要使用驼峰命名，如果是value值，需要加上引号</span><br><span class="line">    3、在HTML中，设置带数字的值，宽度，高度==，需要带上单位</span><br><span class="line">        在React中可以不用带单位，直接写数字</span><br><span class="line">        这里是指那些规定了默认单位的值。比如说像素px，如果要使用em或者是rem则需要加上单位</span><br><span class="line">*/</span><br><span class="line">/*</span><br><span class="line">&#123;&#125; 插值符号</span><br><span class="line">在使用插值符号的是有，里面需要时一个对象或者是一个表达式</span><br><span class="line">*/</span><br><span class="line">var HelloWorld = React.createClass(&#123;</span><br><span class="line">render:function()&#123;</span><br><span class="line">    var styles = &#123;</span><br><span class="line">        color: &#x27;blue&#x27;,</span><br><span class="line">        fontSize: &#x27;30&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    return (</span><br><span class="line">        &lt;div className=&quot;box&quot;&gt;</span><br><span class="line">            &lt;h3 className=&quot;title&quot; style=&#123;&#123;color:&#x27;red&#x27;,backgroundColor:&#x27;lime&#x27;&#125;&#125;&gt;默认标题&lt;/h3&gt;</span><br><span class="line">            &lt;p className=&quot;subtitle&quot; style=&#123;styles&#125;&gt;说明&lt;/p&gt;</span><br><span class="line">            &lt;p className=&quot;details&quot;&gt;这个是用来教学的案例&lt;/p&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">ReactDOM.render(&lt;HelloWorld/&gt;,document.getElementById(&quot;app&quot;))</span><br></pre></td></tr></table></figure>

<h2 id="六、条件判断的四种写法"><a href="#六、条件判断的四种写法" class="headerlink" title="六、条件判断的四种写法"></a>六、条件判断的四种写法</h2><ul>
<li>三元表达式 ? :</li>
<li>使用变量，通过函数使用条件判断语句，返回一个字符串</li>
<li>直接在<code>&#123;&#125;</code>中调用函数</li>
<li>使用比较运算符 <code>&amp;&amp;</code> <code>||</code>！&#96;</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">1、三元表达式		?	:</span><br><span class="line">2、使用变量，通过函数使用条件判断语句，返回一个字符串</span><br><span class="line">3、直接在&#123;&#125;中调用函数</span><br><span class="line">4、使用比较运算符	&amp;&amp;   ||  ！</span><br><span class="line">*/</span><br><span class="line">var Demo = React.createClass(&#123;</span><br><span class="line">    // 设置初始的状态</span><br><span class="line">    getInitialState:function()&#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            onOff:true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 自定义一个点击事件</span><br><span class="line">    handleClick:function() &#123;</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">            onOff:!this.state.onOff</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    render:function()&#123;</span><br><span class="line">        return &lt;div className=&#123;this.state.onOff?&quot;box2&quot;:&quot;box1&quot;&#125; onClick=&#123;this.handleClick&#125;&gt;我是一个盒子&lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">ReactDOM.render(&lt;Demo/&gt;,document.body)</span><br></pre></td></tr></table></figure>

<h2 id="七、非DOM（元素）属性"><a href="#七、非DOM（元素）属性" class="headerlink" title="七、非DOM（元素）属性"></a>七、非DOM（元素）属性</h2><ul>
<li><code>dangerouslySetInnerHTML</code>：在<code>JSX</code>中直接插入<code>HTML</code>代码，动态的添加<code>HTML</code>内容，由用户添加。需要使用属性，<code>__html</code></li>
<li><code>ref</code>：父组件引用子组件 <code>this.refs.name</code></li>
<li><code>key</code>：目的提高渲染性能 ，涉及到<code>React diff</code>算法，<code>React</code>通过<code>key</code>值判断是否重新渲染</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/26/React/React-02-jsx%E4%B8%8E%E9%9D%9EDOM/" data-id="cl7icg6vi00p0ugund69e31xi" data-title="React-jsx与非DOM" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-React/React-01-概念" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/20/React/React-01-%E6%A6%82%E5%BF%B5/" class="article-date">
  <time class="dt-published" datetime="2019-10-20T01:24:49.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/20/React/React-01-%E6%A6%82%E5%BF%B5/">React 概念</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、什么是react"><a href="#一、什么是react" class="headerlink" title="一、什么是react"></a>一、什么是react</h2><ul>
<li>react是由Facebook开发的一个JavaScript库，而不是一个框架。当时Facebook需要解决一个问题，开发（或者说是构建）一个数据不断变化的大型应用。而数据变化会带来两个很严重的问题</li>
</ul>
<h2 id="二、react的特点"><a href="#二、react的特点" class="headerlink" title="二、react的特点"></a>二、react的特点</h2><ul>
<li>简单：学习简单，代码简单</li>
<li>声明式（编程）：自动<code>DOM</code>操作</li>
</ul>
<blockquote>
<p><code>React</code>的核心是组件，组件的设计目的是提升代码的复用率、降低测试难度和代码复杂度。</p>
</blockquote>
<ul>
<li>提高代码复用率：组件将数据与逻辑封装</li>
<li>降低测试难度：组件高内聚低耦合，很容易对单个组件进行测试</li>
<li>降低代码复杂度：使用<code>JSX</code>语法，更直观的在js文件中看<code>HTML</code>代码，提高可读性</li>
</ul>
<h2 id="三、react的开发环境的配置"><a href="#三、react的开发环境的配置" class="headerlink" title="三、react的开发环境的配置"></a>三、react的开发环境的配置</h2><blockquote>
<p>如果是要直接在<code>HTML</code>上编辑，需要下载<code>react.js</code>与<code>react-dom.js</code>。如果要使用JSX语法，则需要使用转换<code>JSX</code>语法的插件。这里使用<code>brower.js</code>。在线地址：<a target="_blank" rel="noopener" href="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js">https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js</a></p>
</blockquote>
<ul>
<li><code>react.js</code>：<code>react</code>的核心库</li>
<li><code>react-dom.js</code>：提供操作<code>DOM</code>相关的功能</li>
<li><code>brower,js</code>：将使用的<code>JSX</code>语法转换成<code>JavaScript</code>语法</li>
</ul>
<blockquote>
<p>注意：三者引用顺序必须是<code>react</code>、<code>react-dom</code>、<code>brower</code></p>
</blockquote>
<h2 id="四、React、ReactDOM中有什么"><a href="#四、React、ReactDOM中有什么" class="headerlink" title="四、React、ReactDOM中有什么"></a>四、React、ReactDOM中有什么</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/449.png" alt="img"><br><img src="https://poetries1.gitee.io/img-repo/2019/10/450.png" alt="img"></p>
<h2 id="五、yeoman环境"><a href="#五、yeoman环境" class="headerlink" title="五、yeoman环境"></a>五、yeoman环境</h2><blockquote>
<p><code>yeoman</code>前端脚手架工具</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i -g yeoman</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://yeoman.io/">http://yeoman.io/</a></li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/react-webpack-generators/generator-react-webpack#readme">https://github.com/react-webpack-generators/generator-react-webpack#readme</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Make sure both is installed globally</span><br><span class="line">npm install -g yo</span><br><span class="line">npm install -g generator-react-webpack</span><br><span class="line"></span><br><span class="line"># Create a new directory, and `cd` into it:</span><br><span class="line">mkdir my-new-project &amp;&amp; cd my-new-project</span><br><span class="line"></span><br><span class="line"># Run the generator</span><br><span class="line">yo react-webpack</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Start for development</span><br><span class="line">npm start # or</span><br><span class="line">npm run serve</span><br><span class="line"></span><br><span class="line"># Start the dev-server with the dist version</span><br><span class="line">npm run serve:dist</span><br><span class="line"></span><br><span class="line"># Just build the dist version and copy static files</span><br><span class="line">npm run dist</span><br><span class="line"></span><br><span class="line"># Run unit tests</span><br><span class="line">npm test</span><br><span class="line"></span><br><span class="line"># Auto-run unit tests on file changes</span><br><span class="line">npm run test:watch</span><br><span class="line"></span><br><span class="line"># Lint all files in src (also automatically done AFTER tests are run)</span><br><span class="line">npm run lint</span><br><span class="line"></span><br><span class="line"># Clean up the dist directory</span><br><span class="line">npm run clean</span><br><span class="line"></span><br><span class="line"># Just copy the static assets</span><br><span class="line">npm run copy</span><br></pre></td></tr></table></figure>

<h2 id="六、React脚手架搭建"><a href="#六、React脚手架搭建" class="headerlink" title="六、React脚手架搭建"></a>六、React脚手架搭建</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i create-react-app</span><br><span class="line"></span><br><span class="line">create-react-app your-app-name &amp;&amp; cd your-app-name</span><br><span class="line"></span><br><span class="line">npm install </span><br><span class="line"></span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/20/React/React-01-%E6%A6%82%E5%BF%B5/" data-id="cl7icg6vi00p1ugungwh45dmn" data-title="React 概念" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-部署/Nginx基础配置" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/09/24/%E9%83%A8%E7%BD%B2/Nginx%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/" class="article-date">
  <time class="dt-published" datetime="2019-09-24T11:54:18.000Z" itemprop="datePublished">2019-09-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/liunx/">liunx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/09/24/%E9%83%A8%E7%BD%B2/Nginx%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/">Nginx基础配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Nginx 配置文件在线生成: <a target="_blank" rel="noopener" href="https://nginxconfig.io/">https://nginxconfig.io/</a></p>
</blockquote>
<h3 id="Nginx的启动、停止与重启"><a href="#Nginx的启动、停止与重启" class="headerlink" title="Nginx的启动、停止与重启"></a>Nginx的启动、停止与重启</h3><ul>
<li>建立软连接<code>Nginx</code>到<code>/usr/bin</code>目录下 <code>ln -s /usr/sbin/nginx /usr/bin</code></li>
</ul>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><ul>
<li>启动代码格式：<code>nginx</code>安装目录地址 <code>-c nginx</code>配置文件地址</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@LinuxServer sbin]# /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<h4 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h4><blockquote>
<p>nginx的停止有三种方式</p>
</blockquote>
<p><strong>从容停止</strong></p>
<ul>
<li>查看进程号 <code>ps -ef|grep nginx</code></li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102182744854-1291053517.png" alt="img"></p>
<ul>
<li>杀死进程 kill -QUIT 2072</li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102182652354-960281274.png" alt="img"></p>
<p><strong>快速停止</strong></p>
<ul>
<li>查看进程号 <code>ps -ef|grep nginx</code></li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102183103651-1859453208.png" alt="img"></p>
<ul>
<li>杀死进程 <code>kill -TERM 2132</code> <code>kill -INT 2132</code></li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102183340010-2024212451.png" alt="img"></p>
<ul>
<li>强制停止 <code>pkill -9 nginx</code></li>
</ul>
<p><strong>重启</strong></p>
<blockquote>
<p>验证<code>nginx</code>配置文件是否正确</p>
</blockquote>
<ul>
<li>方法一：进入<code>nginx</code>安装目录<code>sbin</code>下，输入命令<code>./nginx -t</code><br>看到如下显示<code>nginx.conf syntax is ok nginx.conf test is successful</code>说明配置文件正确</li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102184633432-1268782338.png" alt="img"></p>
<ul>
<li>方法二：在启动命令<code>-c</code>前加<code>-t</code></li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102185023385-456612180.png" alt="img"></p>
<p><strong>重启Nginx服务</strong></p>
<ul>
<li>方法一：进入<code>nginx</code>可执行目录<code>sbin</code>下，输入命令<code>./nginx -s reload</code>即可</li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102185521057-1341380905.png" alt="img"></p>
<ul>
<li>方法二：查找当前<code>nginx</code>进程号，然后输入命令：<code>kill -HUP</code> 进程号 实现重启<code>nginx</code>服务</li>
</ul>
<p><img src="http://images2015.cnblogs.com/blog/848552/201601/848552-20160102185838167-234856506.png" alt="img"></p>
<h3 id="Nginx基础配置"><a href="#Nginx基础配置" class="headerlink" title="Nginx基础配置"></a>Nginx基础配置</h3><ul>
<li>在<code>Nginx</code>目录下的<code>vhost或conf.d</code>目录下新建一个配置文件（如<code>poetries-80.conf</code>）</li>
<li>把server的内容配置进去</li>
<li>在<code>Nginx.conf</code>中的<code>http</code>下<code>include</code>配置文件</li>
<li>检测配置文件是否出错 <code>切换到/etc/nginx下 nginx -t</code></li>
<li>重新加载配置文件 <code>nginx -c /usr/local/etc/nginx/nginx.conf</code></li>
<li>在重启<code>Nginx</code> <code>nginx -s reload</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">user  root;  //Nginx需要有有一个用户</span><br><span class="line">worker_processes  2; // Nginx进程数 最大1024</span><br><span class="line">pid        conf/nginx.pid; </span><br><span class="line">worker_rlimit_nofile 2048;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections  2048;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name  119.29.145.252;</span><br><span class="line">	   </span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /usr/local/nginx/html;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   server &#123;</span><br><span class="line">       listen       3001;</span><br><span class="line">       server_name  119.29.145.252;</span><br><span class="line">	   </span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /usr/local/nginx/book;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   server &#123;</span><br><span class="line">       listen       9000;</span><br><span class="line">       server_name  119.29.145.252;</span><br><span class="line">	   </span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /usr/local/nginx/vue;</span><br><span class="line">           index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一些错误"><a href="#一些错误" class="headerlink" title="一些错误"></a>一些错误</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx: [error] invalid PID number “” in “/usr/local/var/run/nginx/nginx.pid”</span><br></pre></td></tr></table></figure>

<ul>
<li>解决办法：<code>nginx -c /usr/local/etc/nginx/nginx.conf</code></li>
<li><code>nginx -s reload</code></li>
</ul>
<p><strong>权限问题导致Nginx 403 Forbidden错误的解决方法</strong></p>
<ul>
<li>在<code>nginx.conf</code>头部加入一行 <code>user root;</code></li>
<li>重启<code>nginx</code>再访问，就可以正常访问了</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/24/%E9%83%A8%E7%BD%B2/Nginx%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/" data-id="cl7icg7b000waugun706z14hk" data-title="Nginx基础配置" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-部署/Nginx学习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/30/%E9%83%A8%E7%BD%B2/Nginx%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2019-08-30T13:45:58.000Z" itemprop="datePublished">2019-08-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/liunx/">liunx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/30/%E9%83%A8%E7%BD%B2/Nginx%E5%AD%A6%E4%B9%A0/">Nginx学习</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Nginx 配置文件在线生成: <a target="_blank" rel="noopener" href="https://nginxconfig.io/">https://nginxconfig.io/</a></p>
</blockquote>
<blockquote>
<p><code>Nginx</code> 是一款面向性能设计的 <code>HTTP</code> 服务器，能反向代理 <code>HTTP</code>，<code>HTTPS</code> 和邮件相关(<code>SMTP</code>，<code>POP3</code>，<code>IMAP</code>)的协议链接。并且提供了负载均衡以及 <code>HTTP</code> 缓存。它的设计充分使用异步事件模型，削减上下文调度的开销，提高服务器并发能力。采用了模块化设计，提供了丰富模块的第三方模块。</p>
</blockquote>
<ul>
<li>所以关于 &#96;Nginx，有这些标签：「异步」「事件」「模块化」「高性能」「高并发」「反向代理」「负载均衡」</li>
</ul>
<h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><h3 id="1-1-安装依赖"><a href="#1-1-安装依赖" class="headerlink" title="1.1 安装依赖"></a>1.1 安装依赖</h3><blockquote>
<p><code>prce</code>(重定向支持)和<code>openssl</code>(<code>https</code>支持，如果不需要<code>https</code>可以不安装)</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre-devel </span><br><span class="line">yum -y install gcc make gcc-c++ wget</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p><code>CentOS 6.5</code> 我安装的时候是选择的“基本服务器”，默认这两个包都没安装全，所以这两个都运行安装即可</p>
<h3 id="1-2-下载"><a href="#1-2-下载" class="headerlink" title="1.2 下载"></a>1.2 下载</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/download/">nginx的所有版本在这里</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.13.3.tar.gz</span><br><span class="line">wget http://nginx.org/download/nginx-1.13.7.tar.gz</span><br><span class="line"></span><br><span class="line"># 如果没有安装wget</span><br><span class="line"># 下载已编译版本</span><br><span class="line">$ yum install wget</span><br><span class="line"></span><br><span class="line"># 解压压缩包</span><br><span class="line">tar zxf nginx-1.13.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="1-3-编译安装"><a href="#1-3-编译安装" class="headerlink" title="1.3 编译安装"></a>1.3 编译安装</h3><p>然后进入目录编译安装，<a target="_blank" rel="noopener" href="http://blog.poetries.top/2018/02/25/nginx-study/#configure%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E">configure参数说明</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.11.5</span><br><span class="line">./configure</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">Configuration summary</span><br><span class="line">  + using system PCRE library</span><br><span class="line">  + OpenSSL library is not used</span><br><span class="line">  + using system zlib library</span><br><span class="line"></span><br><span class="line">  nginx path prefix: &quot;/usr/local/nginx&quot;</span><br><span class="line">  nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;</span><br><span class="line">  nginx modules path: &quot;/usr/local/nginx/modules&quot;</span><br><span class="line">  nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;</span><br><span class="line">  nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;</span><br><span class="line">  nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br><span class="line">  nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</span><br><span class="line">  nginx http access log file: &quot;/usr/local/nginx/logs/access.log&quot;</span><br><span class="line">  nginx http client request body temporary files: &quot;client_body_temp&quot;</span><br><span class="line">  nginx http proxy temporary files: &quot;proxy_temp&quot;</span><br><span class="line">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</span><br><span class="line">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</span><br><span class="line">  nginx http scgi temporary files: &quot;scgi_temp&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>安装报错误的话比如：<code>“C compiler cc is not found”</code>，这个就是缺少编译环境，安装一下就可以了 <code>yum -y install gcc make gcc-c++ openssl-devel</code></p>
</blockquote>
<p>如果没有<code>error</code>信息，就可以执行下边的安装了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="1-4-nginx测试"><a href="#1-4-nginx测试" class="headerlink" title="1.4 nginx测试"></a>1.4 nginx测试</h3><ul>
<li>运行下面命令会出现两个结果，一般情况<code>nginx</code>会安装在<code>/usr/local/nginx</code>目录中</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin/</span><br><span class="line">./nginx -t</span><br><span class="line"></span><br><span class="line"># nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line"># nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<h3 id="1-5-设置全局nginx命令"><a href="#1-5-设置全局nginx命令" class="headerlink" title="1.5 设置全局nginx命令"></a>1.5 设置全局nginx命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>将下面内容添加到 <code>~/.bash_profile</code> 文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=$PATH:$HOME/bin:/usr/local/nginx/sbin/</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>

<p>运行命令 <strong><code>source ~/.bash_profile</code></strong> 让配置立即生效。你就可以全局运行 <code>nginx</code> 命令了。</p>
<h2 id="二、开机自启动"><a href="#二、开机自启动" class="headerlink" title="二、开机自启动"></a>二、开机自启动</h2><p><strong>开机自启动方法一</strong></p>
<ul>
<li>编辑 <strong><code>vi /lib/systemd/system/nginx.service</code></strong> 文件，没有创建一个 <strong><code>touch nginx.service</code></strong> - 然后将如下内容根据具体情况进行修改后，添加到<code>nginx.service</code>文件中：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nginx</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[Unit]:服务的说明  </span><br><span class="line">Description:描述服务  </span><br><span class="line">After:描述服务类别  </span><br><span class="line">[Service]服务运行参数的设置  </span><br><span class="line">Type=forking是后台运行的形式  </span><br><span class="line">ExecStart为服务的具体运行命令  </span><br><span class="line">ExecReload为重启命令  </span><br><span class="line">ExecStop为停止命令  </span><br><span class="line">PrivateTmp=True表示给服务分配独立的临时空间  </span><br><span class="line">注意：[Service]的启动、重启、停止命令全部要求使用绝对路径  </span><br><span class="line">[Install]运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3</span><br></pre></td></tr></table></figure>

<p>保存退出。</p>
<p>设置开机启动，使配置生效：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable nginx.service</span><br><span class="line"># 输出下面内容表示成功了</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br></pre></td></tr></table></figure>

<p><strong>开机自启动方法二</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.local</span><br><span class="line"></span><br><span class="line"># 在 rc.local 文件中，添加下面这条命令</span><br><span class="line">/usr/local/nginx/sbin/nginx start</span><br></pre></td></tr></table></figure>

<ul>
<li>如果开机后发现自启动脚本没有执行，你要去确认一下<code>rc.local</code>这个文件的访问权限是否是可执行的，因为<code>rc.local</code>默认是不可执行的。修改<code>rc.local</code>访问权限，增加可执行权限：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>

<h2 id="三、运维"><a href="#三、运维" class="headerlink" title="三、运维"></a>三、运维</h2><h3 id="3-1-服务管理"><a href="#3-1-服务管理" class="headerlink" title="3.1 服务管理"></a>3.1 服务管理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 启动</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line"># 重启</span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line"># 关闭进程</span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"></span><br><span class="line"># 平滑关闭nginx</span><br><span class="line">/usr/local/nginx/sbin/nginx -s quit</span><br><span class="line"></span><br><span class="line"># 查看nginx的安装状态，</span><br><span class="line">/usr/local/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>

<p><strong>关闭防火墙，或者添加防火墙规则就可以测试了</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br></pre></td></tr></table></figure>

<p>或者编辑配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<p>添加这样一条开放80端口的规则后保存：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>重启服务即可:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service iptables restart</span><br><span class="line"># 命令进行查看目前nat</span><br><span class="line">iptables -t nat -L</span><br></pre></td></tr></table></figure>

<h3 id="3-2-重启服务防火墙报错解决"><a href="#3-2-重启服务防火墙报错解决" class="headerlink" title="3.2 重启服务防火墙报错解决"></a>3.2 重启服务防火墙报错解决</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service iptables restart</span><br><span class="line"># Redirecting to /bin/systemctl restart  iptables.service</span><br><span class="line"># Failed to restart iptables.service: Unit iptables.service failed to load: No such file or directory.</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>CentOS 7</code>或<code>RHEL 7</code>或<code>Fedora</code>中防火墙由 <strong><code>firewalld</code></strong> 来管理，当然你可以还原传统的管理方式。或则使用新的命令进行管理。<br>假如采用传统请执行一下命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 传统命令</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl mask firewalld</span><br><span class="line"># 安装命令</span><br><span class="line">yum install iptables-services</span><br><span class="line"></span><br><span class="line">systemctl enable iptables </span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure>

<h2 id="四、nginx卸载"><a href="#四、nginx卸载" class="headerlink" title="四、nginx卸载"></a>四、nginx卸载</h2><ul>
<li>如果通过<code>yum</code>安装，使用下面命令安装。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>编译安装，删除<code>/usr/local/nginx</code>目录即可</li>
<li>如果配置了自启动脚本，也需要删除。</li>
</ul>
<h2 id="五、参数说明"><a href="#五、参数说明" class="headerlink" title="五、参数说明"></a>五、参数说明</h2><table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">–prefix&#x3D;&#96;&#96;</td>
<td align="left">Nginx安装路径。如果没有指定，默认为 &#x2F;usr&#x2F;local&#x2F;nginx。</td>
</tr>
<tr>
<td align="left">–sbin-path&#x3D;&#96;&#96;</td>
<td align="left">Nginx可执行文件安装路径。只能安装时指定，如果没有指定，默认为&#96;&#96;&#x2F;sbin&#x2F;nginx。</td>
</tr>
<tr>
<td align="left">–conf-path&#x3D;&#96;&#96;</td>
<td align="left">在没有给定-c选项下默认的nginx.conf的路径。如果没有指定，默认为&#96;&#96;&#x2F;conf&#x2F;nginx.conf。</td>
</tr>
<tr>
<td align="left">–pid-path&#x3D;&#96;&#96;</td>
<td align="left">在nginx.conf中没有指定pid指令的情况下，默认的nginx.pid的路径。如果没有指定，默认为 &#96;&#96;&#x2F;logs&#x2F;nginx.pid。</td>
</tr>
<tr>
<td align="left">–lock-path&#x3D;&#96;&#96;</td>
<td align="left">nginx.lock文件的路径。</td>
</tr>
<tr>
<td align="left">–error-log-path&#x3D;&#96;&#96;</td>
<td align="left">在nginx.conf中没有指定error_log指令的情况下，默认的错误日志的路径。如果没有指定，默认为 &#96;&#96;&#x2F;- logs&#x2F;error.log。</td>
</tr>
<tr>
<td align="left">–http-log-path&#x3D;&#96;&#96;</td>
<td align="left">在nginx.conf中没有指定access_log指令的情况下，默认的访问日志的路径。如果没有指定，默认为 &#96;&#96;&#x2F;- logs&#x2F;access.log。</td>
</tr>
<tr>
<td align="left">–user&#x3D;&#96;&#96;</td>
<td align="left">在nginx.conf中没有指定user指令的情况下，默认的nginx使用的用户。如果没有指定，默认为 nobody。</td>
</tr>
<tr>
<td align="left">–group&#x3D;&#96;&#96;</td>
<td align="left">在nginx.conf中没有指定user指令的情况下，默认的nginx使用的组。如果没有指定，默认为 nobody。</td>
</tr>
<tr>
<td align="left">–builddir&#x3D;DIR</td>
<td align="left">指定编译的目录</td>
</tr>
<tr>
<td align="left">–with-rtsig_module</td>
<td align="left">启用 rtsig 模块</td>
</tr>
<tr>
<td align="left">–with-select_module –without-select_module</td>
<td align="left">允许或不允许开启SELECT模式，如果 configure 没有找到更合适的模式，比如：kqueue(sun os),epoll (linux kenel 2.6+), rtsig(- 实时信号)或者&#x2F;dev&#x2F;poll(一种类似select的模式，底层实现与SELECT基本相 同，都是采用轮训方法) SELECT模式将是默认安装模式</td>
</tr>
<tr>
<td align="left">–with-poll_module –without-poll_module</td>
<td align="left">Whether or not to enable the poll module. This module is enabled by, default if a more suitable method such as kqueue, epoll, rtsig or &#x2F;dev&#x2F;poll is not discovered by configure.</td>
</tr>
<tr>
<td align="left">–with-http_ssl_module</td>
<td align="left">Enable ngx_http_ssl_module. Enables SSL support and the ability to handle HTTPS requests. Requires OpenSSL. On Debian, this is libssl-dev. 开启HTTP SSL模块，使NGINX可以支持HTTPS请求。这个模块需要已经安装了OPENSSL，在DEBIAN上是libssl</td>
</tr>
<tr>
<td align="left">–with-http_realip_module</td>
<td align="left">启用 ngx_http_realip_module</td>
</tr>
<tr>
<td align="left">–with-http_addition_module</td>
<td align="left">启用 ngx_http_addition_module</td>
</tr>
<tr>
<td align="left">–with-http_sub_module</td>
<td align="left">启用 ngx_http_sub_module</td>
</tr>
<tr>
<td align="left">–with-http_dav_module</td>
<td align="left">启用 ngx_http_dav_module</td>
</tr>
<tr>
<td align="left">–with-http_flv_module</td>
<td align="left">启用 ngx_http_flv_module</td>
</tr>
<tr>
<td align="left">–with-http_stub_status_module</td>
<td align="left">启用 “server status” 页</td>
</tr>
<tr>
<td align="left">–without-http_charset_module</td>
<td align="left">禁用 ngx_http_charset_module</td>
</tr>
<tr>
<td align="left">–without-http_gzip_module</td>
<td align="left">禁用 ngx_http_gzip_module. 如果启用，需要 zlib 。</td>
</tr>
<tr>
<td align="left">–without-http_ssi_module</td>
<td align="left">禁用 ngx_http_ssi_module</td>
</tr>
<tr>
<td align="left">–without-http_userid_module</td>
<td align="left">禁用 ngx_http_userid_module</td>
</tr>
<tr>
<td align="left">–without-http_access_module</td>
<td align="left">禁用 ngx_http_access_module</td>
</tr>
<tr>
<td align="left">–without-http_auth_basic_module</td>
<td align="left">禁用 ngx_http_auth_basic_module</td>
</tr>
<tr>
<td align="left">–without-http_autoindex_module</td>
<td align="left">禁用 ngx_http_autoindex_module</td>
</tr>
<tr>
<td align="left">–without-http_geo_module</td>
<td align="left">禁用 ngx_http_geo_module</td>
</tr>
<tr>
<td align="left">–without-http_map_module</td>
<td align="left">禁用 ngx_http_map_module</td>
</tr>
<tr>
<td align="left">–without-http_referer_module</td>
<td align="left">禁用 ngx_http_referer_module</td>
</tr>
<tr>
<td align="left">–without-http_rewrite_module</td>
<td align="left">禁用 ngx_http_rewrite_module. 如果启用需要 PCRE 。</td>
</tr>
<tr>
<td align="left">–without-http_proxy_module</td>
<td align="left">禁用 ngx_http_proxy_module</td>
</tr>
<tr>
<td align="left">–without-http_fastcgi_module</td>
<td align="left">禁用 ngx_http_fastcgi_module</td>
</tr>
<tr>
<td align="left">–without-http_memcached_module</td>
<td align="left">禁用 ngx_http_memcached_module</td>
</tr>
<tr>
<td align="left">–without-http_limit_zone_module</td>
<td align="left">禁用 ngx_http_limit_zone_module</td>
</tr>
<tr>
<td align="left">–without-http_empty_gif_module</td>
<td align="left">禁用 ngx_http_empty_gif_module</td>
</tr>
<tr>
<td align="left">–without-http_browser_module</td>
<td align="left">禁用 ngx_http_browser_module</td>
</tr>
<tr>
<td align="left">–without-http_upstream_ip_hash_module</td>
<td align="left">禁用 ngx_http_upstream_ip_hash_module</td>
</tr>
<tr>
<td align="left">–with-http_perl_module</td>
<td align="left">启用 ngx_http_perl_module</td>
</tr>
<tr>
<td align="left">–with-perl_modules_path&#x3D;PATH</td>
<td align="left">指定 perl 模块的路径</td>
</tr>
<tr>
<td align="left">–with-perl&#x3D;PATH</td>
<td align="left">指定 perl 执行文件的路径</td>
</tr>
<tr>
<td align="left">–http-log-path&#x3D;PATH</td>
<td align="left">Set path to the http access log</td>
</tr>
<tr>
<td align="left">–http-client-body-temp-path&#x3D;PATH</td>
<td align="left">Set path to the http client request body temporary files</td>
</tr>
<tr>
<td align="left">–http-proxy-temp-path&#x3D;PATH</td>
<td align="left">Set path to the http proxy temporary files</td>
</tr>
<tr>
<td align="left">–http-fastcgi-temp-path&#x3D;PATH</td>
<td align="left">Set path to the http fastcgi temporary files</td>
</tr>
<tr>
<td align="left">–without-http</td>
<td align="left">禁用 HTTP server</td>
</tr>
<tr>
<td align="left">–with-mail</td>
<td align="left">启用 IMAP4&#x2F;POP3&#x2F;SMTP 代理模块</td>
</tr>
<tr>
<td align="left">–with-mail_ssl_module</td>
<td align="left">启用 ngx_mail_ssl_module</td>
</tr>
<tr>
<td align="left">–with-cc&#x3D;PATH</td>
<td align="left">指定 C 编译器的路径</td>
</tr>
<tr>
<td align="left">–with-cpp&#x3D;PATH</td>
<td align="left">指定 C 预处理器的路径</td>
</tr>
<tr>
<td align="left">–with-cc-opt&#x3D;OPTIONS</td>
<td align="left">Additional parameters which will be added to the variable CFLAGS. With the use of the system library PCRE in FreeBSD, it is necessary to indicate –with-cc-opt&#x3D;”-I &#x2F;usr&#x2F;local&#x2F;include”. If we are using select() and it is necessary to increase the number of file descriptors, then this also can be assigned here: –with-cc-opt&#x3D;”-D FD_SETSIZE&#x3D;2048”.</td>
</tr>
<tr>
<td align="left">–with-ld-opt&#x3D;OPTIONS</td>
<td align="left">Additional parameters passed to the linker. With the use of the system library PCRE in - FreeBSD, it is necessary to indicate –with-ld-opt&#x3D;”-L &#x2F;usr&#x2F;local&#x2F;lib”.</td>
</tr>
<tr>
<td align="left">–with-cpu-opt&#x3D;CPU</td>
<td align="left">为特定的 CPU 编译，有效的值包括：pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</td>
</tr>
<tr>
<td align="left">–without-pcre</td>
<td align="left">禁止 PCRE 库的使用。同时也会禁止 HTTP rewrite 模块。在 “location” 配置指令中的正则表达式也需要 PCRE 。</td>
</tr>
<tr>
<td align="left">–with-pcre&#x3D;DIR</td>
<td align="left">指定 PCRE 库的源代码的路径。</td>
</tr>
<tr>
<td align="left">–with-pcre-opt&#x3D;OPTIONS</td>
<td align="left">Set additional options for PCRE building.</td>
</tr>
<tr>
<td align="left">–with-md5&#x3D;DIR</td>
<td align="left">Set path to md5 library sources.</td>
</tr>
<tr>
<td align="left">–with-md5-opt&#x3D;OPTIONS</td>
<td align="left">Set additional options for md5 building.</td>
</tr>
<tr>
<td align="left">–with-md5-asm</td>
<td align="left">Use md5 assembler sources.</td>
</tr>
<tr>
<td align="left">–with-sha1&#x3D;DIR</td>
<td align="left">Set path to sha1 library sources.</td>
</tr>
<tr>
<td align="left">–with-sha1-opt&#x3D;OPTIONS</td>
<td align="left">Set additional options for sha1 building.</td>
</tr>
<tr>
<td align="left">–with-sha1-asm</td>
<td align="left">Use sha1 assembler sources.</td>
</tr>
<tr>
<td align="left">–with-zlib&#x3D;DIR</td>
<td align="left">Set path to zlib library sources.</td>
</tr>
<tr>
<td align="left">–with-zlib-opt&#x3D;OPTIONS</td>
<td align="left">Set additional options for zlib building.</td>
</tr>
<tr>
<td align="left">–with-zlib-asm&#x3D;CPU</td>
<td align="left">Use zlib assembler sources optimized for specified CPU, valid values are: pentium, pentiumpro</td>
</tr>
<tr>
<td align="left">–with-openssl&#x3D;DIR</td>
<td align="left">Set path to OpenSSL library sources</td>
</tr>
<tr>
<td align="left">–with-openssl-opt&#x3D;OPTIONS</td>
<td align="left">Set additional options for OpenSSL building</td>
</tr>
<tr>
<td align="left">–with-debug</td>
<td align="left">启用调试日志</td>
</tr>
<tr>
<td align="left">–add-module&#x3D;PATH</td>
<td align="left">Add in a third-party module found in directory PATH</td>
</tr>
</tbody></table>
<h2 id="六、配置"><a href="#六、配置" class="headerlink" title="六、配置"></a>六、配置</h2><ul>
<li>在<code>Centos</code> 默认配置文件在 <strong><code>/usr/local/nginx-1.5.1/conf/nginx.conf</code></strong> 我们要在这里配置一些文件。<code>nginx.conf</code>是主配置文件，由若干个部分组成，每个大括号<code>&#123;&#125;</code>表示一个部分。每一行指令都由分号结束<code>;</code>，标志着一行的结束。</li>
</ul>
<h3 id="6-1-常用正则"><a href="#6-1-常用正则" class="headerlink" title="6.1 常用正则"></a>6.1 常用正则</h3><table>
<thead>
<tr>
<th align="left">正则</th>
<th align="left">说明</th>
<th align="left">正则</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>.</code></td>
<td align="left">匹配除换行符以外的任意字符</td>
<td align="left"><code>$</code></td>
<td align="left">匹配字符串的结束</td>
</tr>
<tr>
<td align="left"><code>?</code></td>
<td align="left">重复0次或1次</td>
<td align="left"><code>&#123;n&#125;</code></td>
<td align="left">重复n次</td>
</tr>
<tr>
<td align="left"><code>+</code></td>
<td align="left">重复1次或更多次</td>
<td align="left"><code>&#123;n,&#125;</code></td>
<td align="left">重复n次或更多次</td>
</tr>
<tr>
<td align="left"><code>*</code></td>
<td align="left">重复0次或更多次</td>
<td align="left"><code>[c]</code></td>
<td align="left">匹配单个字符c</td>
</tr>
<tr>
<td align="left"><code>\d</code></td>
<td align="left">匹配数字</td>
<td align="left"><code>[a-z]</code></td>
<td align="left">匹配a-z小写字母的任意一个</td>
</tr>
<tr>
<td align="left"><code>^</code></td>
<td align="left">匹配字符串的开始</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h3 id="6-2-全局变量"><a href="#6-2-全局变量" class="headerlink" title="6.2 全局变量"></a>6.2 全局变量</h3><table>
<thead>
<tr>
<th align="left">变量</th>
<th align="left">说明</th>
<th align="left">变量</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>$args</code></td>
<td align="left">这个变量等于请求行中的参数，同<code>$query_string</code></td>
<td align="left"><code>$remote_port</code></td>
<td align="left">客户端的端口。</td>
</tr>
<tr>
<td align="left"><code>$content_length</code></td>
<td align="left">请求头中的<code>Content-length</code>字段。</td>
<td align="left"><code>$remote_user</code></td>
<td align="left">已经经过<code>Auth Basic Module</code>验证的用户名。</td>
</tr>
<tr>
<td align="left"><code>$content_type</code></td>
<td align="left">请求头中的<code>Content-Type</code>字段。</td>
<td align="left"><code>$request_filename</code></td>
<td align="left">当前请求的文件路径，由<code>root</code>或<code>alias</code>指令与<code>URI</code>请求生成。</td>
</tr>
<tr>
<td align="left"><code>$document_root</code></td>
<td align="left">当前请求在<code>root</code>指令中指定的值。</td>
<td align="left"><code>$scheme</code></td>
<td align="left"><code>HTTP</code>方法（如<code>http</code>，<code>https</code>）。</td>
</tr>
<tr>
<td align="left"><code>$host</code></td>
<td align="left">请求主机头字段，否则为服务器名称。</td>
<td align="left"><code>$server_protocol</code></td>
<td align="left">请求使用的协议，通常是<code>HTTP/1.0</code>或<code>HTTP/1.1</code>。</td>
</tr>
<tr>
<td align="left"><code>$http_user_agent</code></td>
<td align="left">客户端<code>agent</code>信息</td>
<td align="left"><code>$server_addr</code></td>
<td align="left">服务器地址，在完成一次系统调用后可以确定这个值。</td>
</tr>
<tr>
<td align="left"><code>$http_cookie</code></td>
<td align="left">客户端<code>cookie</code>信息</td>
<td align="left"><code>$server_name</code></td>
<td align="left">服务器名称。</td>
</tr>
<tr>
<td align="left"><code>$limit_rate</code></td>
<td align="left">这个变量可以限制连接速率。</td>
<td align="left"><code>$server_port</code></td>
<td align="left">请求到达服务器的端口号。</td>
</tr>
<tr>
<td align="left"><code>$request_method</code></td>
<td align="left">客户端请求的动作，通常为<code>GET</code>或<code>POST</code>。</td>
<td align="left"><code>$request_uri</code></td>
<td align="left">包含请求参数的原始<code>URI</code>，不包含主机名，如：<code>/foo/bar.php?arg=baz</code>。</td>
</tr>
<tr>
<td align="left"><code>$remote_addr</code></td>
<td align="left">客户端的IP地址。</td>
<td align="left"><code>$uri</code></td>
<td align="left">不带请求参数的当前<code>URI</code>，<code>$uri</code>不包含主机名，如<code>/foo/bar.html</code>。</td>
</tr>
<tr>
<td align="left"><code>$document_uri</code></td>
<td align="left">与<code>$uri</code>相同。</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>例如请求：<code>http://localhost:3000/test1/test2/test.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$host：localhost  </span><br><span class="line">$server_port：3000  </span><br><span class="line">$request_uri：/test1/test2/test.php  </span><br><span class="line">$document_uri：/test1/test2/test.php  </span><br><span class="line">$document_root：/var/www/html  </span><br><span class="line">$request_filename：/var/www/html/test1/test2/test.php</span><br></pre></td></tr></table></figure>

<h3 id="6-3-符号参考"><a href="#6-3-符号参考" class="headerlink" title="6.3 符号参考"></a>6.3 符号参考</h3><table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">说明</th>
<th align="left">符号</th>
<th align="left">说明</th>
<th align="left">符号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>k</code>,<code>K</code></td>
<td align="left">千字节</td>
<td align="left"><code>m</code>,<code>M</code></td>
<td align="left">兆字节</td>
<td align="left"><code>ms</code></td>
<td align="left">毫秒</td>
</tr>
<tr>
<td align="left"><code>s</code></td>
<td align="left">秒</td>
<td align="left"><code>m</code></td>
<td align="left">分钟</td>
<td align="left"><code>h</code></td>
<td align="left">小时</td>
</tr>
<tr>
<td align="left"><code>d</code></td>
<td align="left">日</td>
<td align="left"><code>w</code></td>
<td align="left">周</td>
<td align="left"><code>M</code></td>
<td align="left">一个月, <code>30</code>天</td>
</tr>
</tbody></table>
<ul>
<li>例如，”8k”，”1m” 代表字节数计量。</li>
<li>例如，”1h 30m”，”1y 6M”。代表 “1小时 30分”，”1年零6个月”。</li>
</ul>
<h3 id="6-4-配置文件"><a href="#6-4-配置文件" class="headerlink" title="6.4 配置文件"></a>6.4 配置文件</h3><ul>
<li><code>nginx</code> 的配置系统由一个主配置文件和其他一些辅助的配置文件构成。这些配置文件均是纯文本文件，全部位于 <code>nginx</code> 安装目录下的 <code>conf</code> 目录下。</li>
<li>指令由 <code>nginx</code> 的各个模块提供，不同的模块会提供不同的指令来实现配置。<br>指令除了 <code>Key-Value</code> 的形式，还有作用域指令。</li>
<li><code>nginx.conf</code> 中的配置信息，根据其逻辑上的意义，对它们进行了分类，也就是分成了多个作用域，或者称之为配置指令上下文。不同的作用域含有一个或者多个配置项。</li>
</ul>
<blockquote>
<p>下面的这些上下文指令是用的比较多：</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left"><code>Directive</code></th>
<th align="left"><code>Description</code></th>
<th align="left"><code>Contains Directive</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>main</code></td>
<td align="left"><code>nginx</code> 在运行时与具体业务功能（比如 <code>http</code> 服务或者 <code>email</code>服务代理）无关的一些参数，比如工作进程数，运行的身份等。</td>
<td align="left"><code>user</code>, <code>worker_processes</code>, <code>error_log</code>, <code>events</code>, <code>http</code>, <code>mail</code></td>
</tr>
<tr>
<td align="left"><code>http</code></td>
<td align="left">与提供 <code>http</code> 服务相关的一些配置参数。例如：是否使用 <code>keepalive</code>啊，是否使用<code>gzip</code> 进行压缩等。</td>
<td align="left"><code>server</code></td>
</tr>
<tr>
<td align="left"><code>server</code></td>
<td align="left"><code>http</code> 服务上支持若干虚拟主机。每个虚拟主机一个对应的 <code>server</code> 配置项，配置项里面包含该虚拟主机相关的配置。在提供 <code>mail</code> 服务的代理时，也可以建立若干 <code>server.</code> 每个 <code>server</code> 通过监听的地址来区分。</td>
<td align="left"><code>listen</code>, <code>server_name</code>,<code>access_log</code>, <code>location</code>, <code>protocol</code>, <code>proxy</code>, <code>smtp_auth</code>, <code>xclient</code></td>
</tr>
<tr>
<td align="left"><code>location</code></td>
<td align="left"><code>http</code> 服务中，某些特定的 <code>URL</code> 对应的一系列配置项。</td>
<td align="left"><code>index</code>, <code>root</code></td>
</tr>
<tr>
<td align="left"><code>mail</code></td>
<td align="left">实现<code>email</code>相关的 <code>SMTP/IMAP/POP3</code> 代理时，共享的一些配置项（因为可能实现多个代理，工作在多个监听地址上）。</td>
<td align="left"><code>server</code>,<code>http</code>, <code>imap_capabilities</code></td>
</tr>
<tr>
<td align="left"><code>include</code></td>
<td align="left">以便增强配置文件的可读性，使得部分配置文件可以重新使用。</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left"><code>valid_referers</code></td>
<td align="left">用来校验<code>Http</code>请求头<code>Referer</code>是否有效。</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left"><code>try_files</code></td>
<td align="left">用在<code>server</code>部分，不过最常见的还是用在<code>location</code>部分，它会按照给定的参数顺序进行尝试，第一个被匹配到的将会被使用。</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left"><code>if</code></td>
<td align="left">当在<code>location</code>块中使用<code>if</code>指令，在某些情况下它并不按照预期运行，一般来说避免使用<code>if</code>指令。</td>
<td align="left">-</td>
</tr>
</tbody></table>
<ul>
<li>例如我们再 <strong><code>nginx.conf</code></strong> 里面引用两个配置 <code>vhost/example.com.conf</code>和 <code>vhost/gitlab.com.conf</code> 它们都被放在一个我自己新建的目录 <code>vhost</code>下面。<code>nginx.conf</code> 配置如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    include  vhost/example.com.conf;</span><br><span class="line">    include  vhost/gitlab.com.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>简单的配置: <code>example.com.conf</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  baidu.com app.baidu.com; # 这里指定域名</span><br><span class="line">    index        index.html index.htm;    # 这里指定默认入口页面</span><br><span class="line">    root /home/www/app.baidu.com;         # 这里指定目录</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-内置预定义变量"><a href="#6-5-内置预定义变量" class="headerlink" title="6.5 内置预定义变量"></a>6.5 内置预定义变量</h3><ul>
<li><code>Nginx</code>提供了许多预定义的变量，也可以通过使用<code>set</code>来设置变量。你可以在<code>if</code>中使用预定义变量，也可以将它们传递给代理服务器。以下是一些常见的预定义变量，<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/varindex.html">更多详见</a></li>
</ul>
<table>
<thead>
<tr>
<th align="left">变量名称</th>
<th align="left">值</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>$args_name</code></td>
<td align="left">在请求中的<code>name</code>参数</td>
</tr>
<tr>
<td align="left"><code>$args</code> &#96;</td>
<td align="left">所有请求参数</td>
</tr>
<tr>
<td align="left"><code>$query_string</code></td>
<td align="left"><code>$args</code>的别名</td>
</tr>
<tr>
<td align="left"><code>$content_length</code></td>
<td align="left">请求头<code>Content-Length</code>的值</td>
</tr>
<tr>
<td align="left"><code>$content_type</code></td>
<td align="left">请求头<code>Content-Type</code>的值</td>
</tr>
<tr>
<td align="left"><code>$host</code></td>
<td align="left">如果当前有<code>Host</code>，则为请求头<code>Host</code>的值；如果没有这个头，那么该值等于匹配该请求的<code>server_name</code>的值</td>
</tr>
<tr>
<td align="left"><code>$remote_addr</code></td>
<td align="left">客户端的<code>IP</code>地址</td>
</tr>
<tr>
<td align="left"><code>$request</code></td>
<td align="left">完整的请求，从客户端收到，包括<code>Http</code>请求方法、<code>URI</code>、<code>Http</code>协议、头、请求体</td>
</tr>
<tr>
<td align="left"><code>$request_uri</code></td>
<td align="left">完整请求的<code>URI</code>，从客户端来的请求，包括参数</td>
</tr>
<tr>
<td align="left"><code>$scheme</code></td>
<td align="left">当前请求的协议</td>
</tr>
<tr>
<td align="left"><code>$uri</code></td>
<td align="left">当前请求的标准化<code>URI</code></td>
</tr>
</tbody></table>
<h3 id="6-6-反向代理"><a href="#6-6-反向代理" class="headerlink" title="6.6 反向代理"></a>6.6 反向代理</h3><ul>
<li>反向代理是一个<code>Web</code>服务器，它接受客户端的连接请求，然后将请求转发给上游服务器，并将从服务器得到的结果返回给连接的客户端。下面简单的反向代理的例子：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;  </span><br><span class="line">  listen       80;                                                        </span><br><span class="line">  server_name  localhost;                                              </span><br><span class="line">  client_max_body_size 1024M;  # 允许客户端请求的最大单文件字节数</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass                         http://localhost:8080;</span><br><span class="line">    proxy_set_header Host              $host:$server_port;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $remote_addr; # HTTP的请求端真实的IP</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;      # 为了正确地识别实际用户发出的协议是 http 还是 https</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>复杂的配置: <code>gitlab.com.conf</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://localhost:3000;</span><br><span class="line">        #以下是一些反向代理的配置可删除</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        client_max_body_size       10m; #允许客户端请求的最大单文件字节数</span><br><span class="line">        client_body_buffer_size    128k; #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        proxy_connect_timeout      300; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">        proxy_send_timeout         300; #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">        proxy_read_timeout         300; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">        proxy_buffer_size          4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">        proxy_buffers              4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">        proxy_busy_buffers_size    64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>代理到上游服务器的配置中，最重要的是<code>proxy_pass</code>指令。以下是代理模块中的一些常用指令：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">指令</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>proxy_connect_timeout</code></td>
<td align="left"><code>Nginx</code>从接受请求至连接到上游服务器的最长等待时间</td>
</tr>
<tr>
<td align="left"><code>proxy_send_timeout</code></td>
<td align="left">后端服务器数据回传时间(代理发送超时)</td>
</tr>
<tr>
<td align="left"><code>proxy_read_timeout</code></td>
<td align="left">连接成功后，后端服务器响应时间(代理接收超时)</td>
</tr>
<tr>
<td align="left"><code>proxy_cookie_domain</code></td>
<td align="left">替代从上游服务器来的<code>Set-Cookie</code>头的<code>domain</code>属性</td>
</tr>
<tr>
<td align="left"><code>proxy_cookie_path</code></td>
<td align="left">替代从上游服务器来的<code>Set-Cookie</code>头的<code>path</code>属性</td>
</tr>
<tr>
<td align="left"><code>proxy_buffer_size</code></td>
<td align="left">设置代理服务器（<code>nginx</code>）保存用户头信息的缓冲区大小</td>
</tr>
<tr>
<td align="left"><code>proxy_buffers</code></td>
<td align="left"><code>proxy_buffers</code>缓冲区，网页平均在多少k以下</td>
</tr>
<tr>
<td align="left"><code>proxy_set_header</code></td>
<td align="left">重写发送到上游服务器头的内容，也可以通过将某个头部的值设置为空字符串，而不发送某个头部的方法实现</td>
</tr>
<tr>
<td align="left"><code>proxy_ignore_headers</code></td>
<td align="left">这个指令禁止处理来自代理服务器的应答。</td>
</tr>
<tr>
<td align="left"><code>proxy_intercept_errors</code></td>
<td align="left">使<code>nginx</code>阻止<code>HTTP</code>应答代码为<code>400</code>或者更高的应答。</td>
</tr>
</tbody></table>
<h3 id="6-7-负载均衡"><a href="#6-7-负载均衡" class="headerlink" title="6.7 负载均衡"></a>6.7 负载均衡</h3><ul>
<li><code>upstream</code>指令启用一个新的配置区段，在该区段定义一组上游服务器。这些服务器可能被设置不同的权重，也可能出于对服务器进行维护，标记为<code>down</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">upstream gitlab &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    # upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span><br><span class="line">    server 192.168.122.11:8081 ;</span><br><span class="line">    server 127.0.0.1:82 weight=3;</span><br><span class="line">    server 127.0.0.1:83 weight=3 down;</span><br><span class="line">    server 127.0.0.1:84 weight=3; max_fails=3  fail_timeout=20s;</span><br><span class="line">    server 127.0.0.1:85 weight=4;;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://gitlab;    #在这里设置一个代理，和upstream的名字一样</span><br><span class="line">        #以下是一些反向代理的配置可删除</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        proxy_set_header           X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        client_max_body_size       10m;  #允许客户端请求的最大单文件字节数</span><br><span class="line">        client_body_buffer_size    128k; #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        proxy_connect_timeout      300;  #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">        proxy_send_timeout         300;  #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">        proxy_read_timeout         300;  #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">        proxy_buffer_size          4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">        proxy_buffers              4 32k;# 缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">        proxy_busy_buffers_size    64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">        proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器<code>down</code>掉，能自动剔除。</li>
</ul>
<p><strong>负载均衡：</strong></p>
<ul>
<li><code>upstream</code>模块能够使用3种负载均衡算法：轮询、IP哈希、最少连接数。</li>
</ul>
<p><strong>轮询：</strong></p>
<ul>
<li>默认情况下使用轮询算法，不需要配置指令来激活它，它是基于在队列中谁是下一个的原理确保访问均匀地分布到每个上游服务器；</li>
</ul>
<p><strong>IP哈希：</strong></p>
<ul>
<li>通过<code>ip_hash</code>指令来激活，Nginx通过IPv4地址的前3个字节或者整个IPv6地址作为哈希键来实现，同一个IP地址总是能被映射到同一个上游服务器；</li>
</ul>
<p><strong>最少连接数：</strong></p>
<ul>
<li>通过<code>least_conn</code>指令来激活，该算法通过选择一个活跃数最少的上游服务器进行连接。如果上游服务器处理能力不同，可以通过给<code>server</code>配置<code>weight</code>权重来说明，该算法将考虑到不同服务器的加权最少连接数。</li>
</ul>
<h4 id="6-7-1-RR"><a href="#6-7-1-RR" class="headerlink" title="6.7.1 RR"></a>6.7.1 RR</h4><p><strong>简单配置</strong></p>
<blockquote>
<p>这里我配置了2台服务器，当然实际上是一台，只是端口不一样而已，而8081的服务器是不存在的，也就是说访问不到，但是我们访问 <code>http://localhost</code> 的时候，也不会有问题，会默认跳转到<code>http://localhost:8080</code>具体是因为Nginx会自动判断服务器的状态，如果服务器处于不能访问（服务器挂了），就不会跳转到这台服务器，所以也避免了一台服务器挂了影响使用的情况，由于Nginx默认是RR策略，所以我们不需要其他更多的设置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       81;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    client_max_body_size 1024M;</span><br><span class="line"> </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://test;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>负载均衡的核心代码为</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-2-权重"><a href="#6-7-2-权重" class="headerlink" title="6.7.2 权重"></a>6.7.2 权重</h4><ul>
<li>指定轮询几率，<code>weight</code>和访问比率成正比，用于后端服务器性能不均的情况。 例如</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    server localhost:8080 weight=9;</span><br><span class="line">    server localhost:8081 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>那么10次一般只会有<code>1</code>次会访问到<code>8081</code>，而有<code>9</code>次会访问到<code>8080</code></li>
</ul>
<h4 id="6-7-3-ip-hash"><a href="#6-7-3-ip-hash" class="headerlink" title="6.7.3 ip_hash"></a>6.7.3 ip_hash</h4><blockquote>
<p>上面的2种方式都有一个问题，那就是下一个请求来的时候请求可能分发到另外一个服务器，当我们的程序不是无状态的时候（采用了<code>session</code>保存数据），这时候就有一个很大的很问题了，比如把登录信息保存到了<code>session</code>中，那么跳转到另外一台服务器的时候就需要重新登录了，所以很多时候我们需要一个客户只访问一个服务器，那么就需要用<code>iphash</code>了，<code>iphash</code>的每个请求按访问<code>ip</code>的<code>hash</code>结果分配，这样每个访客固定访问一个后端服务器，可以解决<code>session</code>的问题。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-4-fair"><a href="#6-7-4-fair" class="headerlink" title="6.7.4 fair"></a>6.7.4 fair</h4><ul>
<li>这是个第三方模块，按后端服务器的响应时间来分配请求，响应时间短的优先分配。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    fair;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-7-5-url-hash"><a href="#6-7-5-url-hash" class="headerlink" title="6.7.5 url_hash"></a>6.7.5 url_hash</h4><blockquote>
<p>这是个第三方模块，按访问<code>url</code>的<code>hash</code>结果来分配请求，使每个<code>url</code>定向到同一个后端服务器，后端服务器为缓存时比较有效。 在<code>upstream</code>中加入<code>hash</code>语句，<code>server</code>语句中不能写入<code>weight</code>等其他的参数，<code>hash_method</code>是使用的<code>hash</code>算法</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    hash_method crc32;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上<code>5</code>种负载均衡各自适用不同情况下使用，所以可以根据实际情况选择使用哪种策略模式，不过<code>fair</code>和<code>url_hash</code>需要安装第三方模块才能使用</li>
</ul>
<p><strong>server指令可选参数：</strong></p>
<ul>
<li><code>weight</code>：设置一个服务器的访问权重，数值越高，收到的请求也越多；</li>
<li><code>fail_timeout</code>：在这个指定的时间内服务器必须提供响应，如果在这个时间内没有收到响应，那么服务器将会被标记为<code>down</code>状态；</li>
<li><code>max_fails</code>：设置在<code>fail_timeout</code>时间之内尝试对一个服务器连接的最大次数，如果超过这个次数，那么服务器将会被标记为<code>down</code>;</li>
<li><code>down</code>：标记一个服务器不再接受任何请求；</li>
<li><code>backup</code>：一旦其他服务器宕机，那么有该标记的机器将会接收请求。</li>
</ul>
<p><strong>keepalive指令：</strong></p>
<ul>
<li><code>Nginx</code>服务器将会为每一个<code>worker</code>进行保持同上游服务器的连接。</li>
</ul>
<h3 id="6-8-屏蔽ip"><a href="#6-8-屏蔽ip" class="headerlink" title="6.8 屏蔽ip"></a>6.8 屏蔽ip</h3><ul>
<li>在<code>nginx</code>的配置文件<code>nginx.conf</code>中加入如下配置，可以放到<code>http</code>, <code>server</code>, <code>location</code>, <code>limit_except</code>语句块，需要注意相对路径，本例当中<code>nginx.conf</code>，<code>blocksip.conf</code>在同一个目录中。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include blockip.conf;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>blockip.conf</code>里面输入内容，如：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">deny 165.91.122.67;</span><br><span class="line"></span><br><span class="line">deny IP;   # 屏蔽单个ip访问</span><br><span class="line">allow IP;  # 允许单个ip访问</span><br><span class="line">deny all;  # 屏蔽所有ip访问</span><br><span class="line">allow all; # 允许所有ip访问</span><br><span class="line">deny 123.0.0.0/8   # 屏蔽整个段即从123.0.0.1到123.255.255.254访问的命令</span><br><span class="line">deny 124.45.0.0/16 # 屏蔽IP段即从123.45.0.1到123.45.255.254访问的命令</span><br><span class="line">deny 123.45.6.0/24 # 屏蔽IP段即从123.45.6.1到123.45.6.254访问的命令</span><br><span class="line"></span><br><span class="line"># 如果你想实现这样的应用，除了几个IP外，其他全部拒绝</span><br><span class="line">allow 1.1.1.1; </span><br><span class="line">allow 1.1.1.2;</span><br><span class="line">deny all;</span><br></pre></td></tr></table></figure>

<h2 id="七、第三方模块安装方法"><a href="#七、第三方模块安装方法" class="headerlink" title="七、第三方模块安装方法"></a>七、第三方模块安装方法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/你的安装目录  --add-module=/第三方模块目录</span><br></pre></td></tr></table></figure>

<h2 id="八、重定向"><a href="#八、重定向" class="headerlink" title="八、重定向"></a>八、重定向</h2><ul>
<li><code>permanent</code> 永久性重定向。请求日志中的状态码为301</li>
<li><code>redirect</code> 临时重定向。请求日志中的状态码为302</li>
</ul>
<h3 id="8-1-重定向整个网站"><a href="#8-1-重定向整个网站" class="headerlink" title="8.1 重定向整个网站"></a>8.1 重定向整个网站</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name old-site.com</span><br><span class="line">    return 301 $scheme://new-site.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-重定向单页"><a href="#8-2-重定向单页" class="headerlink" title="8.2 重定向单页"></a>8.2 重定向单页</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location = /oldpage.html &#123;</span><br><span class="line">        return 301 http://example.org/newpage.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-重定向整个子路径"><a href="#8-3-重定向整个子路径" class="headerlink" title="8.3 重定向整个子路径"></a>8.3 重定向整个子路径</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /old-site &#123;</span><br><span class="line">    rewrite ^/old-site/(.*) http://example.org/new-site/$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="九、性能"><a href="#九、性能" class="headerlink" title="九、性能"></a>九、性能</h2><h3 id="9-1-内容缓存"><a href="#9-1-内容缓存" class="headerlink" title="9.1 内容缓存"></a>9.1 内容缓存</h3><ul>
<li>允许浏览器基本上永久地缓存静态内容。 <code>Nginx</code>将为您设置<code>Expires</code>和<code>Cache-Control</code>头信息。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123;</span><br><span class="line">    root /data;</span><br><span class="line">    expires max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果要求浏览器永远不会缓存响应（例如用于跟踪请求），请使用<code>-1</code>。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location = /empty.gif &#123;</span><br><span class="line">    empty_gif;</span><br><span class="line">    expires -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-Gzip压缩"><a href="#9-2-Gzip压缩" class="headerlink" title="9.2 Gzip压缩"></a>9.2 Gzip压缩</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gzip  on;</span><br><span class="line">gzip_buffers 16 8k;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_min_length 256;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_types</span><br><span class="line">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">    text/javascript application/javascript application/x-javascript</span><br><span class="line">    text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">    text/css text/plain text/x-component</span><br><span class="line">    font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">    image/x-icon;</span><br><span class="line">gzip_disable  &quot;msie6&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-打开文件缓存"><a href="#9-3-打开文件缓存" class="headerlink" title="9.3 打开文件缓存"></a>9.3 打开文件缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=1000 inactive=20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br></pre></td></tr></table></figure>

<h3 id="9-4-SSL缓存"><a href="#9-4-SSL缓存" class="headerlink" title="9.4 SSL缓存"></a>9.4 SSL缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_timeout 10m;</span><br></pre></td></tr></table></figure>

<h3 id="9-5-上游Keepalive"><a href="#9-5-上游Keepalive" class="headerlink" title="9.5 上游Keepalive"></a>9.5 上游Keepalive</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location /api/ &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-6-监控"><a href="#9-6-监控" class="headerlink" title="9.6 监控"></a>9.6 监控</h3><ul>
<li>使用<code>ngxtop</code>实时解析<code>nginx</code>访问日志，并且将处理结果输出到终端，功能类似于系统命令<code>top</code>。所有示例都读取<code>nginx</code>配置文件的访问日志位置和格式。如果要指定访问日志文件和&#x2F;或日志格式，请使用-f和-a选项。</li>
<li>注意：在<code>nginx</code>配置中<code>/usr/local/nginx/conf/nginx.conf</code>日志文件必须是绝对路径。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 安装 ngxtop</span><br><span class="line">pip install ngxtop</span><br><span class="line"></span><br><span class="line"># 实时状态</span><br><span class="line">ngxtop</span><br><span class="line"># 状态为404的前10个请求的路径：</span><br><span class="line">ngxtop top request_path --filter &#x27;status == 404&#x27;</span><br><span class="line"></span><br><span class="line"># 发送总字节数最多的前10个请求</span><br><span class="line">ngxtop --order-by &#x27;avg(bytes_sent) * count&#x27;</span><br><span class="line"></span><br><span class="line"># 排名前十位的IP，例如，谁攻击你最多</span><br><span class="line">ngxtop --group-by remote_addr</span><br><span class="line"></span><br><span class="line"># 打印具有4xx或5xx状态的请求，以及status和http referer</span><br><span class="line">ngxtop -i &#x27;status &gt;= 400&#x27; print request status http_referer</span><br><span class="line"></span><br><span class="line"># 由200个请求路径响应发送的平均正文字节以&#x27;foo&#x27;开始：</span><br><span class="line">ngxtop avg bytes_sent --filter &#x27;status == 200 and request_path.startswith(&quot;foo&quot;)&#x27;</span><br><span class="line"></span><br><span class="line"># 使用“common”日志格式从远程机器分析apache访问日志</span><br><span class="line">ssh remote tail -f /var/log/apache2/access.log | ngxtop -f common</span><br></pre></td></tr></table></figure>

<h2 id="十、常见使用场景"><a href="#十、常见使用场景" class="headerlink" title="十、常见使用场景"></a>十、常见使用场景</h2><h3 id="10-1-跨域问题"><a href="#10-1-跨域问题" class="headerlink" title="10.1 跨域问题"></a>10.1 跨域问题</h3><ul>
<li>在工作中，有时候会遇到一些接口不支持跨域，这时候可以简单的添加<code>add_headers</code>来支持<code>cors</code>跨域。配置如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">    </span><br><span class="line">  add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line">  add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;</span><br><span class="line">  add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET,POST,HEAD&#x27;;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:3000;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Host  $http_host;    </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面更改头信息，还有一种，使用 <a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html">rewrite</a> 指令重定向URI来解决跨域问题。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">  server 127.0.0.1:8080;</span><br><span class="line">  server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">  location / &#123; </span><br><span class="line">    root  html;                   #去请求../html文件夹里的文件</span><br><span class="line">    index  index.html index.htm;  #首页响应地址</span><br><span class="line">  &#125;</span><br><span class="line">  # 用于拦截请求，匹配任何以 /api/开头的地址，</span><br><span class="line">  # 匹配符合以后，停止往下搜索正则。</span><br><span class="line">  location ^~/api/&#123; </span><br><span class="line">    # 代表重写拦截进来的请求，并且只能对域名后边的除去传递的参数外的字符串起作用，</span><br><span class="line">    # 例如www.a.com/proxy/api/msg?meth=1&amp;par=2重写，只对/proxy/api/msg重写。</span><br><span class="line">    # rewrite后面的参数是一个简单的正则 ^/api/(.*)$，</span><br><span class="line">    # $1代表正则中的第一个()，$2代表第二个()的值，以此类推。</span><br><span class="line">    rewrite ^/api/(.*)$ /$1 break;</span><br><span class="line">    </span><br><span class="line">    # 把请求代理到其他主机 </span><br><span class="line">    # 其中 http://www.b.com/ 写法和 http://www.b.com写法的区别如下</span><br><span class="line">    # 如果你的请求地址是他 http://server/html/test.jsp</span><br><span class="line">    # 配置一： http://www.b.com/ 后面有“/” </span><br><span class="line">    #         将反向代理成 http://www.b.com/html/test.jsp 访问</span><br><span class="line">    # 配置一： http://www.b.com 后面没有有“/” </span><br><span class="line">    #         将反向代理成 http://www.b.com/test.jsp 访问</span><br><span class="line">    proxy_pass http://test;</span><br><span class="line"></span><br><span class="line">    # 如果 proxy_pass  URL 是 http://a.xx.com/platform/ 这种情况</span><br><span class="line">    # proxy_cookie_path应该设置成 /platform/ / (注意两个斜杠之间有空格)。</span><br><span class="line">    proxy_cookie_path /platfrom/ /;</span><br><span class="line"></span><br><span class="line">    # http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass_header</span><br><span class="line">    # 设置 Cookie 头通过</span><br><span class="line">    proxy_pass_header Set-Cookie;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-2-跳转到带www的域上面"><a href="#10-2-跳转到带www的域上面" class="headerlink" title="10.2 跳转到带www的域上面"></a>10.2 跳转到带www的域上面</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    # 配置正常的带www的域名</span><br><span class="line">    server_name www.wangchujiang.com;</span><br><span class="line">    root /home/www/wabg/download;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.html =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    # 这个要放到下面，</span><br><span class="line">    # 将不带www的 wangchujiang.com 永久性重定向到  https://www.wangchujiang.com</span><br><span class="line">    server_name wangchujiang.com;</span><br><span class="line">    rewrite ^(.*) https://www.wangchujiang.com$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-代理转发"><a href="#10-3-代理转发" class="headerlink" title="10.3 代理转发"></a>10.3 代理转发</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">upstream server-api&#123;</span><br><span class="line">    # api 代理服务地址</span><br><span class="line">    server 127.0.0.1:3110;    </span><br><span class="line">&#125;</span><br><span class="line">upstream server-resource&#123;</span><br><span class="line">    # 静态资源 代理服务地址</span><br><span class="line">    server 127.0.0.1:3120;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       3111;</span><br><span class="line">    server_name  localhost;      # 这里指定域名</span><br><span class="line">    root /home/www/server-statics;</span><br><span class="line">    # 匹配 api 路由的反向代理到API服务</span><br><span class="line">    location ^~/api/ &#123;</span><br><span class="line">        rewrite ^/(.*)$ /$1 break;</span><br><span class="line">        proxy_pass http://server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # 假设这里验证码也在API服务中</span><br><span class="line">    location ^~/captcha &#123;</span><br><span class="line">        rewrite ^/(.*)$ /$1 break;</span><br><span class="line">        proxy_pass http://server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # 假设你的图片资源全部在另外一个服务上面</span><br><span class="line">    location ^~/img/ &#123;</span><br><span class="line">        rewrite ^/(.*)$ /$1 break;</span><br><span class="line">        proxy_pass http://server-resource;</span><br><span class="line">    &#125;</span><br><span class="line">    # 路由在前端，后端没有真实路由，在路由不存在的 404状态的页面返回 /index.html</span><br><span class="line">    # 这个方式使用场景，你在写React或者Vue项目的时候，没有真实路由</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.html =404;</span><br><span class="line">        #                               ^ 空格很重要</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-4-代理转发连接替换"><a href="#10-4-代理转发连接替换" class="headerlink" title="10.4 代理转发连接替换"></a>10.4 代理转发连接替换</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ^~/api/upload &#123;</span><br><span class="line">    rewrite ^/(.*)$ /wfs/v1/upload break;</span><br><span class="line">    proxy_pass http://wfs-api;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-5-ssl配置"><a href="#10-5-ssl配置" class="headerlink" title="10.5 ssl配置"></a>10.5 ssl配置</h3><ul>
<li><p>超文本传输安全协议（缩写：HTTPS，英语：Hypertext Transfer Protocol Secure）是超文本传输协议和SSL&#x2F;TLS的组合，用以提供加密通讯及对网络服务器身份的鉴定。HTTPS连接经常被用于万维网上的交易支付和企业信息系统中敏感信息的传输。HTTPS不应与在RFC 2660中定义的安全超文本传输协议（S-HTTP）相混。HTTPS 目前已经是所有注重隐私和安全的网站的首选，随着技术的不断发展，HTTPS 网站已不再是大型网站的专利，所有普通的个人站长和博客均可以自己动手搭建一个安全的加密的网站。</p>
</li>
<li><p>创建<code>SSL</code>证书，如果你购买的证书，就可以直接下载</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /etc/nginx/ssl</span><br><span class="line"># 创建了有效期100年，加密强度为RSA2048的SSL密钥key和X509证书文件。</span><br><span class="line">sudo openssl req -x509 -nodes -days 36500 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt</span><br><span class="line"># 上面命令，会有下面需要填写内容</span><br><span class="line">Country Name (2 letter code) [AU]:US</span><br><span class="line">State or Province Name (full name) [Some-State]:New York</span><br><span class="line">Locality Name (eg, city) []:New York City</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Bouncy Castles, Inc.</span><br><span class="line">Organizational Unit Name (eg, section) []:Ministry of Water Slides</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:your_domain.com</span><br><span class="line">Email Address []:admin@your_domain.com</span><br></pre></td></tr></table></figure>

<ul>
<li>创建自签证书</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">首先，创建证书和私钥的目录</span><br><span class="line"># mkdir -p /etc/nginx/cert</span><br><span class="line"># cd /etc/nginx/cert</span><br><span class="line">创建服务器私钥，命令会让你输入一个口令：</span><br><span class="line"># openssl genrsa -des3 -out nginx.key 2048</span><br><span class="line">创建签名请求的证书（CSR）：</span><br><span class="line"># openssl req -new -key nginx.key -out nginx.csr</span><br><span class="line">在加载SSL支持的Nginx并使用上述私钥时除去必须的口令：</span><br><span class="line"># cp nginx.key nginx.key.org</span><br><span class="line"># openssl rsa -in nginx.key.org -out nginx.key</span><br><span class="line">最后标记证书使用上述私钥和CSR：</span><br><span class="line"># openssl x509 -req -days 365 -in nginx.csr -signkey nginx.key -out nginx.crt</span><br></pre></td></tr></table></figure>

<p>查看目前nginx编译选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbin/nginx -V</span><br></pre></td></tr></table></figure>

<p>输出下面内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx version: nginx/1.7.8</span><br><span class="line">built by gcc 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx-1.7.8 --with-http_ssl_module --with-http_spdy_module --with-http_stub_status_module --with-pcre</span><br></pre></td></tr></table></figure>

<p>如果依赖的模块不存在，可以进入安装目录，输入下面命令重新编译安装。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>

<p>运行完成之后还需要<code>make</code> (不用make install)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 备份nginx的二进制文件</span><br><span class="line">cp -rf /usr/local/nginx/sbin/nginx　 /usr/local/nginx/sbin/nginx.bak</span><br><span class="line"># 覆盖nginx的二进制文件</span><br><span class="line">cp -rf objs/nginx   /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<p>HTTPS server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    # 禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击</span><br><span class="line">    server_tokens off;</span><br><span class="line">    # 设置ssl/tls会话缓存的类型和大小。如果设置了这个参数一般是shared，buildin可能会参数内存碎片，默认是none，和off差不多，停用缓存。如shared:SSL:10m表示我所有的nginx工作进程共享ssl会话缓存，官网介绍说1M可以存放约4000个sessions。 </span><br><span class="line">    ssl_session_cache    shared:SSL:1m; </span><br><span class="line"></span><br><span class="line">    # 客户端可以重用会话缓存中ssl参数的过期时间，内网系统默认5分钟太短了，可以设成30m即30分钟甚至4h。</span><br><span class="line">    ssl_session_timeout  5m; </span><br><span class="line"></span><br><span class="line">    # 选择加密套件，不同的浏览器所支持的套件（和顺序）可能会不同。</span><br><span class="line">    # 这里指定的是OpenSSL库能够识别的写法，你可以通过 openssl -v cipher &#x27;RC4:HIGH:!aNULL:!MD5&#x27;（后面是你所指定的套件加密算法） 来看所支持算法。</span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">    # 设置协商加密算法时，优先使用我们服务端的加密套件，而不是客户端浏览器的加密套件。</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-6-强制将http重定向到https"><a href="#10-6-强制将http重定向到https" class="headerlink" title="10.6 强制将http重定向到https"></a>10.6 强制将http重定向到https</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  example.com;</span><br><span class="line">    rewrite ^ https://$http_host$request_uri? permanent;    # 强制将http重定向到https</span><br><span class="line">    # 在错误页面和“服务器”响应头字段中启用或禁用发射nginx版本。 防止黑客利用版本漏洞攻击</span><br><span class="line">    server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-7-两个虚拟主机"><a href="#10-7-两个虚拟主机" class="headerlink" title="10.7 两个虚拟主机"></a>10.7 两个虚拟主机</h3><ul>
<li>纯静态<code>-html</code> 支持</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain1.com;</span><br><span class="line">        access_log      logs/domain1.access.log main;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  /var/www/domain1.com/htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain2.com;</span><br><span class="line">        access_log      logs/domain2.access.log main;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  /var/www/domain2.com/htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-8-虚拟主机标准配置"><a href="#10-8-虚拟主机标准配置" class="headerlink" title="10.8 虚拟主机标准配置"></a>10.8 虚拟主机标准配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen          80 default;</span><br><span class="line">    server_name     _ *;</span><br><span class="line">    access_log      logs/default.access.log main;</span><br><span class="line">    location / &#123;</span><br><span class="line">       index index.html;</span><br><span class="line">       root  /var/www/default/htdocs;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-9-防盗链"><a href="#10-9-防盗链" class="headerlink" title="10.9 防盗链"></a>10.9 防盗链</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">   root html</span><br><span class="line">   valid_referers none blocked *.nginxcn.com;</span><br><span class="line">   if ($invalid_referer) &#123;</span><br><span class="line">     rewrite ^/ www.nginx.cn</span><br><span class="line">     #return 404;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-10虚拟目录配置"><a href="#10-10虚拟目录配置" class="headerlink" title="10.10虚拟目录配置"></a>10.10虚拟目录配置</h3><p>alias指定的目录是准确的，root是指定目录的上级目录，并且该上级目录要含有location指定名称的同名目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /img/ &#123;</span><br><span class="line">    alias /var/www/image/;</span><br><span class="line">&#125;</span><br><span class="line"># 访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</span><br><span class="line">location /img/ &#123;</span><br><span class="line">    root /var/www/image;</span><br><span class="line">&#125;</span><br><span class="line"># 访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件。]</span><br></pre></td></tr></table></figure>

<h3 id="10-11-防盗图配置"><a href="#10-11-防盗图配置" class="headerlink" title="10.11 防盗图配置"></a>10.11 防盗图配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ \/public\/(css|js|img)\/.*\.(js|css|gif|jpg|jpeg|png|bmp|swf) &#123;</span><br><span class="line">    valid_referers none blocked *.jslite.io;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        rewrite ^/  http://wangchujiang.com/piratesp.png;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-12-屏蔽-git等文件"><a href="#10-12-屏蔽-git等文件" class="headerlink" title="10.12 屏蔽.git等文件"></a>10.12 屏蔽.git等文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ (.git|.gitattributes|.gitignore|.svn) &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="域名路径加不加需要都能正常访问"><a href="#域名路径加不加需要都能正常访问" class="headerlink" title="域名路径加不加需要都能正常访问"></a>域名路径加不加需要都能正常访问</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://wangchujiang.com/api/index.php?a=1&amp;name=wcj</span><br><span class="line">                                  ^ 有后缀</span><br><span class="line"></span><br><span class="line">http://wangchujiang.com/api/index?a=1&amp;name=wcj</span><br><span class="line">                                 ^ 没有后缀</span><br></pre></td></tr></table></figure>

<ul>
<li><code>nginx rewrite</code>规则如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^/(.*)/$ /index.php?/$1 permanent;</span><br><span class="line">if (!-d $request_filename)&#123;</span><br><span class="line">        set $rule_1 1$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">        set $rule_1 2$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if ($rule_1 = &quot;21&quot;)&#123;</span><br><span class="line">        rewrite ^/ /index.php last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="十一、错误问题"><a href="#十一、错误问题" class="headerlink" title="十一、错误问题"></a>十一、错误问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The plain HTTP request was sent to HTTPS port</span><br></pre></td></tr></table></figure>

<ul>
<li>解决办法，<code>fastcgi_param HTTPS $https if_not_empty</code> 添加这条规则，</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl; # 注意这条规则</span><br><span class="line">    server_name  my.domain.com;</span><br><span class="line">    </span><br><span class="line">    fastcgi_param HTTPS $https if_not_empty;</span><br><span class="line">    fastcgi_param HTTPS on;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/ssl/certs/your.pem;</span><br><span class="line">    ssl_certificate_key /etc/ssl/private/your.key;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        # Your config here...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="十二、精品文章参考"><a href="#十二、精品文章参考" class="headerlink" title="十二、精品文章参考"></a>十二、精品文章参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/u/3341316/blog/877206">负载均衡原理的解析</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.githuber.cn/posts/73">Nginx泛域名解析，实现多个二级域名</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">深入 NGINX: 我们如何设计性能和扩展</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">Inside NGINX: How We Designed for Performance &amp; Scale</a></li>
<li><a target="_blank" rel="noopener" href="http://tengine.taobao.org/book/index.html">Nginx开发从入门到精通</a></li>
<li><a target="_blank" rel="noopener" href="http://os.51cto.com/art/201703/535326.htm#topx">Nginx的优化与防盗链</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009769143">实战开发一个Nginx扩展 (Nginx Module)</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/xshuai/blog/917097">Nginx+Keepalived(双机热备)搭建高可用负载均衡环境(HA)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.huxd.org/articles/2017/07/24/1500890692329.html">Nginx 平滑升级</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIxNzg5ODE0OA==&mid=2247483708&idx=1&sn=90b0b1dccd9c337922a0588245277666&chksm=97f38cf7a08405e1928e0b46d923d630e529e7db8ac7ca2a91310a075986f8bcb2cee5b4953d#rd">Nginx最新模块—ngx_http_mirror_module分析可以做版本发布前的预先验证，进行流量放大后的压测等等</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/30/%E9%83%A8%E7%BD%B2/Nginx%E5%AD%A6%E4%B9%A0/" data-id="cl7icg7b100wcugunhc213ujq" data-title="Nginx学习" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-nodejs/nodejs-koa2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/06/27/nodejs/nodejs-koa2/" class="article-date">
  <time class="dt-published" datetime="2019-06-27T01:27:18.000Z" itemprop="datePublished">2019-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>►<a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/06/27/nodejs/nodejs-koa2/">node-koa2总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、Koa框架介绍以及Koa环境搭建"><a href="#一、Koa框架介绍以及Koa环境搭建" class="headerlink" title="一、Koa框架介绍以及Koa环境搭建"></a>一、Koa框架介绍以及Koa环境搭建</h1><h2 id="1-1-Koa-框架介绍"><a href="#1-1-Koa-框架介绍" class="headerlink" title="1.1 Koa 框架介绍"></a>1.1 Koa 框架介绍</h2><blockquote>
<p><code>Node.js</code> 是一个异步的世界，官方 <code>API</code> 支持的都是 <code>callback</code> 形式的异步编程模型，这 会带来许多问题，例如:</p>
</blockquote>
<ol>
<li><code>callback</code> 嵌套问题</li>
<li>异步函数中可能同步调用 callback 返回 数据，带来不一致性。为了解决以上问题 <code>Koa</code> 出现了</li>
</ol>
<p><strong>Koa – 基于 Node.js 平台的下一代 web 开发框架</strong></p>
<blockquote>
<p><code>koa</code> 是由 <code>Express</code> 原班人马打造的，致力于成为一个更小、更富有表现力、更健壮的 Web 框架。 使用 <code>koa</code> 编写 <code>web</code> 应用，可以免除重复繁琐的回调函数嵌套， 并极大地提 升错误处理的效率。<code>koa</code>不在内核方法中绑定任何中间件， 它仅仅提供了一个轻量优雅的 函数库，使得编写 Web 应用变得得心应手。开发思路和 express 差不多，最大的特点就是 可以避免异步嵌套</p>
</blockquote>
<h2 id="1-2-Koa2-x-框架的安装使用"><a href="#1-2-Koa2-x-框架的安装使用" class="headerlink" title="1.2 Koa2.x 框架的安装使用"></a>1.2 Koa2.x 框架的安装使用</h2><p><strong>1. 安装 Node.js 8.x 以上的版本</strong></p>
<blockquote>
<p>开发 <code>Koa2</code> 之前，<code>Node.js</code> 是有要求的，它要求 <code>Node.js</code> 版本高于 <code>V7.6</code>。因为 <code>node.js 7.6</code>版本 开始完全支持 <code>async/await</code>，所以才能完全你支持我们的 Koa2&#96;</p>
</blockquote>
<p><strong>2. 安装 Koa</strong></p>
<blockquote>
<p>安装 <code>Koa</code> 框架和我们以前安装其他模块是一样的</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save koa / cnpm install --save koa</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>--save</code> 参数，表示自动修改 <code>package.json</code> 文件，自动添加依赖项</p>
</blockquote>
<p><strong>简单使用</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/494.png" alt="img"></p>
<h1 id="二、koa-路由-get传值、动态路由"><a href="#二、koa-路由-get传值、动态路由" class="headerlink" title="二、koa 路由 get传值、动态路由"></a>二、koa 路由 get传值、动态路由</h1><h2 id="2-1-Koa-路由"><a href="#2-1-Koa-路由" class="headerlink" title="2.1 Koa 路由"></a>2.1 Koa 路由</h2><ul>
<li>路由(<code>Routing</code>)是由一个 <code>URI</code>(或者叫路径)和一个特定的 <code>HTTP</code> 方法(<code>GET</code>、<code>POST</code>等)<br>组成的，涉及到应用如何响应客户端对某个网站节点的访问</li>
<li>通俗的讲:路由就是根据不同的 <code>URL</code> 地址，加载不同的页面实现不同的功能</li>
<li><code>Koa</code> 中的路由和 <code>Express</code> 有所不同，在 <code>Express</code> 中直接引入 <code>Express</code> 就可以配置路由，但是在 <code>Koa</code>中我们需要安装对应的 <code>koa-router</code> 路由模块来实现</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save koa-router</span><br></pre></td></tr></table></figure>

<p><img src="https://poetries1.gitee.io/img-repo/2019/10/495.png" alt="img"></p>
<h2 id="2-2-Koa-路由-get-传值"><a href="#2-2-Koa-路由-get-传值" class="headerlink" title="2.2 Koa 路由 get 传值"></a>2.2 Koa 路由 get 传值</h2><blockquote>
<p>在 <code>koa2</code> 中 <code>GET</code> 传值通过 <code>request</code> 接收，但是接收的方法有两种:<code>query</code> 和 <code>querystring</code></p>
</blockquote>
<ul>
<li><code>query</code>:返回的是格式化好的参数对象。</li>
<li><code>querystring</code>:返回的是请求字符串</li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/496.png" alt="img"></p>
<h2 id="2-3-Koa-动态路由"><a href="#2-3-Koa-动态路由" class="headerlink" title="2.3 Koa 动态路由"></a>2.3 Koa 动态路由</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/497.png" alt="img"></p>
<h1 id="三、koa-中间件及执行流程"><a href="#三、koa-中间件及执行流程" class="headerlink" title="三、koa 中间件及执行流程"></a>三、koa 中间件及执行流程</h1><h2 id="3-1-koa中间件的洋葱图执行流程"><a href="#3-1-koa中间件的洋葱图执行流程" class="headerlink" title="3.1 koa中间件的洋葱图执行流程"></a>3.1 koa中间件的洋葱图执行流程</h2><p><img src="https://poetries1.gitee.io/img-repo/2019/10/498.gif" alt="img"></p>
<h2 id="3-2-koa-中间件"><a href="#3-2-koa-中间件" class="headerlink" title="3.2 koa 中间件"></a>3.2 koa 中间件</h2><h3 id="3-2-1-什么是-Koa-的中间件"><a href="#3-2-1-什么是-Koa-的中间件" class="headerlink" title="3.2.1 什么是 Koa 的中间件"></a>3.2.1 什么是 Koa 的中间件</h3><ul>
<li>通俗的讲:中间件就是匹配路由之前或者匹配路由完成做的一系列的操作，我们就可以<br>把它叫做中间件</li>
<li>在<code>express</code>中间件(<code>Middleware</code>)是一个函数，它可以访问请求对象(request object (req)), 响应对象(<code>response object (res)</code>), 和 <code>web</code> 应用中处理请求-响应循环流程中的中间件，一 般被命名为 next 的变量。在 <code>Koa</code> 中中间件和 <code>express</code> 有点类似。</li>
</ul>
<p><strong>中间件的功能包括</strong></p>
<ul>
<li>执行任何代码</li>
<li>修改请求和响应对象</li>
<li>终结请求-响应循环</li>
<li>调用堆栈中的下一个中间件</li>
</ul>
<blockquote>
<p>如果我的 <code>get</code>、<code>post</code> 回调函数中，没有 <code>next</code> 参数，那么就匹配上第一个路由，就不会往下匹 配了。如果想往下匹配的话，那么需要写 <code>next()</code></p>
</blockquote>
<h3 id="3-2-2-Koa-应用可使用如下几种中间件"><a href="#3-2-2-Koa-应用可使用如下几种中间件" class="headerlink" title="3.2.2 Koa 应用可使用如下几种中间件"></a>3.2.2 Koa 应用可使用如下几种中间件</h3><p><strong>1. 应用级中间件</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/499.png" alt="img"></p>
<p><strong>2. 路由中间件</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/500.png" alt="img"></p>
<p><strong>3. 错误处理中间件</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/501.png" alt="img"></p>
<p><strong>4. 第三方中间件</strong></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/502.png" alt="img"></p>
<h3 id="3-2-3-Koa-中间件的执行顺序"><a href="#3-2-3-Koa-中间件的执行顺序" class="headerlink" title="3.2.3 Koa 中间件的执行顺序"></a>3.2.3 Koa 中间件的执行顺序</h3><blockquote>
<p><code>Koa</code> 的中间件和 <code>Express</code> 不同，<code>Koa</code> 选择了洋葱圈模型</p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/503.png" alt="img"></p>
<h1 id="四、koa-ejs模板引擎使用-以及ejs配置全局数据"><a href="#四、koa-ejs模板引擎使用-以及ejs配置全局数据" class="headerlink" title="四、koa ejs模板引擎使用 以及ejs配置全局数据"></a>四、koa ejs模板引擎使用 以及ejs配置全局数据</h1><p><strong>1. 安装 koa-views 和 ejs</strong></p>
<ul>
<li>安装 <code>koa-views npm install --save koa-views / cnpm install --save koa-views</code></li>
<li>安装 <code>ejs npm install ejs --save / cnpm install ejs --save</code></li>
</ul>
<p><strong>2. 引入 koa-views 配置中间件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const views = require(&#x27;koa-views&#x27;);</span><br><span class="line"></span><br><span class="line">app.use(views(&#x27;views&#x27;, &#123; map: &#123;html: &#x27;ejs&#x27; &#125;&#125;));</span><br></pre></td></tr></table></figure>

<p><strong>3. Koa 中使用 ejs</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">router.get(&#x27;/add&#x27;,async (ctx)=&gt;&#123; </span><br><span class="line">    let title = &#x27;hello koa2&#x27; </span><br><span class="line">    </span><br><span class="line">    await ctx.render(index&#x27;,&#123; title &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>4. Ejs 引入模板</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- include header.ejs %&gt;</span><br></pre></td></tr></table></figure>

<p><strong>5. Ejs 绑定数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=h%&gt;</span><br></pre></td></tr></table></figure>

<p><strong>6. Ejs 绑定 html 数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%-h%&gt;</span><br></pre></td></tr></table></figure>

<p><strong>7. Ejs 模板判断语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if(true)&#123; %&gt;</span><br><span class="line">    &lt;div&gt;true&lt;/div&gt;</span><br><span class="line">&lt;%&#125; else&#123; %&gt;</span><br><span class="line">    &lt;div&gt;false&lt;/div&gt;</span><br><span class="line">&lt;%&#125; %&gt;</span><br></pre></td></tr></table></figure>

<p><strong>8. Ejs 模板中循环数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%for(var i=0;i&lt;list.length;i++) &#123; %&gt;</span><br><span class="line">    &lt;li&gt;&lt;%=list[i] %&gt;&lt;/li&gt;</span><br><span class="line">&lt;%&#125;%&gt;</span><br></pre></td></tr></table></figure>

<h1 id="五、koa-post-提交数据-koa-bodyparser-中间件的使用"><a href="#五、koa-post-提交数据-koa-bodyparser-中间件的使用" class="headerlink" title="五、koa post 提交数据 koa-bodyparser 中间件的使用"></a>五、koa post 提交数据 koa-bodyparser 中间件的使用</h1><h2 id="5-1-原生-Nodejs-获取-post-提交数据"><a href="#5-1-原生-Nodejs-获取-post-提交数据" class="headerlink" title="5.1 原生 Nodejs 获取 post 提交数据"></a>5.1 原生 Nodejs 获取 post 提交数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function parsePostData(ctx)&#123;</span><br><span class="line">    return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            let postdata=&quot;&quot;;</span><br><span class="line">            ctx.req.on(&#x27;data&#x27;,(data)=&gt;&#123;</span><br><span class="line">                postdata += data</span><br><span class="line">            &#125;)</span><br><span class="line">            ctx.req.on(&quot;end&quot;,function()&#123;</span><br><span class="line">                resolve(postdata);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;catch(error)&#123;</span><br><span class="line">            reject(error);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-2-Koa-中-koa-bodyparser-中间件的使用"><a href="#5-2-Koa-中-koa-bodyparser-中间件的使用" class="headerlink" title="5.2 Koa 中 koa-bodyparser 中间件的使用"></a>5.2 Koa 中 koa-bodyparser 中间件的使用</h2><p><strong>1. 安装 koa-bodyparser</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save koa-bodyparser</span><br></pre></td></tr></table></figure>

<p><strong>2. 安装 引入配置中间件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var Koa = require(&#x27;koa&#x27;);</span><br><span class="line">var bodyParser = require(&#x27;koa-bodyparser&#x27;);</span><br><span class="line"></span><br><span class="line">var app = new Koa();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line">app.use(async ctx =&gt; &#123;</span><br><span class="line">    ctx.body = ctx.request.body;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>3. 使用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.request.body // 获取 post 提交的数据</span><br></pre></td></tr></table></figure>

<h1 id="六、koa-static静态资源中间件"><a href="#六、koa-static静态资源中间件" class="headerlink" title="六、koa-static静态资源中间件"></a>六、koa-static静态资源中间件</h1><p><strong>1. 安装 koa-static</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save koa-static</span><br></pre></td></tr></table></figure>

<p><strong>2. 引入配置中间件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const static = require(&#x27;koa-static&#x27;);</span><br><span class="line"></span><br><span class="line">app.use(static(</span><br><span class="line">    path.join( __dirname, &#x27;public&#x27;)</span><br><span class="line">))</span><br></pre></td></tr></table></figure>

<h1 id="七、koa-art-template高性能模板引擎的使用"><a href="#七、koa-art-template高性能模板引擎的使用" class="headerlink" title="七、koa art-template高性能模板引擎的使用"></a>七、koa art-template高性能模板引擎的使用</h1><h2 id="7-1-常见模板引擎的性能对比"><a href="#7-1-常见模板引擎的性能对比" class="headerlink" title="7.1 常见模板引擎的性能对比"></a>7.1 常见模板引擎的性能对比</h2><blockquote>
<p>适用于 <code>koa</code> 的模板引擎选择非常多，比如 <code>jade</code>、<code>ejs</code>、<code>nunjucks</code>、<code>art-template</code> 等</p>
</blockquote>
<ul>
<li><code>art-template</code> 是一个简约、超快的模板引擎</li>
<li>它采用作用域预声明的技术来优化模板渲染速度，从而获得接近 JavaScript 极限的运行 性能，并且同时支持 NodeJS 和浏览器。</li>
<li><code>art-template</code> 支持 <code>ejs</code> 的语法，也可以用自己的类似 <code>angular</code> 数据绑定的语法</li>
<li>中文文档: <a target="_blank" rel="noopener" href="http://aui.github.io/art-template/zh-cn/docs">http://aui.github.io/art-template/zh-cn/docs</a></li>
</ul>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/504.png" alt="img"></p>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/505.png" alt="img"></p>
<h2 id="7-2-在-Koa-中使用-art-template-模板引擎"><a href="#7-2-在-Koa-中使用-art-template-模板引擎" class="headerlink" title="7.2 在 Koa 中使用 art-template 模板引擎"></a>7.2 在 Koa 中使用 art-template 模板引擎</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">npm install --save art-template </span><br><span class="line">npm install --save koa-art-template</span><br><span class="line">const Koa = require(&#x27;koa&#x27;);</span><br><span class="line">const render = require(&#x27;koa-art-template&#x27;);</span><br><span class="line"></span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">render(app, &#123;</span><br><span class="line">    root: path.join(__dirname, &#x27;view&#x27;),</span><br><span class="line">    extname: &#x27;.art&#x27;,</span><br><span class="line">    debug: process.env.NODE_ENV !== &#x27;production&#x27;</span><br><span class="line">&#125;);</span><br><span class="line">app.use(async function (ctx) &#123;</span><br><span class="line">    await ctx.render(&#x27;user&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(8080);</span><br></pre></td></tr></table></figure>

<h2 id="7-3-art-template-模板引擎语法"><a href="#7-3-art-template-模板引擎语法" class="headerlink" title="7.3 art-template 模板引擎语法"></a>7.3 art-template 模板引擎语法</h2><blockquote>
<p>参考:<a target="_blank" rel="noopener" href="http://aui.github.io/art-template/zh-cn/docs/syntax.html">http://aui.github.io/art-template/zh-cn/docs/syntax.html</a></p>
</blockquote>
<h1 id="八、koa-Cookie的使用"><a href="#八、koa-Cookie的使用" class="headerlink" title="八、koa Cookie的使用"></a>八、koa Cookie的使用</h1><h2 id="8-1-Koa-Cookie-的使用"><a href="#8-1-Koa-Cookie-的使用" class="headerlink" title="8.1 Koa Cookie 的使用"></a>8.1 Koa Cookie 的使用</h2><p><strong>1. Koa 中设置 Cookie 的值</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.cookies.set(name, value, [options])</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 <code>options</code> 设置 <code>cookie name</code> 的 <code>value</code></p>
</blockquote>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/506.png" alt="img"></p>
<p><strong>2. Koa 中获取 Cookie 的值</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.cookies.get(&#x27;name&#x27;);</span><br></pre></td></tr></table></figure>

<h2 id="8-2-Koa-中设置中文-Cookie"><a href="#8-2-Koa-中设置中文-Cookie" class="headerlink" title="8.2 Koa 中设置中文 Cookie"></a>8.2 Koa 中设置中文 Cookie</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">console.log(new Buffer(&#x27;hello, world!&#x27;).toString(&#x27;base64&#x27;));// 转换成 base64 字符 串:aGVsbG8sIHdvcmxkIQ==</span><br><span class="line"></span><br><span class="line">console.log(new Buffer(&#x27;aGVsbG8sIHdvcmxkIQ==&#x27;, &#x27;base64&#x27;).toString());// 还原 base 64 字符串:hello, world!</span><br></pre></td></tr></table></figure>

<h1 id="九、koa-Session-的使用"><a href="#九、koa-Session-的使用" class="headerlink" title="九、koa Session 的使用"></a>九、koa Session 的使用</h1><h2 id="9-1-Session-简单介绍"><a href="#9-1-Session-简单介绍" class="headerlink" title="9.1 Session 简单介绍"></a>9.1 Session 简单介绍</h2><blockquote>
<p><code>session</code> 是另一种记录客户状态的机制，不同的是 <code>Cookie</code> 保存在客户端浏览器中，而 <code>session</code> 保存在服务器上</p>
</blockquote>
<h2 id="9-2-Session-的工作流程"><a href="#9-2-Session-的工作流程" class="headerlink" title="9.2 Session 的工作流程"></a>9.2 Session 的工作流程</h2><blockquote>
<p>当浏览器访问服务器并发送第一次请求时，服务器端会创建一个 <code>session</code> 对象，生 成一个类似于 <code>key</code>,<code>value</code> 的键值对， 然后将<code>key(cookie)</code>返回到浏览器(客户)端，浏览 器下次再访问时，携带 <code>key(cookie)</code>，找到对应的 <code>session(value)</code>。 客户的信息都保存 在 <code>session</code> 中</p>
</blockquote>
<h2 id="9-3-koa-session-的使用"><a href="#9-3-koa-session-的使用" class="headerlink" title="9.3 koa-session 的使用"></a>9.3 koa-session 的使用</h2><p><strong>1. 安装 express-session</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-session --save</span><br></pre></td></tr></table></figure>

<p><strong>2. 引入 express-session</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const session = require(&#x27;koa-session&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>3. 设置官方文档提供的中间件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.keys = [&#x27;some secret hurr&#x27;];</span><br><span class="line">const CONFIG = &#123;</span><br><span class="line">    key: &#x27;koa:sess&#x27;, //cookie key (default is koa:sess)</span><br><span class="line">    maxAge: 86400000, // cookie 的过期时间 maxAge in ms (default is 1 days)</span><br><span class="line">    overwrite: true, //是否可以 overwrite (默认 default true)</span><br><span class="line">    httpOnly: true, //cookie 是否只有服务器端可以访问 httpOnly or not (default true)</span><br><span class="line">    signed: true, //签名默认 true</span><br><span class="line">    rolling:false, //在每次请求时强行设置cookie，这将重置cookie过期时间(默认:false)</span><br><span class="line">    renew: false, //(boolean) renew session when session is nearly expired</span><br><span class="line">&#125;</span><br><span class="line">app.use(session(CONFIG, app));</span><br></pre></td></tr></table></figure>

<p><strong>4. 使用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//设置值 </span><br><span class="line">ctx.session.username = &quot;张三&quot;;</span><br><span class="line"></span><br><span class="line">// 获取值 </span><br><span class="line">ctx.session.username</span><br></pre></td></tr></table></figure>

<h2 id="9-4-Cookie-和-Session-区别"><a href="#9-4-Cookie-和-Session-区别" class="headerlink" title="9.4 Cookie 和 Session 区别"></a>9.4 Cookie 和 Session 区别</h2><ul>
<li><code>cookie</code> 数据存放在客户的浏览器上，<code>session</code> 数据放在服务器上</li>
<li><code>cookie</code> 不是很安全，别人可以分析存放在本地的 <code>COOKIE</code> 并进行 <code>COOKIE</code> 欺骗 考虑到安全应当使用 <code>session</code></li>
<li><code>session</code>会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能 考虑到减轻服务器性能方面，应当使用 <code>COOKIE</code></li>
<li>单个 <code>cookie</code> 保存的数据不能超过 <code>4K</code>，很多浏览器都限制一个站点最多保存 <code>20</code> 个 <code>cookie</code></li>
</ul>
<h1 id="十、Koa-操作-Mongodb-数据库"><a href="#十、Koa-操作-Mongodb-数据库" class="headerlink" title="十、Koa 操作 Mongodb 数据库"></a>十、Koa 操作 Mongodb 数据库</h1><blockquote>
<p>官方文档:<a target="_blank" rel="noopener" href="http://mongodb.github.io/node-mongodb-native/">http://mongodb.github.io/node-mongodb-native/</a></p>
</blockquote>
<h1 id="十一、Koa-应用生成器以及-Koa-路由模-块化"><a href="#十一、Koa-应用生成器以及-Koa-路由模-块化" class="headerlink" title="十一、Koa 应用生成器以及 Koa 路由模 块化"></a>十一、Koa 应用生成器以及 Koa 路由模 块化</h1><h2 id="11-1-koa-应用生成器"><a href="#11-1-koa-应用生成器" class="headerlink" title="11.1 koa 应用生成器"></a>11.1 koa 应用生成器</h2><blockquote>
<p>通过应用 <code>koa</code> 脚手架生成工具 可以快速创建一个基于 <code>koa2</code> 的应用的骨架</p>
</blockquote>
<p><strong>1. 全局安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-generator -g</span><br></pre></td></tr></table></figure>

<p><strong>2. 创建项目</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">koa koa_demo</span><br></pre></td></tr></table></figure>

<p><strong>3. 安装依赖</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd koa_demo</span><br><span class="line"></span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p><strong>4. 启动项目</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure>

<h2 id="11-2-koa-搭建模块化路由-x2F-层级路由"><a href="#11-2-koa-搭建模块化路由-x2F-层级路由" class="headerlink" title="11.2 koa 搭建模块化路由&#x2F;层级路由"></a>11.2 koa 搭建模块化路由&#x2F;层级路由</h2><ol>
<li>在目录下面新建一个文件夹 <code>routes</code></li>
<li>在 <code>routes</code> 里面配置对应的子页面</li>
<li>比如在 <code>routes</code> 新建 <code>index.js</code></li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/507.png" alt="img"></p>
<ol>
<li>然后在主应用中加载子路由模块:</li>
</ol>
<p><img src="https://poetries1.gitee.io/img-repo/2019/10/508.png" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/27/nodejs/nodejs-koa2/" data-id="cl7icg76200qyuguncy1whm2p" data-title="node-koa2总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-nodejs/express" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/06/07/nodejs/express/" class="article-date">
  <time class="dt-published" datetime="2019-06-06T18:16:34.000Z" itemprop="datePublished">2019-06-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>►<a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/%E6%A1%86%E6%9E%B6/">框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/06/07/nodejs/express/">node-express框架总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><blockquote>
<p>官网 <a target="_blank" rel="noopener" href="http://expressjs.com/zh-cn/">http://expressjs.com/zh-cn/</a></p>
</blockquote>
<blockquote>
<p><code>Express</code>是目前最流行的基于Node.js的Web开发框架，可以快速地搭建一个完整功能的网站</p>
</blockquote>
<p><strong>环境搭建</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://www.expressjs.com.cn/starter/generator.html">http://www.expressjs.com.cn/starter/generator.html</a></p>
</blockquote>
<blockquote>
<p>通过应用生成器工具 <code>express-generator</code>可以快速创建一个应用的骨架</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install express-generator -g</span><br></pre></td></tr></table></figure>

<h2 id="二、运行原理"><a href="#二、运行原理" class="headerlink" title="二、运行原理"></a>二、运行原理</h2><p><strong>底层：http模块</strong></p>
<blockquote>
<p>Express框架建立在node.js内置的http模块上。http模块生成服务器的原始代码如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = http.createServer(function(request, response) &#123;</span><br><span class="line">  response.writeHead(200, &#123;&quot;Content-Type&quot;: &quot;text/plain&quot;&#125;);</span><br><span class="line">  response.end(&quot;Hello world!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000, &quot;localhost&quot;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Express框架的核心是对http模块的再包装。上面的代码用Express改写如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function (req, res) &#123;</span><br><span class="line">  res.send(&#x27;Hello world!&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Express框架等于在http模块之上，加了一个中间层</p>
</blockquote>
<p><strong>什么是中间件</strong></p>
<blockquote>
<ul>
<li>简单说，中间件（middleware）就是处理HTTP请求的函数。它最大的特点就是，一个中间件处理完，再传递给下一个中间件。App实例在运行过程中，会调用一系列的中间件</li>
<li>每个中间件可以从App实例，接收三个参数，依次为request对象（代表HTTP请求）、response对象（代表HTTP回应），next回调函数（代表下一个中间件）。每个中间件都可以对HTTP请求（request对象）进行加工，并且决定是否调用next方法，将request对象再传给下一个中间件。</li>
</ul>
</blockquote>
<ul>
<li>一个不进行任何操作、只传递<code>request</code>对象的中间件，就是下面这样</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function uselessMiddleware(req, res, next) &#123;</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码的next就是下一个中间件。如果它带有参数，则代表抛出一个错误，参数为错误文本</li>
<li>抛出错误以后，后面的中间件将不再执行，直到发现一个错误处理函数为止</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function uselessMiddleware(req, res, next) &#123;</span><br><span class="line">  next(&#x27;出错了！&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、use方法"><a href="#三、use方法" class="headerlink" title="三、use方法"></a>三、use方法</h2><blockquote>
<p>use是express注册中间件的方法，它返回一个函数。下面是一个连续调用两个中间件的例子</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(request, response, next) &#123;</span><br><span class="line">  console.log(&quot;In comes a &quot; + request.method + &quot; to &quot; + request.url);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;Hello world!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码使用app.use方法，注册了两个中间件。收到HTTP请求后，先调用第一个中间件，在控制台输出一行信息，然后通过next方法，将执行权传给第二个中间件，输出HTTP回应。由于第二个中间件没有调用next方法，所以request对象就不再向后传递了</p>
</blockquote>
<ul>
<li>use方法内部可以对访问路径进行判断，据此就能实现简单的路由，根据不同的请求网址，返回不同的网页内容</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(function(request, response, next) &#123;</span><br><span class="line">  if (request.url == &quot;/&quot;) &#123;</span><br><span class="line">    response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">    response.end(&quot;Welcome to the homepage!\n&quot;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response, next) &#123;</span><br><span class="line">  if (request.url == &quot;/about&quot;) &#123;</span><br><span class="line">    response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response) &#123;</span><br><span class="line">  response.writeHead(404, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;404 error!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码通过<code>request.url</code>属性，判断请求的网址，从而返回不同的内容。注意，<code>app.use</code>方法一共登记了三个中间件，只要请求路径匹配，就不会将执行权交给下一个中间件。因此，最后一个中间件会返回<code>404</code>错误，即前面的中间件都没匹配请求路径，找不到所要请求的资源</p>
</blockquote>
<ul>
<li>除了在回调函数内部判断请求的网址，<code>use</code>方法也允许将请求网址写在第一个参数。这代表，只有请求路径匹配这个参数，后面的中间件才会生效。无疑，这样写更加清晰和方便</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 只对根目录的请求，调用某个中间件</span><br><span class="line">app.use(&#x27;/path&#x27;, someMiddleware);</span><br></pre></td></tr></table></figure>

<ul>
<li>因此，上面的代码可以写成下面的样子</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ar express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.use(&quot;/home&quot;, function(request, response, next) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;Welcome to the homepage!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&quot;/about&quot;, function(request, response, next) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;Welcome to the about page!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(function(request, response) &#123;</span><br><span class="line">  response.writeHead(404, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  response.end(&quot;404 error!\n&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337)</span><br></pre></td></tr></table></figure>

<h2 id="四、Express的方法"><a href="#四、Express的方法" class="headerlink" title="四、Express的方法"></a>四、Express的方法</h2><p><strong>all方法和HTTP动词方法</strong></p>
<blockquote>
<p>针对不同的请求，Express提供了use方法的一些别名。比如，上面代码也可以用别名的形式来写</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&quot;express&quot;);</span><br><span class="line">var http = require(&quot;http&quot;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.all(&quot;*&quot;, function(request, response, next) &#123;</span><br><span class="line">  response.writeHead(200, &#123; &quot;Content-Type&quot;: &quot;text/plain&quot; &#125;);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/&quot;, function(request, response) &#123;</span><br><span class="line">  response.end(&quot;Welcome to the homepage!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;/about&quot;, function(request, response) &#123;</span><br><span class="line">  response.end(&quot;Welcome to the about page!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&quot;*&quot;, function(request, response) &#123;</span><br><span class="line">  response.end(&quot;404!&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(1337);</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>上面代码的all方法表示，所有请求都必须通过该中间件，参数中的“*”表示对所有路径有效。get方法则是只有GET动词的HTTP请求通过该中间件，它的第一个参数是请求的路径。由于get方法的回调函数没有调用next方法，所以只要有一个中间件被调用了，后面的中间件就不会再被调用了</li>
<li>除了get方法以外，Express还提供post、put、delete方法，即HTTP动词都是Express的方法</li>
</ul>
</blockquote>
<ul>
<li>除了get方法以外，Express还提供post、put、delete方法，即HTTP动词都是Express的方法</li>
<li>这些方法的第一个参数，都是请求的路径。除了绝对匹配以外，Express允许模式匹配</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(&quot;/hello/:who&quot;, function(req, res) &#123;</span><br><span class="line">  res.end(&quot;Hello, &quot; + req.params.who + &quot;.&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="五、set方法"><a href="#五、set方法" class="headerlink" title="五、set方法"></a>五、set方法</h2><blockquote>
<p>set方法用于指定变量的值</p>
</blockquote>
<ul>
<li><p>使用set方法，为系统变量“views”和“view engine”指定值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.set(&quot;views&quot;, __dirname + &quot;/views&quot;);</span><br><span class="line"></span><br><span class="line">app.set(&quot;view engine&quot;, &quot;jade&quot;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="六、response对象"><a href="#六、response对象" class="headerlink" title="六、response对象"></a>六、response对象</h2><p><strong>（1）response.redirect方法</strong></p>
<blockquote>
<p>response.redirect方法允许网址的重定向</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response.redirect(&quot;/hello/anime&quot;);</span><br><span class="line">response.redirect(&quot;http://www.example.com&quot;);</span><br><span class="line">response.redirect(301, &quot;http://www.example.com&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>（2）response.sendFile方法</strong></p>
<blockquote>
<p>response.sendFile方法用于发送文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.sendFile(&quot;/path/to/anime.mp4&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>（3）response.render方法</strong></p>
<blockquote>
<p>response.render方法用于渲染网页模板。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//  使用render方法，将message变量传入index模板，渲染成HTML网页</span><br><span class="line">app.get(&quot;/&quot;, function(request, response) &#123;</span><br><span class="line">  response.render(&quot;index&quot;, &#123; message: &quot;Hello World&quot; &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="七、requst对象"><a href="#七、requst对象" class="headerlink" title="七、requst对象"></a>七、requst对象</h2><p><strong>（1）request.ip</strong></p>
<blockquote>
<p>request.ip属性用于获得HTTP请求的IP地址</p>
</blockquote>
<p><strong>（2）request.files</strong></p>
<blockquote>
<p>request.files用于获取上传的文件</p>
</blockquote>
<h2 id="八、搭建HTTPs服务器"><a href="#八、搭建HTTPs服务器" class="headerlink" title="八、搭建HTTPs服务器"></a>八、搭建HTTPs服务器</h2><blockquote>
<p>使用Express搭建HTTPs加密服务器，也很简单</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&#x27;fs&#x27;);</span><br><span class="line">var options = &#123;</span><br><span class="line">  key: fs.readFileSync(&#x27;E:/ssl/myserver.key&#x27;),</span><br><span class="line">  cert: fs.readFileSync(&#x27;E:/ssl/myserver.crt&#x27;),</span><br><span class="line">  passphrase: &#x27;1234&#x27;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var https = require(&#x27;https&#x27;);</span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function(req, res)&#123;</span><br><span class="line">  res.send(&#x27;Hello World Expressjs&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var server = https.createServer(options, app);</span><br><span class="line">server.listen(8084);</span><br><span class="line">console.log(&#x27;Server is running on port 8084&#x27;);</span><br></pre></td></tr></table></figure>

<h2 id="九、静态网页模板"><a href="#九、静态网页模板" class="headerlink" title="九、静态网页模板"></a>九、静态网页模板</h2><blockquote>
<ul>
<li>在项目目录之中，建立一个子目录views，用于存放网页模板</li>
<li>假定这个项目有三个路径：根路径（&#x2F;）、自我介绍（&#x2F;about）和文章（&#x2F;article）。那么，app.js可以这样写</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 向服务器发送信息的方法，从send变成了sendfile，后者专门用于发送文件</span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">   res.sendfile(&#x27;./views/index.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">   res.sendfile(&#x27;./views/about.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/article&#x27;, function(req, res) &#123;</span><br><span class="line">   res.sendfile(&#x27;./views/article.html&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<h2 id="十、动态网页模板"><a href="#十、动态网页模板" class="headerlink" title="十、动态网页模板"></a>十、动态网页模板</h2><p><strong>安装模板引擎</strong></p>
<blockquote>
<p>Express支持多种模板引擎，这里采用Handlebars模板引擎的服务器端版本hbs模板引擎</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hbs --save-dev</span><br></pre></td></tr></table></figure>

<ul>
<li>安装模板引擎之后，就要改写app.js</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// app.js文件</span><br><span class="line"></span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"></span><br><span class="line">// 加载hbs模块</span><br><span class="line">var hbs = require(&#x27;hbs&#x27;);</span><br><span class="line"></span><br><span class="line">// 指定模板文件的后缀名为html</span><br><span class="line">app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);</span><br><span class="line"></span><br><span class="line">// 运行hbs模块</span><br><span class="line">app.engine(&#x27;html&#x27;, hbs.__express);</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, function (req, res)&#123;</span><br><span class="line">	res.render(&#x27;index&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">	res.render(&#x27;about&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/article&#x27;, function(req, res) &#123;</span><br><span class="line">	res.render(&#x27;article&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码改用render方法，对网页模板进行渲染。render方法的参数就是模板的文件名，默认放在子目录views之中，后缀名已经在前面指定为html，这里可以省略。所以，res.render(‘index’) 就是指，把子目录views下面的index.html文件，交给模板引擎hbs渲染</p>
</blockquote>
<h2 id="十一、新建数据脚本"><a href="#十一、新建数据脚本" class="headerlink" title="十一、新建数据脚本"></a>十一、新建数据脚本</h2><blockquote>
<ul>
<li>渲染是指将数据代入模板的过程。实际运用中，数据都是保存在数据库之中的，这里为了简化问题，假定数据保存在一个脚本文件中</li>
<li>在项目目录中，新建一个文件blog.js，用于存放数据。blog.js的写法符合CommonJS规范，使得它可以被require语句加载</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// blog.js文件</span><br><span class="line"></span><br><span class="line">var entries = [</span><br><span class="line">	&#123;&quot;id&quot;:1, &quot;title&quot;:&quot;第一篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/2/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:2, &quot;title&quot;:&quot;第二篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/3/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:3, &quot;title&quot;:&quot;第三篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/4/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:4, &quot;title&quot;:&quot;第四篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/5/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:5, &quot;title&quot;:&quot;第五篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/10/2013&quot;&#125;,</span><br><span class="line">	&#123;&quot;id&quot;:6, &quot;title&quot;:&quot;第六篇&quot;, &quot;body&quot;:&quot;正文&quot;, &quot;published&quot;:&quot;6/12/2013&quot;&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">exports.getBlogEntries = function ()&#123;</span><br><span class="line">   return entries;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">exports.getBlogEntry = function (id)&#123;</span><br><span class="line">   for(var i=0; i &lt; entries.length; i++)&#123;</span><br><span class="line">      if(entries[i].id == id) return entries[i];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="十二、新建网页模板"><a href="#十二、新建网页模板" class="headerlink" title="十二、新建网页模板"></a>十二、新建网页模板</h2><blockquote>
<p>接着，新建模板文件<code>index.html</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- views/index.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;文章列表&lt;/h1&gt;</span><br><span class="line"> </span><br><span class="line">&#123;&#123;#each entries&#125;&#125;</span><br><span class="line">   &lt;p&gt;</span><br><span class="line">      &lt;a href=&quot;/article/&#123;&#123;id&#125;&#125;&quot;&gt;&#123;&#123;title&#125;&#125;&lt;/a&gt;&lt;br/&gt;</span><br><span class="line">      Published: &#123;&#123;published&#125;&#125;</span><br><span class="line">   &lt;/p&gt;</span><br><span class="line">&#123;&#123;/each&#125;&#125;</span><br><span class="line">&lt;!-- views/about.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;自我介绍&lt;/h1&gt;</span><br><span class="line"> </span><br><span class="line">&lt;p&gt;正文&lt;/p&gt;</span><br><span class="line">&lt;!-- views/article.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;&#123;&#123;blog.title&#125;&#125;&lt;/h1&gt;</span><br><span class="line">Published: &#123;&#123;blog.published&#125;&#125;</span><br><span class="line"> </span><br><span class="line">&lt;p/&gt;</span><br><span class="line"> </span><br><span class="line">&#123;&#123;blog.body&#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到，上面三个模板文件都只有网页主体。因为网页布局是共享的，所以布局的部分可以单独新建一个文件<code>layout.html</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- views/layout.html文件 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"> </span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;&#123;&#123;title&#125;&#125;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"> </span><br><span class="line">&lt;body&gt;</span><br><span class="line"> </span><br><span class="line">	&#123;&#123;&#123;body&#125;&#125;&#125;</span><br><span class="line"> </span><br><span class="line">   &lt;footer&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">         &lt;a href=&quot;/&quot;&gt;首页&lt;/a&gt; - &lt;a href=&quot;/about&quot;&gt;自我介绍&lt;/a&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">   &lt;/footer&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="十三、渲染模板"><a href="#十三、渲染模板" class="headerlink" title="十三、渲染模板"></a>十三、渲染模板</h2><blockquote>
<p>最后，改写app.js文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// app.js文件</span><br><span class="line"></span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var app = express();</span><br><span class="line"> </span><br><span class="line">var hbs = require(&#x27;hbs&#x27;);</span><br><span class="line"></span><br><span class="line">// 加载数据模块</span><br><span class="line">var blogEngine = require(&#x27;./blog&#x27;);</span><br><span class="line"> </span><br><span class="line">app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);</span><br><span class="line">app.engine(&#x27;html&#x27;, hbs.__express);</span><br><span class="line">app.use(express.bodyParser());</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">   res.render(&#x27;index&#x27;,&#123;title:&quot;最近文章&quot;, entries:blogEngine.getBlogEntries()&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">   res.render(&#x27;about&#x27;, &#123;title:&quot;自我介绍&quot;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.get(&#x27;/article/:id&#x27;, function(req, res) &#123;</span><br><span class="line">   var entry = blogEngine.getBlogEntry(req.params.id);</span><br><span class="line">   res.render(&#x27;article&#x27;,&#123;title:entry.title, blog:entry&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码中的render方法，现在加入了第二个参数，表示模板变量绑定的数据</li>
</ul>
<h2 id="十四、指定静态文件目录"><a href="#十四、指定静态文件目录" class="headerlink" title="十四、指定静态文件目录"></a>十四、指定静态文件目录</h2><blockquote>
<p>模板文件默认存放在views子目录。这时，如果要在网页中加载静态文件（比如样式表、图片等），就需要另外指定一个存放静态文件的目录</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(&#x27;public&#x27;));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码在文件app.js之中，指定静态文件存放的目录是public。于是，当浏览器发出非HTML文件请求时，服务器端就到public目录寻找这个文件。比如，浏览器发出如下的样式表请求：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href=&quot;/bootstrap/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>服务器端就到<code>public/bootstrap/css/</code>目录中寻找<code>bootstrap.css</code>文件</li>
</ul>
<h2 id="十五、Express-Router用法"><a href="#十五、Express-Router用法" class="headerlink" title="十五、Express.Router用法"></a>十五、Express.Router用法</h2><blockquote>
<p>从<code>Express 4.0</code>开始，路由器功能成了一个单独的组件<code>Express.Router</code>。它好像小型的<code>express</code>应用程序一样，有自己的<code>use</code>、<code>get</code>、<code>param</code>和<code>route</code>方法</p>
</blockquote>
<p><strong>基本用法</strong></p>
<blockquote>
<p>首先，Express.Router是一个构造函数，调用后返回一个路由器实例。然后，使用该实例的HTTP动词方法，为不同的访问路径，指定回调函数；最后，挂载到某个路径。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">  res.send(&#x27;首页&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/about&#x27;, function(req, res) &#123;</span><br><span class="line">  res.send(&#x27;关于&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&#x27;/&#x27;, router);</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>上面代码先定义了两个访问路径，然后将它们挂载到根目录</li>
<li>这种路由器可以自由挂载的做法，为程序带来了更大的灵活性，既可以定义多个路由器实例，也可以为将同一个路由器实例挂载到多个路径。</li>
</ul>
</blockquote>
<h2 id="十六、router-route方法"><a href="#十六、router-route方法" class="headerlink" title="十六、router.route方法"></a>十六、router.route方法</h2><blockquote>
<p>router实例对象的route方法，可以接受访问路径作为参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var router = express.Router();</span><br><span class="line"></span><br><span class="line">router.route(&#x27;/api&#x27;)</span><br><span class="line">	.post(function(req, res) &#123;</span><br><span class="line">		// ...</span><br><span class="line">	&#125;)</span><br><span class="line">	.get(function(req, res) &#123;</span><br><span class="line">		Bear.find(function(err, bears) &#123;</span><br><span class="line">			if (err) res.send(err);</span><br><span class="line">			res.json(bears);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">app.use(&#x27;/&#x27;, router);</span><br></pre></td></tr></table></figure>

<h2 id="十七、router中间件"><a href="#十七、router中间件" class="headerlink" title="十七、router中间件"></a>十七、router中间件</h2><blockquote>
<p>use方法为router对象指定中间件，即在数据正式发给用户之前，对数据进行处理。下面就是一个中间件的例子</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.use(function(req, res, next) &#123;</span><br><span class="line">	console.log(req.method, req.url);</span><br><span class="line">	next();	</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码中，回调函数的next参数，表示接受其他中间件的调用。函数体中的next()，表示将数据传递给下一个中间件</li>
<li>注意，中间件的放置顺序很重要，等同于执行顺序。而且，中间件必须放在HTTP动词方法之前，否则不会执行</li>
</ul>
<h2 id="十八、对路径参数的处理"><a href="#十八、对路径参数的处理" class="headerlink" title="十八、对路径参数的处理"></a>十八、对路径参数的处理</h2><blockquote>
<p>router对象的param方法用于路径参数的处理，可以</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">router.param(&#x27;name&#x27;, function(req, res, next, name) &#123;</span><br><span class="line">	// 对name进行验证或其他处理……</span><br><span class="line">	console.log(name);</span><br><span class="line">	req.name = name;</span><br><span class="line">	next();	</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/hello/:name&#x27;, function(req, res) &#123;</span><br><span class="line">	res.send(&#x27;hello &#x27; + req.name + &#x27;!&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码中，get方法为访问路径指定了name参数，param方法则是对name参数进行处理。注意，param方法必须放在HTTP动词方法之前</p>
</blockquote>
<h2 id="十九、app-route"><a href="#十九、app-route" class="headerlink" title="十九、app.route"></a>十九、app.route</h2><blockquote>
<ul>
<li>假定app是Express的实例对象，Express 4.0为该对象提供了一个route属性。app.route实际上是express.Router()的缩写形式，直接挂载到根路径</li>
<li>因此，对同一个路径指定get和post方法的回调函数，可以写成链式形式</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.route(&#x27;/login&#x27;)</span><br><span class="line">	.get(function(req, res) &#123;</span><br><span class="line">		res.send(&#x27;this is the login form&#x27;);</span><br><span class="line">	&#125;)</span><br><span class="line">	.post(function(req, res) &#123;</span><br><span class="line">		console.log(&#x27;processing&#x27;);</span><br><span class="line">		res.send(&#x27;processing the login form!&#x27;);</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="二十、上传文件"><a href="#二十、上传文件" class="headerlink" title="二十、上传文件"></a>二十、上传文件</h2><ul>
<li>首先，在网页插入上传文件的表单</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;/pictures/upload&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">  Select an image to upload:</span><br><span class="line">  &lt;input type=&quot;file&quot; name=&quot;image&quot;&gt;</span><br><span class="line">  &lt;input type=&quot;submit&quot; value=&quot;Upload Image&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>然后，服务器脚本建立指向&#x2F;upload目录的路由。这时可以安装multer模块，它提供了上传文件的许多功能</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var router = express.Router();</span><br><span class="line">var multer = require(&#x27;multer&#x27;);</span><br><span class="line"></span><br><span class="line">var uploading = multer(&#123;</span><br><span class="line">  dest: __dirname + &#x27;../public/uploads/&#x27;,</span><br><span class="line">  // 设定限制，每次最多上传1个文件，文件大小不超过1MB</span><br><span class="line">  limits: &#123;fileSize: 1000000, files:1&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(&#x27;/upload&#x27;, uploading, function(req, res) &#123;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">module.exports = router</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/07/nodejs/express/" data-id="cl7icg6ui00omugun7dl6b8zd" data-title="node-express框架总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/liunx/">liunx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/%E7%A7%BB%E5%8A%A8%E7%AB%AF/">移动端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/%E9%97%AE%E9%A2%98/">问题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/">前端工程化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">前端性能优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/%E6%A1%86%E6%9E%B6/">框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/%E7%AE%97%E6%B3%95/">算法</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/">数据可视化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/">架构模式</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F/%E6%A1%86%E6%9E%B6/">框架</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mock/" rel="tag">Mock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Promise/" rel="tag">Promise</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RESTful/" rel="tag">RESTful</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redux/" rel="tag">Redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/async-await/" rel="tag">async&#x2F;await</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/echart/" rel="tag">echart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/" rel="tag">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eslint/" rel="tag">eslint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glup/" rel="tag">glup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/" rel="tag">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typescript/" rel="tag">typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vs-code/" rel="tag">vs code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue3/" rel="tag">vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xml/" rel="tag">xml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" rel="tag">移动端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Mock/" style="font-size: 10px;">Mock</a> <a href="/tags/Promise/" style="font-size: 10px;">Promise</a> <a href="/tags/RESTful/" style="font-size: 10px;">RESTful</a> <a href="/tags/React/" style="font-size: 19.17px;">React</a> <a href="/tags/Redux/" style="font-size: 11.67px;">Redux</a> <a href="/tags/async-await/" style="font-size: 10px;">async/await</a> <a href="/tags/css/" style="font-size: 11.67px;">css</a> <a href="/tags/echart/" style="font-size: 10px;">echart</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/eslint/" style="font-size: 10px;">eslint</a> <a href="/tags/git/" style="font-size: 16.67px;">git</a> <a href="/tags/glup/" style="font-size: 10.83px;">glup</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/html/" style="font-size: 15px;">html</a> <a href="/tags/http/" style="font-size: 17.5px;">http</a> <a href="/tags/javascript/" style="font-size: 18.33px;">javascript</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10.83px;">nginx</a> <a href="/tags/nodejs/" style="font-size: 13.33px;">nodejs</a> <a href="/tags/python/" style="font-size: 10.83px;">python</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/typescript/" style="font-size: 12.5px;">typescript</a> <a href="/tags/vs-code/" style="font-size: 11.67px;">vs code</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/vue3/" style="font-size: 10px;">vue3</a> <a href="/tags/webpack/" style="font-size: 19.17px;">webpack</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 14.17px;">优化</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10.83px;">前端</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15.83px;">小程序</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" style="font-size: 10.83px;">移动端</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.83px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/25/Js%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">变量类型</a>
          </li>
        
          <li>
            <a href="/2022/04/25/http/DNS%E5%8D%8F%E8%AE%AE/">DNS协议</a>
          </li>
        
          <li>
            <a href="/2022/01/18/React/React-%E6%8F%90%E9%AB%98%E7%BB%84%E4%BB%B6%E6%95%88%E7%8E%87%20%20%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84render/">React-提高组件效率  避免不必要的render</a>
          </li>
        
          <li>
            <a href="/2022/01/12/%E5%B7%A5%E5%85%B7/git-stach/">git-stach</a>
          </li>
        
          <li>
            <a href="/2021/10/16/Vue/vue3%E4%BC%98%E5%8C%96/">vue3优化</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>